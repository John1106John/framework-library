# ============================================================================
# Prompt Management System Specification
# ç”¨æ–¼ AI Workflow çš„ Prompt ç‰ˆæœ¬ç®¡ç†ç³»çµ±è¨­è¨ˆè¦æ ¼
# ============================================================================
# ğŸ“– ä½¿ç”¨æ–¹å¼ï¼š
#   å°‡æ­¤ YAML çš„å…§å®¹ä½œç‚º prompt æä¾›çµ¦ AIï¼ˆClaudeã€GPTã€Gemini ç­‰ï¼‰ï¼Œ
#   AI å³å¯æ ¹æ“šæ­¤è¦æ ¼ç‚ºä½ çš„å°ˆæ¡ˆå»ºæ§‹ä¸€å¥—å®Œæ•´çš„ Prompt ç®¡ç†ç³»çµ±ã€‚
#
# ğŸ¯ é©ç”¨å ´æ™¯ï¼š
#   - å¤šéšæ®µ AI Workflowï¼ˆå¦‚å ±å‘Šç”Ÿæˆã€å…§å®¹åˆ†æã€æ•¸æ“šè™•ç†ï¼‰
#   - éœ€è¦é »ç¹èª¿æ•´ Prompt çš„å°ˆæ¡ˆ
#   - éœ€è¦ç‰ˆæœ¬ç®¡ç†å’Œ A/B æ¸¬è©¦çš„å ´æ™¯
#
# ğŸ“¦ åƒè€ƒå¯¦ä½œï¼š
#   æœ¬è¦æ ¼åŸºæ–¼ã€Œå°ç¾ ETF æ·¨æµé‡åˆ†ææœˆå ±ã€å°ˆæ¡ˆçš„å¯¦éš›ç¶“é©—ç·¨å¯«ï¼Œ
#   å·²åœ¨ç”Ÿç”¢ç’°å¢ƒé©—è­‰å¯è¡Œæ€§ã€‚
#
# ğŸ”– ç‰ˆæœ¬ï¼šv1.5.0 (2026-02-19)
# ============================================================================

metadata:
  name: "Prompt Management System"
  version: "1.5.0"
  description: "AI Workflow çš„ Prompt ç‰ˆæœ¬ç®¡ç†ç³»çµ± - æå–ã€ç·¨è¼¯ã€ç‰ˆæœ¬æ§åˆ¶ã€Baseline ç®¡ç†ã€é è¦½åŸ·è¡Œä¸€è‡´æ€§ã€è¼¸å…¥é©—è­‰ã€Stage é–“çµ±ä¸€è®€å–"
  author: "John1106John"
  created_at: "2026-02-09"
  updated_at: "2026-02-19"
  license: "MIT"
  compatibility:
    - "å¤šéšæ®µ AI Workflow"
    - "Streamlit UI"
    - "ä»»ä½• Python 3.10+ å°ˆæ¡ˆ"

system_overview:
  name: "AI Workflow Prompt Management System"
  purpose: |
    åœ¨å¤šéšæ®µ AI workflow ä¸­ï¼Œæ¯å€‹éšæ®µ (stage) éƒ½æœƒå‘¼å« LLM API ä¸¦ä½¿ç”¨ promptã€‚
    æœ¬ç³»çµ±æä¾›ï¼š
    1. å¾ Python è…³æœ¬ä¸­è‡ªå‹•æå– prompt å¸¸æ•¸
    2. åœ¨ Streamlit UI ä¸­å³æ™‚ç·¨è¼¯ prompt
    3. è‰ç¨¿æš«å­˜ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰èˆ‡æ­£å¼å¯«å›è…³æœ¬ï¼ˆå½±éŸ¿åŸ·è¡Œï¼‰
    4. æ¯æ¬¡ä¿®æ”¹è…³æœ¬å‰è‡ªå‹•å‚™ä»½
    5. è¼¸å‡ºç‰ˆæœ¬ç®¡ç†ï¼ˆæ¯æ¬¡åŸ·è¡Œå¾Œå¿«ç…§ï¼Œå¯åˆ‡æ›ä¸»è¦ç‰ˆæœ¬ï¼‰
  tech_stack:
    language: Python 3.10+
    ui_framework: Streamlit
    storage: ç´”æª”æ¡ˆç³»çµ±ï¼ˆJSON + Markdownï¼‰ï¼Œç„¡éœ€è³‡æ–™åº«
    dependencies:
      - streamlit   # UI æ¡†æ¶
      - pathlib     # è·¯å¾‘æ“ä½œï¼ˆæ¨™æº–åº«ï¼‰
      - json        # JSON åºåˆ—åŒ–ï¼ˆæ¨™æº–åº«ï¼‰
      - shutil      # æª”æ¡ˆè¤‡è£½/å‚™ä»½ï¼ˆæ¨™æº–åº«ï¼‰
      - re          # æ­£å‰‡è¡¨é”å¼æå– promptï¼ˆæ¨™æº–åº«ï¼‰
      - datetime    # æ™‚é–“æˆ³è¨˜ï¼ˆæ¨™æº–åº«ï¼‰

# ============================================================================
# æ ¸å¿ƒæ¶æ§‹
# ============================================================================

architecture:
  design_principle: |
    ã€ŒPrompt å³ç¨‹å¼ç¢¼ã€â€” prompt ç›´æ¥å¯«åœ¨ .py è…³æœ¬ä¸­ä½œç‚º module-level å¸¸æ•¸ï¼Œ
    æ˜¯ single source of truthã€‚

    â­ æ ¸å¿ƒåŸå‰‡ï¼šè…³æœ¬å³å”¯ä¸€ä¾†æº
    - get_prompts() æ°¸é å¾ .py è…³æœ¬æå–ï¼ˆregexï¼‰ï¼Œä¸å„ªå…ˆè®€å– JSON å¿«å–
    - é¿å… JSON å¿«å–èˆ‡è…³æœ¬ä¸åŒæ­¥çš„ bug
    - JSON å¿«å–åƒ…ç”¨æ–¼è‰ç¨¿æš«å­˜ï¼Œä¸ä½œç‚ºè®€å–ä¾†æº

    è³‡æ–™æµï¼š
    .py è…³æœ¬ (PROMPT = """...""")
        â†“ extract (regex) â† get_prompts() æ°¸é èµ°é€™æ¢è·¯
    UI session_state (å³æ™‚ç·¨è¼¯)
        â†“ save_draft â†’ JSON è‰ç¨¿ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰
        â†“ update_script â†’ å¯«å› .pyï¼ˆå½±éŸ¿åŸ·è¡Œï¼‰

    â­ é è¦½èˆ‡åŸ·è¡Œå…±ç”¨é‚è¼¯ï¼ˆbuild_prompts æ¨¡å¼ï¼‰ï¼š
    .py è…³æœ¬ä¸­çš„ build_prompts(year, month, prompt_texts=None)
        â†‘ è…³æœ¬ main() å‘¼å«ï¼ˆprompt_texts=Noneï¼Œç”¨ module-level å¸¸æ•¸ï¼‰
        â†‘ UI é è¦½å‘¼å«ï¼ˆprompt_texts=edited_dictï¼Œç”¨ UI ç·¨è¼¯ä¸­çš„æ–‡å­—ï¼‰
    â†’ ç¢ºä¿é è¦½èˆ‡åŸ·è¡Œ 100% ä½¿ç”¨ç›¸åŒçš„çµ„è£é‚è¼¯

    â­ Stage é–“ä¾è³´çµ±ä¸€è®€å–ï¼ˆstage_io æ¨¡å¼ï¼‰ï¼š
    utils/stage_io.py ä¸­çš„ read_stage_output(stage_num, year, month)
        â†‘ build_prompts() å…§éƒ¨å‘¼å«ï¼ˆè®€å–å‰ç½® stage è¼¸å‡ºï¼‰
        â†‘ ä¸è«–å¾ UI é è¦½ã€UI åŸ·è¡Œã€CLIã€ä¸€éµ workflow è§¸ç™¼
    â†’ çµ±ä¸€è§£ææ´»å‹•ç‰ˆæœ¬ vs temp/ æª”æ¡ˆï¼Œå–è¼ƒæ–°è€…
    â†’ ç¢ºä¿æ‰€æœ‰è§¸ç™¼è·¯å¾‘è®€åˆ°ç›¸åŒè³‡æ–™

  components:
    - name: PromptManager
      role: å¾Œç«¯æ ¸å¿ƒé¡åˆ¥
      responsibilities:
        - å¾ .py è…³æœ¬æå– promptï¼ˆregexï¼‰â€” å”¯ä¸€è®€å–ä¾†æº
        - å°‡ä¿®æ”¹å¯«å› .py è…³æœ¬
        - è‡ªå‹•å‚™ä»½ï¼ˆä¿®æ”¹å‰ï¼‰
        - åˆ—å‡º/é‚„åŸå‚™ä»½
        - Baseline ç®¡ç†ï¼ˆå„²å­˜ã€æ¯”è¼ƒã€é‚„åŸåŸºæº–ç‰ˆæœ¬ï¼‰

    - name: Baseline Manager (PromptManager å…§å»º)
      role: Prompt åŸºæº–ç‰ˆæœ¬ç®¡ç†
      responsibilities:
        - å°‡ç›®å‰è…³æœ¬ prompt å„²å­˜ç‚º baselineï¼ˆåƒè€ƒåŸºæº–ï¼‰
        - æ¯”è¼ƒç›®å‰è…³æœ¬èˆ‡ baseline çš„å·®ç•°
        - å¾ baseline é‚„åŸè…³æœ¬ï¼ˆè‡ªå‹•å‚™ä»½å¾Œè¦†è“‹ï¼‰
        - Baseline ä¸å¯åˆªé™¤ï¼Œåƒ…èƒ½è¦†è“‹æ›´æ–°

    - name: UI Prompt Editor (Streamlit)
      role: å‰ç«¯äº’å‹•ä»‹é¢
      responsibilities:
        - é¡¯ç¤ºå„ stage çš„ promptï¼ˆtext_area ç·¨è¼¯å™¨ï¼‰
        - é¡¯ç¤ºå­—æ•¸ã€è¡Œæ•¸ã€æ˜¯å¦å·²ä¿®æ”¹
        - æš«å­˜è‰ç¨¿ï¼ˆJSONï¼‰
        - è¼‰å…¥è‰ç¨¿ / åˆªé™¤è‰ç¨¿
        - æ›´æ–°åˆ°è…³æœ¬
        - å¾è…³æœ¬é‡æ–°è¼‰å…¥
        - Baseline æ¯”è¼ƒï¼ˆèˆ‡åŸºæº–ç‰ˆæœ¬æ¯”å°å·®ç•°ï¼‰
        - è‰ç¨¿è¨˜éŒ„ä¸­ç½®é ‚é¡¯ç¤º Baselineï¼ˆå¯è¼‰å…¥ï¼Œä¸å¯åˆªé™¤ï¼‰

    - name: Version Manager
      role: è¼¸å‡ºç‰ˆæœ¬æ§åˆ¶
      responsibilities:
        - æ¯æ¬¡æˆåŠŸåŸ·è¡Œå¾Œè‡ªå‹•å¿«ç…§è¼¸å‡º
        - ç®¡ç† active versionï¼ˆè¿½è¹¤å“ªå€‹ç‰ˆæœ¬æ˜¯ç•¶å‰ä½¿ç”¨çš„ï¼‰
        - åˆ‡æ›/åˆªé™¤ç‰ˆæœ¬
        - æœ€çµ‚çµ„è£æ™‚å¯é¸æ“‡å„ stage çš„ç‰¹å®šç‰ˆæœ¬

    - name: StageOutputReader
      role: Stage é–“ä¾è³´çš„çµ±ä¸€è®€å–æ¨¡çµ„
      responsibilities:
        - æä¾› read_stage_output(stage_num, year, month) å–®ä¸€è®€å–å‡½æ•¸
        - è§£ææ´»å‹•ç‰ˆæœ¬ï¼ˆUI é¸å®šçš„ â˜… ç‰ˆæœ¬ï¼‰èˆ‡ temp/ æª”æ¡ˆçš„å„ªå…ˆé †åº
        - æ¯”è¼ƒæ™‚é–“æˆ³ï¼Œå–è¼ƒæ–°çš„æª”æ¡ˆå…§å®¹
        - è¢«æ‰€æœ‰ build_prompts() å…§éƒ¨ä½¿ç”¨ï¼Œç¢ºä¿æ‰€æœ‰è§¸ç™¼è·¯å¾‘è®€åˆ°ç›¸åŒè³‡æ–™

# ============================================================================
# ç›®éŒ„çµæ§‹
# ============================================================================

directory_structure:
  description: |
    ä»¥ä¸‹ç‚º prompt ç®¡ç†ç›¸é—œçš„ç›®éŒ„çµæ§‹ã€‚
    {project_root} æ˜¯ä½ çš„å°ˆæ¡ˆæ ¹ç›®éŒ„ã€‚
  layout:
    prompts/: "JSON å¿«å–ï¼Œæ¯å€‹ stage ä¸€å€‹æª”æ¡ˆ"
    prompts/baselines/: "Baseline åŸºæº–ç‰ˆæœ¬ï¼ˆä¸å¯åˆªé™¤ï¼Œåƒ…èƒ½è¦†è“‹æ›´æ–°ï¼‰"
    prompts/backups/: "è‡ªå‹•å‚™ä»½ï¼ˆ.json å’Œ .pyï¼‰ï¼Œä¿®æ”¹å‰è‡ªå‹•å»ºç«‹"
    prompts/drafts/: "UI æš«å­˜è‰ç¨¿ï¼Œä¸å½±éŸ¿å¯¦éš›åŸ·è¡Œï¼Œå¯åˆªé™¤"
    temp/versions/{YYYYMM}/stage{N}/: "è¼¸å‡ºç‰ˆæœ¬å¿«ç…§"
    temp/active_versions_{YYYYMM}.json: "è¨˜éŒ„å„ stage çš„ä¸»è¦ç‰ˆæœ¬ ID"
  file_naming:
    json_cache: "stage{N}_prompts.json"
    baseline: "stage{N}_baseline.json"
    draft: "stage{N}_{YYYYMMDD_HHMMSS}.json"
    backup_json: "stage{N}_prompts_{YYYYMMDD_HHMMSS}.json"
    backup_script: "{script_stem}_{YYYYMMDD_HHMMSS}.py"
    version_snapshot:
      individual: "v{YYYYMMDD_HHMMSS}.md"
      workflow: "v{YYYYMMDD_HHMMSS}_workflow.md"

# ============================================================================
# å…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¶æ§‹ï¼ˆPreview Consistency Patternï¼‰
# ============================================================================

shared_formatters:
  design_principle: |
    â­ **æ ¸å¿ƒç†å¿µ**ï¼šé è¦½èˆ‡å¯¦éš›åŸ·è¡Œä½¿ç”¨ç›¸åŒçš„ç¨‹å¼ç¢¼ï¼Œç¢ºä¿ 100% ä¸€è‡´æ€§

    å•é¡ŒèƒŒæ™¯ï¼š
    - å¯¦éš›åŸ·è¡Œï¼šStage è…³æœ¬æœ‰è‡ªå·±çš„è³‡æ–™æ ¼å¼åŒ–é‚è¼¯
    - UI é è¦½ï¼šUI ä¸­é‡æ–°å¯¦ä½œç›¸åŒçš„é‚è¼¯ä¾†ç”Ÿæˆé è¦½
    - çµæœï¼šå…©ä»½ä»£ç¢¼ï¼Œå®¹æ˜“ä¸ä¸€è‡´ âŒ

    è§£æ±ºæ–¹æ¡ˆï¼š
    - å‰µå»ºå…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„ï¼ˆutils/data_formatter.pyï¼‰
    - Stage è…³æœ¬å’Œ UI é è¦½éƒ½ä½¿ç”¨ç›¸åŒçš„å‡½æ•¸
    - å–®ä¸€ä¾†æºåŸå‰‡ï¼ˆSingle Source of Truthï¼‰âœ…

  architecture:
    pattern: |
      å¯¦éš›åŸ·è¡Œ Stage è…³æœ¬ â”€â”€â”
                           â”œâ”€â”€> å…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„ (utils/data_formatter.py)
      UI é è¦½åŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  implementation:
    step_1_create_shared_module:
      file: "utils/data_formatter.py"
      description: |
        å‰µå»ºå…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„ï¼ŒåŒ…å«æ‰€æœ‰è³‡æ–™è®€å–å’Œæ ¼å¼åŒ–é‚è¼¯ã€‚
        æ¯å€‹å‡½æ•¸å°æ‡‰ä¸€ç¨®è³‡æ–™æ ¼å¼åŒ–éœ€æ±‚ã€‚

      design_principles:
        - "å‡½æ•¸å‘½åæ¸…æ™°ï¼ˆload_*, format_*, calculate_*ï¼‰"
        - "å®Œæ•´çš„ docstringï¼ˆåŒ…å« Args, Returns, Used byï¼‰"
        - "ä¸€è‡´çš„éŒ¯èª¤è™•ç†"
        - "å–®ä¸€è·è²¬åŸå‰‡"

      example: |
        ```python
        # utils/data_formatter.py

        def load_us_etf_data(excel_file, year, month):
            """
            å¾ Excel è®€å–æŒ‡å®šæœˆä»½çš„æ•¸æ“šï¼Œè½‰ç‚º markdown è¡¨æ ¼

            Args:
                excel_file: Path æˆ– strï¼ŒExcel æª”æ¡ˆè·¯å¾‘
                year: int, å¹´ä»½
                month: int, æœˆä»½

            Returns:
                str: æ ¼å¼åŒ–çš„ markdown è¡¨æ ¼ï¼Œæˆ–éŒ¯èª¤è¨Šæ¯

            Used by:
                - scripts/stages/stage1_xxx.py
                - ui_app.py (generate_dynamic_variables, Stage 1)
            """
            try:
                df = pd.read_excel(excel_file, sheet_name=f"{year}å¹´{month}æœˆæ•¸æ“š")
                # æ ¼å¼åŒ–é‚è¼¯...
                return formatted_table
            except Exception as e:
                return f"\n[è­¦å‘Š] ç„¡æ³•è®€å–æ•¸æ“š: {str(e)}\n"
        ```

    step_2_refactor_stage_scripts:
      description: |
        é‡æ§‹ Stage è…³æœ¬ï¼Œç§»é™¤æœ¬åœ°çš„æ ¼å¼åŒ–é‚è¼¯ï¼Œæ”¹ç”¨å…±ç”¨å‡½æ•¸ã€‚

      before: |
        ```python
        # scripts/stages/stage1_xxx.py

        def load_data(file, year, month):  # âŒ é‡è¤‡çš„é‚è¼¯
            df = pd.read_excel(file)
            # ... å¤§é‡æ ¼å¼åŒ–é‚è¼¯ ...
            return table

        def main(year, month):
            data = load_data(file, year, month)
        ```

      after: |
        ```python
        # scripts/stages/stage1_xxx.py

        from utils.data_formatter import load_us_etf_data  # âœ… ä½¿ç”¨å…±ç”¨å‡½æ•¸

        def main(year, month):
            # ç›´æ¥ä½¿ç”¨å…±ç”¨å‡½æ•¸
            data = load_us_etf_data(file, year, month)
        ```

    step_3_ui_preview_integration:
      description: |
        UI é è¦½é‚è¼¯ä½¿ç”¨ç›¸åŒçš„å…±ç”¨å‡½æ•¸ï¼Œç¢ºä¿èˆ‡å¯¦éš›åŸ·è¡Œä¸€è‡´ã€‚

      before: |
        ```python
        # ui_app.py

        def generate_dynamic_variables(stage_num, year, month):
            if stage_num == 1:
                # âŒ è‡ªè¡Œå¯¦ä½œï¼Œå¯èƒ½èˆ‡å¯¦éš›åŸ·è¡Œä¸åŒ
                df = pd.read_excel(file)
                table = df.to_markdown()  # æ ¼å¼å¯èƒ½ä¸åŒ
        ```

      after: |
        ```python
        # ui_app.py

        from utils.data_formatter import load_us_etf_data  # âœ… ä½¿ç”¨ç›¸åŒçš„å…±ç”¨å‡½æ•¸

        def generate_dynamic_variables(stage_num, year, month):
            if stage_num == 1:
                # âœ… ä½¿ç”¨å…±ç”¨å‡½æ•¸ï¼Œç¢ºä¿èˆ‡å¯¦éš›åŸ·è¡Œç›¸åŒ
                data = load_us_etf_data(file, year, month)
                dynamic_vars["{{data}}"] = data
        ```

  benefits:
    - "âœ… ä¿è­‰ä¸€è‡´æ€§ï¼šé è¦½èˆ‡å¯¦éš›åŸ·è¡Œä½¿ç”¨å®Œå…¨ç›¸åŒçš„ä»£ç¢¼"
    - "âœ… é¿å…é‡è¤‡ï¼šå–®ä¸€ä¾†æºåŸå‰‡ï¼ˆSingle Source of Truthï¼‰"
    - "âœ… æ˜“æ–¼ç¶­è­·ï¼šä¿®æ”¹é‚è¼¯åªéœ€è¦æ”¹ä¸€è™•"
    - "âœ… é™ä½éŒ¯èª¤ï¼šæ¸›å°‘å› è¤‡è£½è²¼ä¸Šå°è‡´çš„ä¸ä¸€è‡´"
    - "âœ… æ˜“æ–¼æ¸¬è©¦ï¼šåªéœ€æ¸¬è©¦å…±ç”¨å‡½æ•¸ä¸€æ¬¡"

  best_practices:
    function_naming:
      - "ä½¿ç”¨æ¸…æ™°çš„å‹•è© + åè©ï¼šload_*, format_*, calculate_*"
      - "åç¨±åæ˜ åŠŸèƒ½ï¼šload_us_etf_data è€Œé get_data"

    docstring_requirements: |
      å¿…é ˆåŒ…å«ï¼š
      - ç°¡çŸ­æè¿°
      - Args: æ‰€æœ‰åƒæ•¸åŠèªªæ˜
      - Returns: è¿”å›å€¼èªªæ˜
      - Used by: ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆå¹«åŠ©è¿½è¹¤å½±éŸ¿ç¯„åœï¼‰

    error_handling:
      pattern: |
        try:
            # ä¸»é‚è¼¯
            return formatted_data
        except Exception as e:
            # çµ±ä¸€çš„éŒ¯èª¤è¨Šæ¯æ ¼å¼
            return f"\n[è­¦å‘Š] ç„¡æ³•è®€å– {source}: {str(e)}\n"

    testing:
      - "ç‚ºå…±ç”¨å‡½æ•¸æ’°å¯«å–®å…ƒæ¸¬è©¦"
      - "æ¸¬è©¦é è¦½èˆ‡å¯¦éš›åŸ·è¡Œçš„è¼¸å‡ºä¸€è‡´æ€§"
      - "ä½¿ç”¨ pytest æˆ– unittest æ¡†æ¶"

    version_control:
      - "ä¿®æ”¹å…±ç”¨å‡½æ•¸æ™‚ç¢ºä¿å‘ä¸‹å…¼å®¹"
      - "æˆ–åŒæ™‚æ›´æ–°æ‰€æœ‰ä½¿ç”¨è€…"
      - "è¨˜éŒ„ä¿®æ”¹åŸå› ï¼ˆcommit messageï¼‰"

  common_pitfalls:
    - name: "éƒ¨åˆ†ä½¿ç”¨å…±ç”¨å‡½æ•¸"
      problem: "æŸäº› Stage ä½¿ç”¨å…±ç”¨å‡½æ•¸ï¼ŒæŸäº›è‡ªå·±å¯¦ä½œ"
      solution: "æ‰€æœ‰æ ¼å¼åŒ–é‚è¼¯éƒ½ä½¿ç”¨å…±ç”¨å‡½æ•¸"

    - name: "ä¿®æ”¹å…±ç”¨å‡½æ•¸å¾Œæœªæ›´æ–°æ‰€æœ‰ä½¿ç”¨è€…"
      problem: "ä¿®æ”¹å‡½æ•¸å¾Œå¿˜è¨˜æ¸¬è©¦æ‰€æœ‰ Stage"
      solution: "å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦ï¼Œä¿®æ”¹å¾Œè‡ªå‹•é©—è­‰æ‰€æœ‰ä½¿ç”¨è€…"

    - name: "åœ¨å…±ç”¨å‡½æ•¸ä¸­æ··å…¥ç‰¹å®š Stage é‚è¼¯"
      problem: "å‡½æ•¸ä¸­ä½¿ç”¨ if stage_num == 1 ç­‰æ¢ä»¶åˆ†æ”¯"
      solution: "æ¯å€‹å‡½æ•¸å°ˆæ³¨å–®ä¸€è·è²¬ï¼ŒStage ç‰¹å®šé‚è¼¯åœ¨ Stage è…³æœ¬ä¸­è™•ç†"

  verification:
    method_1_direct_comparison:
      description: "ç›´æ¥æ¯”å° Stage åŸ·è¡Œè¼¸å‡ºèˆ‡ UI é è¦½å…§å®¹"
      steps:
        - "åŸ·è¡Œ Stage è…³æœ¬ï¼Œç”Ÿæˆè¼¸å‡ºæª”æ¡ˆ"
        - "åœ¨ UI ä¸­æŸ¥çœ‹é è¦½å…§å®¹"
        - "äººå·¥æ¯”å°å…©è€…æ˜¯å¦ä¸€è‡´"

    method_2_unit_testing:
      description: "ä½¿ç”¨å–®å…ƒæ¸¬è©¦é©—è­‰ä¸€è‡´æ€§"
      example: |
        ```python
        def test_preview_matches_actual():
            # ä½¿ç”¨ç›¸åŒåƒæ•¸å‘¼å«å…±ç”¨å‡½æ•¸
            actual = load_us_etf_data(test_file, 2025, 12)

            # æ¨¡æ“¬ UI é è¦½é‚è¼¯
            preview = generate_dynamic_variables(1, 2025, 12, "202512")

            # é©—è­‰ä¸€è‡´æ€§
            assert preview["{{data}}"] in actual
        ```

    method_3_check_imports:
      description: "æª¢æŸ¥æ˜¯å¦æ‰€æœ‰åœ°æ–¹éƒ½ä½¿ç”¨å…±ç”¨å‡½æ•¸"
      commands:
        - "grep -r 'def load_.*_data' scripts/stages/  # æ‡‰è©²åªåœ¨ utils/data_formatter.py ä¸­æ‰¾åˆ°"
        - "grep -r 'from utils.data_formatter import' scripts/stages/"
        - "grep 'from utils.data_formatter import' ui_app.py"

# ============================================================================
# PromptManager é¡åˆ¥è¨­è¨ˆ
# ============================================================================

prompt_manager_class:
  description: |
    æ ¸å¿ƒå¾Œç«¯é¡åˆ¥ï¼Œè² è²¬ prompt çš„è®€å–ã€æå–ã€å„²å­˜ã€å¯«å›ã€‚
    ä¸ä¾è³´ Streamlitï¼Œå¯ç¨ç«‹ä½¿ç”¨ã€‚

  constructor:
    parameters: []
    initialization:
      - "æ¨å° project_rootï¼ˆé€šå¸¸ Path(__file__).parent.parentï¼‰"
      - "å»ºç«‹ prompts_dirã€backup_dir å’Œ baseline_dir"
      - "å®šç¾© prompt_files æ˜ å°„è¡¨ï¼šstage åç¨± â†’ {json è·¯å¾‘, è…³æœ¬è·¯å¾‘}"
    example: |
      self.project_root = Path(__file__).parent.parent
      self.prompts_dir = self.project_root / "prompts"
      self.backup_dir = self.prompts_dir / "backups"
      self.baseline_dir = self.prompts_dir / "baselines"
      self.prompts_dir.mkdir(exist_ok=True)
      self.backup_dir.mkdir(exist_ok=True)
      self.baseline_dir.mkdir(exist_ok=True)

  prompt_files_mapping:
    description: |
      å­—å…¸ï¼Œkey ç‚º stage çš„äººé¡å¯è®€åç¨±ï¼Œvalue åŒ…å«ï¼š
      - file: JSON å¿«å–è·¯å¾‘
      - script: å°æ‡‰çš„ Python è…³æœ¬è·¯å¾‘
    example: |
      self.prompt_files = {
          "Stage 1ï¼šXXX": {
              "file": self.prompts_dir / "stage1_prompts.json",
              "script": self.project_root / "scripts" / "stages" / "stage1_xxx.py"
          },
          # ...ä¾æ­¤é¡æ¨
      }

  methods:
    extract_prompts_from_script:
      purpose: "å¾ Python è…³æœ¬ä¸­ç”¨ regex æå– prompt å¸¸æ•¸"
      input: "script_path (Path)"
      output: "dict[str, str]  # {è®Šæ•¸å: prompt å…§å®¹}"
      regex_patterns:
        pattern_module_level_vars: |
          # åŒ¹é… PROMPT = """...""" æˆ– PROMPT_XXX = """..."""
          r'(PROMPT(?:_\w+)?)\s*=\s*"""(.*?)"""'
          # ä½¿ç”¨ re.DOTALL ä½¿ . åŒ¹é…æ›è¡Œ
        pattern_dict_format: |
          # åŒ¹é… PROMPTS = {"key": """...""", ...}
          # å…ˆæ‰¾å¤–å±¤ dictï¼Œå†æå–å„ key-value
          å¤–å±¤: r'PROMPTS\s*=\s*\{(.*?)\n\}'
          å…§å±¤: r'"(\w+)":\s*"""(.*?)"""'
      important_notes:
        - "regex å¿…é ˆç”¨ re.DOTALL flagï¼Œå› ç‚º prompt è·¨å¤šè¡Œ"
        - "PROMPT(?:_\\w+)? åŒæ™‚åŒ¹é… PROMPT å’Œ PROMPT_XXX"
        - "ç„¡æ³•æå–å‹•æ…‹ f-string promptï¼ˆå¦‚å«æœ‰å‰ç½® stage è¼¸å‡ºçš„ promptï¼‰"
        - "å°å‹•æ…‹ prompt çš„ stageï¼Œæ‡‰åœ¨ UI è¨­ prompt_key=None ä¸¦é¡¯ç¤ºèªªæ˜"

    get_prompts:
      purpose: "å–å¾—æŒ‡å®š stage çš„æ‰€æœ‰ prompt"
      logic: |
        â­ æ°¸é å¾è…³æœ¬æå–ï¼ˆä¸ä½¿ç”¨ JSON å¿«å–ï¼‰ï¼Œç¢ºä¿èˆ‡åŸ·è¡Œä¸€è‡´ï¼š
        1. ç¢ºèª report_type å­˜åœ¨æ–¼ prompt_files æ˜ å°„è¡¨
        2. å–å¾—å°æ‡‰çš„ script è·¯å¾‘
        3. å‘¼å« extract_prompts_from_script(script_path) æå–
        4. ç›´æ¥å›å‚³çµæœï¼ˆä¸å¯«å…¥ JSON å¿«å–ï¼‰
      input: "report_type (str) â€” prompt_files çš„ key"
      output: "dict[str, str]"
      important_notes:
        - "âš ï¸ èˆŠç‰ˆè¨­è¨ˆæœƒå„ªå…ˆå¾ JSON å¿«å–è®€å–ï¼Œå°è‡´æ›´æ–°è…³æœ¬å¾Œ UI ä»é¡¯ç¤ºèˆŠç‰ˆ prompt"
        - "æ–°ç‰ˆæ°¸é å¾ .py è…³æœ¬æå–ï¼Œå¾¹åº•æ¶ˆé™¤å¿«å–ä¸åŒæ­¥å•é¡Œ"
        - "æ•ˆèƒ½å½±éŸ¿æ¥µå°ï¼ˆregex æå–åªéœ€å¹¾æ¯«ç§’ï¼‰"
      example: |
        def get_prompts(self, report_type):
            """ç²å–æŒ‡å®šå ±å‘Šé¡å‹çš„ Promptsï¼ˆç›´æ¥å¾è…³æœ¬æå–ï¼Œç¢ºä¿èˆ‡åŸ·è¡Œä¸€è‡´ï¼‰"""
            if report_type not in self.prompt_files:
                return {}
            script_file = self.prompt_files[report_type]["script"]
            return self.extract_prompts_from_script(script_file)

    save_prompts:
      purpose: "å„²å­˜ prompt åˆ° JSON å¿«å–æª”"
      logic: |
        1. å¦‚æœå¿«å–æª”å·²å­˜åœ¨ä¸” create_backup=True â†’ è¤‡è£½ç‚ºå‚™ä»½
        2. å¯«å…¥æ–°çš„ JSON
      input: "report_type, prompts (dict), create_backup=True"

    update_script_prompts:
      purpose: "å°‡ä¿®æ”¹å¾Œçš„ prompt å¯«å› .py è…³æœ¬ï¼ˆå½±éŸ¿å¯¦éš›åŸ·è¡Œï¼‰"
      logic: |
        1. è®€å–è…³æœ¬å…§å®¹
        2. å»ºç«‹è…³æœ¬å‚™ä»½ï¼ˆ.py å‚™ä»½åˆ° backups/ï¼‰
        3. åµæ¸¬è…³æœ¬æ ¼å¼ï¼š
           a. module-level è®Šæ•¸ (PROMPT = """...""")
           b. å­—å…¸æ ¼å¼ (PROMPTS = {"key": """..."""})
        4. ç”¨ regex æ›¿æ›å°æ‡‰çš„ prompt å…§å®¹
        5. å¯«å›è…³æœ¬
        â­ ä¸éœ€è¦åŒæ­¥ JSON å¿«å– â€” å› ç‚º get_prompts() æ°¸é å¾è…³æœ¬æå–
      important_notes:
        - "åµæ¸¬ regex å’Œæå– regex å¿…é ˆä¸€è‡´ï¼ˆéƒ½è¦æ”¯æ´ PROMPT å’Œ PROMPT_XXXï¼‰"
        - "æ›¿æ›å‰ä¸€å®šè¦å‚™ä»½ï¼Œå› ç‚ºé€™æ˜¯ä¸å¯é€†æ“ä½œ"
        - "æ›¿æ›æ ¼å¼ï¼š{var_name} = \"\"\"\\n{new_content}\\n\"\"\""
        - "âš ï¸ ä¸è¦åœ¨æ­¤æ–¹æ³•ä¸­åŠ  save_prompts() åŒæ­¥ JSON â€” å¤šé¤˜ä¸”å¯èƒ½é€ æˆæ··æ·†"

    list_backups:
      purpose: "åˆ—å‡ºæŒ‡å®š stage çš„æ‰€æœ‰å‚™ä»½"
      output: "list[{file, time}]ï¼ŒæŒ‰æ™‚é–“å€’åº"

    restore_from_backup:
      purpose: "å¾å‚™ä»½é‚„åŸ JSON å¿«å–"

    # ===== Baseline ç®¡ç†æ–¹æ³• =====

    _stage_num:
      purpose: "å¾ report_type åç¨±æå– Stage ç·¨è™Ÿï¼ˆå…§éƒ¨è¼”åŠ©æ–¹æ³•ï¼‰"
      input: "report_type (str)"
      output: "int | None"
      example: |
        def _stage_num(self, report_type):
            for key in self.prompt_files:
                if key == report_type:
                    try:
                        return int(key.split("ï¼š")[0].replace("Stage ", ""))
                    except (ValueError, IndexError):
                        return None
            return None

    get_baseline:
      purpose: "è®€å–æŒ‡å®š Stage çš„ baseline prompt"
      input: "report_type (str)"
      output: "dict[str, str] â€” baseline prompt å…§å®¹ï¼Œæ‰¾ä¸åˆ°å›å‚³ç©º dict"
      logic: |
        1. ç”¨ _stage_num() å–å¾— stage ç·¨è™Ÿ
        2. è®€å– baselines/stage{N}_baseline.json
        3. å›å‚³ JSON å…§å®¹
      example: |
        def get_baseline(self, report_type):
            num = self._stage_num(report_type)
            if num is None:
                return {}
            baseline_file = self.baseline_dir / f"stage{num}_baseline.json"
            if not baseline_file.exists():
                return {}
            try:
                with open(baseline_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception:
                return {}

    save_baseline:
      purpose: "å°‡ç›®å‰è…³æœ¬ä¸­çš„ prompt å„²å­˜ç‚º baselineï¼ˆè¦†è“‹ç¾æœ‰ baselineï¼‰"
      input: "report_type (str)"
      output: "bool â€” æ˜¯å¦æˆåŠŸ"
      logic: |
        1. ç”¨ get_prompts() å–å¾—ç›®å‰è…³æœ¬çš„ prompt
        2. å¯«å…¥ baselines/stage{N}_baseline.json
        âš ï¸ Baseline ä¸å¯åˆªé™¤ï¼Œåƒ…èƒ½è¦†è“‹æ›´æ–°
      example: |
        def save_baseline(self, report_type):
            num = self._stage_num(report_type)
            if num is None:
                return False
            prompts = self.get_prompts(report_type)
            if not prompts:
                return False
            baseline_file = self.baseline_dir / f"stage{num}_baseline.json"
            try:
                with open(baseline_file, 'w', encoding='utf-8') as f:
                    json.dump(prompts, f, ensure_ascii=False, indent=2)
                return True
            except Exception:
                return False

    compare_with_baseline:
      purpose: "æ¯”è¼ƒç›®å‰è…³æœ¬ prompt èˆ‡ baselineï¼Œå›å‚³å·®ç•°è³‡è¨Š"
      input: "report_type (str)"
      output: |
        dict: {
            'has_baseline': bool,      # æ˜¯å¦æœ‰ baseline
            'is_identical': bool,       # ç›®å‰è…³æœ¬èˆ‡ baseline æ˜¯å¦å®Œå…¨ä¸€è‡´
            'diffs': {                  # é€ key æ¯”è¼ƒçµæœ
                prompt_key: {
                    'baseline': str|None,
                    'current': str|None,
                    'changed': bool
                }
            }
        }
      example: |
        def compare_with_baseline(self, report_type):
            baseline = self.get_baseline(report_type)
            current = self.get_prompts(report_type)
            if not baseline:
                return {'has_baseline': False, 'is_identical': False, 'diffs': {}}
            all_keys = sorted(set(list(baseline.keys()) + list(current.keys())))
            diffs = {}
            all_same = True
            for key in all_keys:
                b_val = baseline.get(key)
                c_val = current.get(key)
                changed = b_val != c_val
                if changed:
                    all_same = False
                diffs[key] = {'baseline': b_val, 'current': c_val, 'changed': changed}
            return {'has_baseline': True, 'is_identical': all_same, 'diffs': diffs}

    restore_from_baseline:
      purpose: "å¾ baseline æ¢å¾© prompt åˆ°è…³æœ¬ï¼ˆå…ˆå‚™ä»½å†è¦†è“‹ï¼‰"
      input: "report_type (str)"
      output: "bool â€” æ˜¯å¦æˆåŠŸ"
      logic: |
        1. è®€å– baseline
        2. å‘¼å« update_script_prompts() å¯«å›è…³æœ¬
        â­ update_script_prompts å…§éƒ¨æœƒè‡ªå‹•å‚™ä»½ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦é¡å¤–å‚™ä»½
      example: |
        def restore_from_baseline(self, report_type):
            baseline = self.get_baseline(report_type)
            if not baseline:
                return False
            return self.update_script_prompts(report_type, baseline)

# ============================================================================
# è…³æœ¬ç«¯ Prompt å¯«æ³•è¦ç¯„
# ============================================================================

script_prompt_conventions:
  description: |
    ç‚ºäº†è®“ PromptManager èƒ½æ­£ç¢ºæå–å’Œæ›¿æ›ï¼Œè…³æœ¬ä¸­çš„ prompt å¿…é ˆéµå®ˆä»¥ä¸‹è¦ç¯„ã€‚

  supported_formats:
    format_1_single_var:
      description: "å–®ä¸€ prompt çš„ stage"
      example: |
        PROMPT = """
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¸‚å ´åˆ†æå¸«...
        è«‹æ ¹æ“šä»¥ä¸‹åœ–ç‰‡åˆ†æ...
        """
      variable_naming: "PROMPT"

    format_2_multiple_vars:
      description: "å¤šå€‹ prompt çš„ stageï¼ˆå¦‚ä¸€å€‹ stage æœ‰ 2 æ¬¡ API å‘¼å«ï¼‰"
      example: |
        PROMPT_INFLOW = """
        è«‹åˆ†æä»¥ä¸‹æ·¨æµå…¥ ETF çš„è¡¨ç¾...
        """

        PROMPT_OUTFLOW = """
        è«‹åˆ†æä»¥ä¸‹æ·¨æµå‡º ETF çš„è¡¨ç¾...
        """
      variable_naming: "PROMPT_{SECTION_NAME}ï¼Œå…¨å¤§å¯«åº•ç·šåˆ†éš”"

    format_3_dict:
      description: "å­—å…¸æ ¼å¼ï¼ˆè¼ƒå°‘ç”¨ï¼‰"
      example: |
        PROMPTS = {
            "section_1": """
            ç¬¬ä¸€æ®µåˆ†æçš„ prompt...
            """,
            "section_2": """
            ç¬¬äºŒæ®µåˆ†æçš„ prompt...
            """
        }

  unsupported:
    dynamic_fstring:
      description: |
        å«æœ‰å‹•æ…‹è³‡æ–™çš„ f-string promptï¼ˆå¦‚åµŒå…¥å‰é¢ stage çš„è¼¸å‡ºï¼‰
        ç„¡æ³•è¢« regex éœæ…‹æå–ã€‚
      example: |
        # âŒ èˆŠå¯«æ³•ï¼ˆç„¡æ³•æå–ï¼‰
        prompt = f"""
        æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼š
        {stage1_output}      # â† å‹•æ…‹è³‡æ–™ï¼Œç„¡æ³•æå–
        è«‹ç¸½çµ...
        """
      workaround: |
        â­ æ¨è–¦åšæ³•ï¼šå°‡ f-string è½‰æ›ç‚ºæ¨¡æ¿å¸¸æ•¸ + {{variable}} ä½”ä½ç¬¦

        # âœ… æ–°å¯«æ³•ï¼ˆå¯æå– + å¯ç·¨è¼¯ï¼‰
        PROMPT_ABSTRACT = """
        æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼š
        {{stage1_output}}
        è«‹ç¸½çµ...
        """

        ç„¶å¾Œåœ¨ build_prompts() ä¸­ç”¨ .replace("{{stage1_output}}", actual_data) æ›¿æ›ã€‚
        é€™æ¨£ PromptManager å¯ä»¥æ­£å¸¸æå–å’Œå¯«å›ï¼ŒUI ä¹Ÿèƒ½ç·¨è¼¯ã€‚

        å°æ–¼ä¾è³´å‰åº API çµæœçš„è®Šæ•¸ï¼ˆå¦‚ {{us_conclusion}}ï¼‰ï¼Œ
        åœ¨ build_prompts() ä¸­æ¨™è¨˜ç‚º [éœ€è¦å‰åº API çµæœ]ï¼Œ
        ç„¶å¾Œåœ¨ main() ä¸­ç”¨å¯¦éš› API çµæœæ›¿æ›ã€‚

      migration_guide: |
        f-string â†’ æ¨¡æ¿å¸¸æ•¸çš„è½‰æ›æ­¥é©Ÿï¼š
        1. å°‡ f"..." æ”¹ç‚º """..."""ï¼ˆç§»é™¤ f å‰ç¶´ï¼‰
        2. å°‡ {variable} æ”¹ç‚º {{variable}}
        3. åœ¨ build_prompts() ä¸­ç”¨ .replace() æ›¿æ›è®Šæ•¸
        4. ä¾è³´å‰åº API çµæœçš„è®Šæ•¸ï¼Œæš«æ™‚æ¨™è¨˜ç‚º [éœ€è¦å‰åº API çµæœ]
        5. åœ¨ main() ä¸­ç”¨å¯¦éš›çµæœæ›¿æ›

# ============================================================================
# build_prompts() å…±ç”¨å‡½æ•¸æ¨¡å¼ï¼ˆShared Prompt Assemblyï¼‰
# ============================================================================

build_prompts_pattern:
  design_principle: |
    â­ **æ ¸å¿ƒç†å¿µ**ï¼šæ¯å€‹ Stage è…³æœ¬æä¾›ä¸€å€‹ build_prompts() å‡½æ•¸ï¼Œ
    å°è£å®Œæ•´çš„ prompt çµ„è£é‚è¼¯ï¼ˆè®Šæ•¸æ›¿æ› + è³‡æ–™è¼‰å…¥ï¼‰ã€‚
    UI é è¦½å’Œè…³æœ¬åŸ·è¡Œå…±ç”¨åŒä¸€å€‹å‡½æ•¸ï¼Œç¢ºä¿ 100% ä¸€è‡´ã€‚

    å•é¡ŒèƒŒæ™¯ï¼š
    - è…³æœ¬åŸ·è¡Œï¼šåœ¨ main() ä¸­çµ„è£ promptï¼ˆè¼‰å…¥ Excelã€æ›¿æ›è®Šæ•¸ï¼‰
    - UI é è¦½ï¼šåœ¨ UI ä¸­é‡æ–°å¯¦ä½œç›¸åŒé‚è¼¯ï¼ˆgenerate_dynamic_variables()ï¼‰
    - çµæœï¼šå…©ä»½çµ„è£ä»£ç¢¼ï¼Œå®¹æ˜“ä¸ä¸€è‡´ âŒ

    è§£æ±ºæ–¹æ¡ˆï¼š
    - æ¯å€‹ stage è…³æœ¬æ–°å¢ build_prompts(year, month, prompt_texts=None)
    - main() å‘¼å« build_prompts() å–å¾—æœ€çµ‚ prompt
    - UI é è¦½ä¹Ÿå‘¼å« build_prompts()ï¼Œå‚³å…¥ prompt_textsï¼ˆUI ç·¨è¼¯ä¸­çš„æ–‡å­—ï¼‰
    - å–®ä¸€ä¾†æºåŸå‰‡ï¼ˆSingle Source of Truthï¼‰âœ…

  function_signature:
    name: "build_prompts"
    parameters:
      year: "int â€” ç›®æ¨™å¹´ä»½"
      month: "int â€” ç›®æ¨™æœˆä»½"
      prompt_texts: |
        Optional[dict[str, str]] â€” UI å‚³å…¥çš„ç·¨è¼¯ä¸­ prompt æ–‡å­—ã€‚
        key ç‚ºè®Šæ•¸åï¼ˆå¦‚ 'PROMPT', 'PROMPT_INFLOW'ï¼‰ï¼Œvalue ç‚ºæ–‡å­—å…§å®¹ã€‚
        å¦‚æœç‚º None æˆ–æœªæä¾›æŸå€‹ keyï¼Œä½¿ç”¨ module-level å¸¸æ•¸ã€‚
    returns: |
      list[dict] â€” æ¯å€‹ dict åŒ…å«ï¼š
        - 'name': str â€” prompt è®Šæ•¸åï¼ˆå¦‚ 'PROMPT', 'PROMPT_INFLOW'ï¼‰
        - 'text': str â€” å®Œæ•´æ›¿æ›å¾Œçš„ prompt æ–‡å­—ï¼ˆå«è³‡æ–™ã€è®Šæ•¸ï¼‰

  why_prompt_texts_parameter: |
    Python çš„ module-level è®Šæ•¸åœ¨ import å¾Œæœƒå¿«å–ã€‚
    ç•¶ UI ä½¿ç”¨è€…ç·¨è¼¯ prompt ä¸¦ç”¨ update_script_prompts() å¯«å›è…³æœ¬å¾Œï¼Œ
    å·² import çš„ module ä»æŒæœ‰èˆŠå€¼ï¼ˆé™¤é reloadï¼‰ã€‚

    prompt_texts åƒæ•¸è§£æ±ºæ­¤å•é¡Œï¼š
    - UI ç›´æ¥æŠŠ session_state ä¸­çš„ç·¨è¼¯æ–‡å­—å‚³å…¥
    - ä¸ä¾è³´ module reload
    - è…³æœ¬ç›´æ¥åŸ·è¡Œæ™‚ä¸å‚³æ­¤åƒæ•¸ï¼Œè‡ªå‹•ä½¿ç”¨ module-level å¸¸æ•¸

  examples:
    single_prompt_stage:
      description: "å–®ä¸€ prompt çš„ stageï¼ˆå¦‚ Stage 1, 3, 4ï¼‰"
      code: |
        ```python
        PROMPT = """
        è«‹åˆ†æ {{YEAR}}å¹´{{MONTH}}æœˆ çš„å¸‚å ´è¡¨ç¾ã€‚
        {{data_comparison}}
        """

        def build_prompts(year, month, prompt_texts=None):
            # è¼‰å…¥è³‡æ–™
            excel_file = project_root / "data" / f"data_{year}{month:02d}.xlsx"
            data = load_data(excel_file) if excel_file.exists() else ""

            # ä½¿ç”¨ UI å‚³å…¥çš„æ–‡å­— or module-level å¸¸æ•¸
            prompt = (prompt_texts or {}).get('PROMPT', PROMPT)

            # æ›¿æ›æ‰€æœ‰è®Šæ•¸
            final = (prompt
                .replace("{{YEAR}}", str(year))
                .replace("{{MONTH}}", str(month))
                .replace("{{data_comparison}}", data)
            )
            return [{'name': 'PROMPT', 'text': final}]

        def main(year=2025, month=12):
            prompts = build_prompts(year, month)
            result = api.generate(prompts[0]['text'], images)
        ```

    multi_prompt_stage:
      description: "å¤šå€‹ prompt çš„ stageï¼ˆå¦‚ Stage 5, 6 å„æœ‰ 2 å€‹ï¼‰"
      code: |
        ```python
        PROMPT_INFLOW = """åˆ†ææ·¨æµå…¥ ETF... {{target_month}} {{data_table}}"""
        PROMPT_OUTFLOW = """åˆ†ææ·¨æµå‡º ETF... {{target_month}} {{data_table}}"""

        def build_prompts(year, month, prompt_texts=None):
            target_month = f"{year}å¹´{month}æœˆ"
            excel_file = project_root / "data" / f"etf_data_{year}{month:02d}.xlsx"
            texts = prompt_texts or {}

            # å„ prompt ç¨ç«‹è¼‰å…¥å°æ‡‰çš„è³‡æ–™
            p_in = texts.get('PROMPT_INFLOW', PROMPT_INFLOW)
            data_in = load_data(excel_file, "æ·¨æµå…¥å‰10å") if excel_file.exists() else ""
            final_in = p_in.replace("{{target_month}}", target_month)
            final_in = final_in.replace("{{data_table}}", data_in)

            p_out = texts.get('PROMPT_OUTFLOW', PROMPT_OUTFLOW)
            data_out = load_data(excel_file, "æ·¨æµå‡ºå‰10å") if excel_file.exists() else ""
            final_out = p_out.replace("{{target_month}}", target_month)
            final_out = final_out.replace("{{data_table}}", data_out)

            return [
                {'name': 'PROMPT_INFLOW', 'text': final_in},
                {'name': 'PROMPT_OUTFLOW', 'text': final_out},
            ]
        ```

    dependent_prompt_stage:
      description: "éƒ¨åˆ† prompt ä¾è³´å‰åº API çµæœçš„ stageï¼ˆå¦‚ Stage 7ï¼‰"
      code: |
        ```python
        from utils.stage_io import read_stage_output  # â­ çµ±ä¸€è®€å–å‡½æ•¸

        PROMPT_US = """ç¸½çµç¾åœ‹å¸‚å ´...\n{{us_full}}"""
        PROMPT_TW = """ç¸½çµå°ç£å¸‚å ´...\n{{tw_full}}"""
        PROMPT_OVERALL = """æ•´é«”ç¸½çµ...\n{{us_conclusion}}\n{{tw_conclusion}}"""

        def build_prompts(year, month, prompt_texts=None):
            texts = prompt_texts or {}
            # â­ ä½¿ç”¨ read_stage_output() çµ±ä¸€è®€å–å‰ç½® stage è¼¸å‡º
            # ä¸è«–å¾ UI é è¦½ã€UI åŸ·è¡Œã€CLIã€ä¸€éµ workflow è§¸ç™¼ï¼Œ
            # éƒ½èµ°åŒä¸€å€‹å‡½æ•¸ã€è®€åŒä¸€å€‹è³‡æ–™ä¾†æº
            stage1 = read_stage_output(1, year, month)

            # Prompt 1-2: å¯å®Œæ•´æ›¿æ›
            p_us = texts.get('PROMPT_US', PROMPT_US)
            final_us = p_us.replace("{{us_full}}", stage1 or "[å°šæœªåŸ·è¡Œ]")

            # Prompt 3: ä¾è³´ API 1-2 çµæœï¼Œé è¦½æ™‚æ¨™è¨˜
            p_overall = texts.get('PROMPT_OVERALL', PROMPT_OVERALL)
            final_overall = (p_overall
                .replace("{{us_conclusion}}", "[éœ€è¦å‰åº API çµæœ]")
                .replace("{{tw_conclusion}}", "[éœ€è¦å‰åº API çµæœ]")
            )

            return [
                {'name': 'PROMPT_US', 'text': final_us},
                {'name': 'PROMPT_OVERALL', 'text': final_overall},
            ]

        def main(year, month):
            prompts = build_prompts(year, month)
            # API 1: ä½¿ç”¨ prompts[0]['text']
            us_result = api.generate(prompts[0]['text'])
            # API 2: ç”¨å¯¦éš› API çµæœæ›¿æ› PROMPT_OVERALL çš„è®Šæ•¸
            final_overall = (PROMPT_OVERALL
                .replace("{{us_conclusion}}", us_result)
                .replace("{{tw_conclusion}}", tw_result)
            )
            overall_result = api.generate(final_overall)
        ```

  ui_integration:
    description: |
      UI ç«¯é€é importlib å‹•æ…‹ import å„ stage çš„ build_prompts()ï¼Œ
      ç„¡éœ€åœ¨ UI ä¸­é‡æ–°å¯¦ä½œè³‡æ–™è¼‰å…¥å’Œè®Šæ•¸æ›¿æ›é‚è¼¯ã€‚
    code: |
      ```python
      def get_build_prompts_fn(stage_num):
          """å‹•æ…‹å–å¾— stage è…³æœ¬çš„ build_prompts å‡½æ•¸ï¼ˆæ¯æ¬¡å¼·åˆ¶ reloadï¼‰"""
          import importlib
          import sys as _sys
          module_map = {
              1: "scripts.stages.stage1_xxx",
              2: "scripts.stages.stage2_yyy",
              # ...
          }
          if stage_num not in module_map:
              return None
          module_name = module_map[stage_num]
          # âš ï¸ å¿…é ˆ reloadï¼šimportlib æœƒå¿«å– moduleï¼Œ
          # è‹¥ UI ç·¨è¼¯è…³æœ¬å¾Œä¸ reloadï¼Œbuild_prompts ä»ç”¨èˆŠé‚è¼¯
          if module_name in _sys.modules:
              mod = importlib.reload(_sys.modules[module_name])
          else:
              mod = importlib.import_module(module_name)
          return mod.build_prompts

      # å®Œæ•´é è¦½æŒ‰éˆ• handler
      if st.button("ğŸ”„ ç”Ÿæˆå®Œæ•´é è¦½"):
          build_fn = get_build_prompts_fn(stage_num)
          # å‚³å…¥ UI ç·¨è¼¯ä¸­çš„ prompt æ–‡å­—
          edited = {pn: st.session_state.get(f"pe_{stage_num}_{pn}", v)
                    for pn, v in base_prompts.items()}
          results = build_fn(year, month, prompt_texts=edited)
          # é¡¯ç¤ºå°æ‡‰ prompt çš„å®Œæ•´é è¦½
          for r in results:
              if r['name'] == current_prompt_name:
                  st.text_area("å®Œæ•´é è¦½", r['text'], disabled=True)
      ```

  benefits:
    - "âœ… é è¦½èˆ‡åŸ·è¡Œ 100% ä¸€è‡´ï¼šä½¿ç”¨å®Œå…¨ç›¸åŒçš„çµ„è£å‡½æ•¸"
    - "âœ… å–®ä¸€ç¶­è­·é»ï¼šä¿®æ”¹çµ„è£é‚è¼¯åªéœ€æ”¹ build_prompts()"
    - "âœ… è§£æ±º module å¿«å–å•é¡Œï¼šprompt_texts åƒæ•¸ç¹é import å¿«å–"
    - "âœ… æ”¯æ´æ‰€æœ‰ prompt é¡å‹ï¼šéœæ…‹ã€å‹•æ…‹è®Šæ•¸ã€ä¾è³´å‰åº API çµæœ"
    - "âœ… UI ç„¡éœ€çŸ¥é“è³‡æ–™è¼‰å…¥ç´°ç¯€ï¼šäº¤çµ¦ stage è…³æœ¬è™•ç†"

  migration_guide:
    description: "å°‡ç¾æœ‰ stage è…³æœ¬é·ç§»åˆ° build_prompts() æ¨¡å¼"
    steps:
      - step: "1. ç¢ºä¿ prompt æ˜¯ module-level å¸¸æ•¸ï¼ˆä¸æ˜¯ f-stringï¼‰"
        detail: "å¦‚æœæœ‰ f-stringï¼Œå…ˆç”¨ unsupported.dynamic_fstring.migration_guide è½‰æ›"
      - step: "2. æ–°å¢ build_prompts() å‡½æ•¸"
        detail: |
          å°‡ main() ä¸­çš„è³‡æ–™è¼‰å…¥ + è®Šæ•¸æ›¿æ›é‚è¼¯æå–åˆ° build_prompts()ã€‚
          ä¿æŒ main() ä¸­çš„åœ–ç‰‡è¼‰å…¥å’Œ API å‘¼å«ä¸å‹•ã€‚
      - step: "3. ä¿®æ”¹ main() å‘¼å« build_prompts()"
        detail: |
          prompts = build_prompts(year, month)
          result = api.generate(prompts[0]['text'], images)
      - step: "4. åˆªé™¤ UI ä¸­çš„é‡è¤‡é‚è¼¯"
        detail: |
          åˆªé™¤ generate_dynamic_variables() ç­‰ UI å°ˆç”¨çš„çµ„è£å‡½æ•¸ï¼Œ
          æ”¹ç‚ºå‘¼å« get_build_prompts_fn(stage_num)(year, month, prompt_texts=edited)
      - step: "5. æ¸¬è©¦"
        detail: "ç¢ºèª UI å®Œæ•´é è¦½èˆ‡è…³æœ¬åŸ·è¡Œçš„ prompt å…§å®¹ä¸€è‡´"

# ============================================================================
# Stage é–“ä¾è³´çš„çµ±ä¸€è®€å–æ©Ÿåˆ¶ï¼ˆUnified Stage Output Readingï¼‰
# ============================================================================

stage_output_reading:
  design_principle: |
    â­ **æ ¸å¿ƒç†å¿µ**ï¼šç•¶ Stage é–“å­˜åœ¨ä¾è³´é—œä¿‚ï¼ˆå¦‚ Stage 4 è®€å– Stage 3 è¼¸å‡ºï¼‰ï¼Œ
    æ‰€æœ‰è§¸ç™¼è·¯å¾‘ï¼ˆUI é è¦½ã€UI åŸ·è¡Œã€CLI åŸ·è¡Œã€ä¸€éµ workflowï¼‰
    å¿…é ˆä½¿ç”¨åŒä¸€å€‹å‡½æ•¸è®€å–åŒä¸€å€‹è³‡æ–™ä¾†æºã€‚

    å•é¡ŒèƒŒæ™¯ï¼š
    - UI é è¦½åœ¨ build_prompts() ä¸­ç›´æ¥è®€å– temp/ æª”æ¡ˆ
    - UIã€Œæ–‡å­—è¼¸å…¥ï¼ˆå‰ç½® Stage è¼¸å‡ºï¼‰ã€é¡¯ç¤ºæ´»å‹•ç‰ˆæœ¬ï¼ˆâ˜…ï¼‰çš„å…§å®¹
    - å…©è€…å¯èƒ½æ˜¯ä¸åŒæª”æ¡ˆï¼Œå°è‡´é è¦½èˆ‡ UI é¡¯ç¤ºä¸ä¸€è‡´ âŒ
    - ä¸€éµ workflow è‹¥å„ªå…ˆè®€å–èˆŠçš„æ´»å‹•ç‰ˆæœ¬ï¼Œæœƒå¿½ç•¥å‰›ç”Ÿæˆçš„ temp/ æª”æ¡ˆ âŒ

    è§£æ±ºæ–¹æ¡ˆï¼š
    - å»ºç«‹ utils/stage_io.pyï¼Œæä¾› read_stage_output() å–®ä¸€è®€å–å‡½æ•¸
    - æ‰€æœ‰ build_prompts() å…§éƒ¨çµ±ä¸€å‘¼å«æ­¤å‡½æ•¸
    - å‡½æ•¸å…§éƒ¨æ¯”è¼ƒæ´»å‹•ç‰ˆæœ¬èˆ‡ temp/ çš„æ™‚é–“æˆ³ï¼Œå–è¼ƒæ–°è€…
    - ä¸è«–å¾å“ªè£¡è§¸ç™¼ï¼Œéƒ½èµ°åŒä¸€æ¢è®€å–è·¯å¾‘ âœ…

  module:
    file: "utils/stage_io.py"
    description: "Stage è¼¸å‡ºè®€å–å·¥å…· â€” çµ±ä¸€è®€å–é‚è¼¯"

  function:
    name: "read_stage_output"
    signature: "read_stage_output(stage_num: int, year: int, month: int) -> str"
    parameters:
      stage_num: "Stage ç·¨è™Ÿï¼ˆ1-7ï¼‰"
      year: "å¹´ä»½"
      month: "æœˆä»½"
    returns: "Stage è¼¸å‡ºå…§å®¹ï¼ˆstrï¼‰ï¼Œè‹¥ä¸å­˜åœ¨å›å‚³ç©ºå­—ä¸²"

  resolution_logic: |
    åˆ¤æ–·é‚è¼¯ï¼ˆæ™‚é–“æˆ³æ¯”è¼ƒï¼‰ï¼š

    | æ´»å‹•ç‰ˆæœ¬           | temp/ æª”æ¡ˆ         | çµæœ           |
    |--------------------|--------------------|----------------|
    | å­˜åœ¨ï¼ˆè¼ƒæ–°ï¼‰        | å­˜åœ¨ï¼ˆè¼ƒèˆŠï¼‰        | ç”¨æ´»å‹•ç‰ˆæœ¬     |
    | å­˜åœ¨ï¼ˆè¼ƒèˆŠï¼‰        | å­˜åœ¨ï¼ˆè¼ƒæ–°ï¼‰        | ç”¨ temp/       |
    | å­˜åœ¨               | ä¸å­˜åœ¨              | ç”¨æ´»å‹•ç‰ˆæœ¬     |
    | ä¸å­˜åœ¨              | å­˜åœ¨               | ç”¨ temp/       |
    | ä¸å­˜åœ¨              | ä¸å­˜åœ¨              | å›å‚³ç©ºå­—ä¸²     |

    æ´»å‹•ç‰ˆæœ¬è·¯å¾‘ï¼štemp/active_versions_{YYYYMM}.json â†’ temp/versions/{YYYYMM}/stage{N}/{vid}.md
    temp/ æª”æ¡ˆè·¯å¾‘ï¼štemp/{output_prefix}_{YYYYMM}.md

  usage_scenarios:
    workflow: |
      ä¸€éµ workflowï¼šæ¯å€‹ Stage åŸ·è¡Œå®Œå¯«å…¥ temp/ å¾Œæ™‚é–“æˆ³æœ€æ–°ï¼Œ
      ä¸‹ä¸€å€‹ Stage å‘¼å« read_stage_output() è‡ªç„¶è®€åˆ°å‰›ç”Ÿæˆçš„çµæœã€‚
    ui_preview: |
      UI é¸å®šæ´»å‹•ç‰ˆæœ¬å¾Œé è¦½ï¼šæ´»å‹•ç‰ˆæœ¬çš„æ™‚é–“æˆ³è¼ƒæ–°ï¼Œ
      read_stage_output() è‡ªå‹•è®€å–ä½¿ç”¨è€…é¸å®šçš„ç‰ˆæœ¬ã€‚
    ui_execution: |
      UI åŸ·è¡Œ Stage å¾Œï¼štemp/ æª”æ¡ˆå‰›å¯«å…¥ï¼Œæ™‚é–“æˆ³æœ€æ–°ï¼Œ
      read_stage_output() è®€åˆ°æœ€æ–°çµæœã€‚

  implementation:
    code: |
      ```python
      # utils/stage_io.py
      import json
      from pathlib import Path

      project_root = Path(__file__).parent.parent

      STAGE_OUTPUT_PREFIX = {
          1: "stage1_xxx",
          2: "stage2_yyy",
          3: "stage3_zzz",
          # ... ä¾å°ˆæ¡ˆå®šç¾©
      }

      def _get_active_version_path(stage_num, prefix):
          """å–å¾—æ´»å‹•ç‰ˆæœ¬æª”æ¡ˆè·¯å¾‘"""
          active_path = project_root / "temp" / f"active_versions_{prefix}.json"
          if not active_path.exists():
              return None
          try:
              active = json.loads(active_path.read_text(encoding='utf-8'))
              vid = active.get(str(stage_num))
              if vid:
                  vf = project_root / "temp" / "versions" / prefix / f"stage{stage_num}" / f"{vid}.md"
                  if vf.exists():
                      return vf
          except Exception:
              pass
          return None

      def _get_temp_path(stage_num, prefix):
          """å–å¾— temp/ æª”æ¡ˆè·¯å¾‘"""
          output_prefix = STAGE_OUTPUT_PREFIX.get(stage_num)
          if not output_prefix:
              return None
          temp_file = project_root / "temp" / f"{output_prefix}_{prefix}.md"
          if temp_file.exists():
              return temp_file
          return None

      def read_stage_output(stage_num, year, month):
          """
          è®€å–æŒ‡å®š Stage çš„è¼¸å‡ºã€‚
          è‹¥æ´»å‹•ç‰ˆæœ¬å’Œ temp/ éƒ½å­˜åœ¨ï¼Œå–è¼ƒæ–°çš„ï¼›å¦å‰‡å–å­˜åœ¨çš„é‚£å€‹ã€‚
          """
          prefix = f"{year}{month:02d}"
          version_path = _get_active_version_path(stage_num, prefix)
          temp_path = _get_temp_path(stage_num, prefix)

          # å…©è€…éƒ½å­˜åœ¨ â†’ æ¯”è¼ƒæ™‚é–“æˆ³
          if version_path and temp_path:
              if temp_path.stat().st_mtime >= version_path.stat().st_mtime:
                  return temp_path.read_text(encoding='utf-8')
              else:
                  return version_path.read_text(encoding='utf-8')

          if version_path:
              return version_path.read_text(encoding='utf-8')
          if temp_path:
              return temp_path.read_text(encoding='utf-8')
          return ""
      ```

  benefits:
    - "âœ… æ‰€æœ‰è§¸ç™¼è·¯å¾‘è®€åˆ°ç›¸åŒè³‡æ–™ï¼šUI é è¦½ã€UI åŸ·è¡Œã€CLIã€ä¸€éµ workflow"
    - "âœ… è‡ªå‹•è§£æç‰ˆæœ¬å„ªå…ˆé †åºï¼šæ™‚é–“æˆ³æ¯”è¼ƒï¼Œç„¡éœ€æ‰‹å‹•æŒ‡å®š"
    - "âœ… å‘å¾Œç›¸å®¹ï¼šæ²’æœ‰æ´»å‹•ç‰ˆæœ¬æ™‚è‡ªå‹•å›é€€åˆ° temp/ æª”æ¡ˆ"
    - "âœ… Workflow ä¸å—èˆŠç‰ˆæœ¬å¹²æ“¾ï¼šå‰›ç”Ÿæˆçš„ temp/ æ™‚é–“æˆ³ä¸€å®šæœ€æ–°"
    - "âœ… å–®ä¸€ç¶­è­·é»ï¼šä¿®æ”¹è®€å–é‚è¼¯åªéœ€æ”¹ stage_io.py"

  migration_guide:
    steps:
      - step: "1. å»ºç«‹ utils/stage_io.py"
        detail: "å®šç¾© STAGE_OUTPUT_PREFIX å°æ‡‰è¡¨å’Œ read_stage_output() å‡½æ•¸"
      - step: "2. åœ¨æœ‰ä¾è³´çš„ stage ä¸­ import ä¸¦ä½¿ç”¨"
        detail: |
          from utils.stage_io import read_stage_output
          stage3_output = read_stage_output(3, year, month)
      - step: "3. ç§»é™¤å„ stage è‡ªå·±çš„ load_xxx_output() å‡½æ•¸"
        detail: "åˆªé™¤ stage è…³æœ¬ä¸­å„è‡ªå¯¦ä½œçš„è®€å–é‚è¼¯ï¼Œçµ±ä¸€èµ° read_stage_output()"
      - step: "4. ç§»é™¤ UI ä¸­çš„ dep_outputs / apply_dep_versions ç­‰é–“æ¥å‚³éæ©Ÿåˆ¶"
        detail: |
          ä¸å†éœ€è¦ UI å¾å¤–éƒ¨å‚³å…¥ä¾è³´è³‡æ–™ï¼Œ
          build_prompts() å…§éƒ¨ç›´æ¥å‘¼å« read_stage_output()ã€‚
      - step: "5. æ¸¬è©¦å„è§¸ç™¼è·¯å¾‘"
        detail: |
          ç¢ºèªä»¥ä¸‹å ´æ™¯è®€åˆ°ç›¸åŒè³‡æ–™ï¼š
          - UI é è¦½ï¼ˆå‹•æ…‹é è¦½æŒ‰éˆ•ï¼‰
          - UI åŸ·è¡Œï¼ˆsubprocessï¼‰
          - CLI åŸ·è¡Œï¼ˆpython stage4.py --year 2025 --month 12ï¼‰
          - ä¸€éµ workflowï¼ˆrun_complete_workflow.pyï¼‰

# ============================================================================
# è¼¸å…¥é©—è­‰ï¼ˆInput Validation / Pre-flight Checkï¼‰
# ============================================================================

input_validation:
  design_principle: |
    â­ **æ ¸å¿ƒç†å¿µ**ï¼šæ¯å€‹ Stage è…³æœ¬æä¾›ä¸€å€‹ check_inputs() å‡½æ•¸ï¼Œ
    åœ¨åŸ·è¡Œå‰æª¢æŸ¥æ‰€æœ‰å¿…è¦è¼¸å…¥ï¼ˆåœ–ç‰‡ã€Excelã€å‰ç½® Stage è¼¸å‡ºï¼‰æ˜¯å¦å­˜åœ¨ã€‚
    Workflow åœ¨å•Ÿå‹•æ¯å€‹ Stage å‰å‘¼å«æ­¤å‡½æ•¸ï¼Œæå‰è­¦å‘Šç¼ºå°‘çš„è¼¸å…¥ã€‚

    å•é¡ŒèƒŒæ™¯ï¼š
    - Stage è…³æœ¬åœ¨åŸ·è¡Œä¸­é€”æ‰ç™¼ç¾è¼¸å…¥ä¸å­˜åœ¨ï¼Œæµªè²» API å‘¼å«å’Œæ™‚é–“
    - ç¼ºå°‘ä¸Šæœˆæ•¸æ“šæ™‚ï¼ŒStage ç›´æ¥å¤±æ•—ï¼Œæ²’æœ‰æå‰è­¦å‘Š
    - ä¸åŒ Stage çš„éŒ¯èª¤è™•ç†ä¸ä¸€è‡´

    è§£æ±ºæ–¹æ¡ˆï¼š
    - æ¯å€‹ Stage è…³æœ¬æ–°å¢ check_inputs(year, month) å‡½æ•¸
    - å€åˆ† ERRORï¼ˆå¿…è¦è¼¸å…¥ï¼Œç¼ºå°‘æœƒå°è‡´å¤±æ•—ï¼‰å’Œ WARNINGï¼ˆå¯é¸è¼¸å…¥ï¼‰
    - Workflow åœ¨æ¯å€‹ Stage å‰çµ±ä¸€å‘¼å«æª¢æŸ¥
    - å€‹åˆ¥åŸ·è¡Œ Stage æ™‚ä¹Ÿåœ¨ main() é–‹é ­å‘¼å«

  function_signature:
    name: "check_inputs"
    parameters:
      year: "int â€” ç›®æ¨™å¹´ä»½"
      month: "int â€” ç›®æ¨™æœˆä»½"
    returns: |
      list[tuple[str, str]] â€” [(level, message), ...]
        level: 'ERROR'ï¼ˆå¿…è¦è¼¸å…¥ï¼Œç¼ºå°‘æœƒå°è‡´å¤±æ•—ï¼‰
               'WARNING'ï¼ˆå¯é¸è¼¸å…¥ï¼Œç¼ºå°‘ä¸å½±éŸ¿åŸ·è¡Œï¼‰

  input_categories:
    images:
      description: "åœ–ç‰‡æª”æ¡ˆï¼ˆPNG ç­‰ï¼‰ï¼Œé€šå¸¸æ˜¯ multimodal API çš„å¿…è¦è¼¸å…¥"
      typical_level: "ERROR"
      example: |
        img = project_root / "images" / f"chart_{prefix}.png"
        if not img.exists():
            issues.append(("ERROR", f"åœ–ç‰‡ä¸å­˜åœ¨: {img.name}"))

    excel_data:
      description: "Excel è³‡æ–™æª”æ¡ˆ"
      typical_level: "WARNING æˆ– ERRORï¼Œè¦–æ˜¯å¦æœ‰å‚™ç”¨è³‡æ–™ä¾†æºï¼ˆå¦‚åœ–ç‰‡ï¼‰"
      example: |
        excel = project_root / "data" / f"data_{prefix}.xlsx"
        if not excel.exists():
            issues.append(("WARNING", f"Excel ä¸å­˜åœ¨: {excel.name}"))

    stage_outputs:
      description: "å‰ç½® Stage çš„è¼¸å‡ºæª”æ¡ˆï¼ˆ.mdï¼‰"
      typical_level: "ç•¶æœˆå¿…è¦è¼¸å‡º â†’ ERRORï¼›ä¸Šæœˆå°æ¯”ç”¨ â†’ WARNING"
      example: |
        curr = project_root / "temp" / f"stage3_output_{prefix}.md"
        if not curr.exists():
            issues.append(("ERROR", f"Stage 3 ç•¶æœˆè¼¸å‡ºä¸å­˜åœ¨: {curr.name}"))

        prev = project_root / "temp" / f"stage3_output_{prev_prefix}.md"
        if not prev.exists():
            issues.append(("WARNING", f"Stage 3 ä¸Šæœˆè¼¸å‡ºä¸å­˜åœ¨: {prev.name}ï¼ˆMoM å°æ¯”å°‡ç¼ºå°‘ä¸Šæœˆè³‡æ–™ï¼‰"))

  examples:
    simple_stage:
      description: "åªéœ€è¦ä¸€å¼µåœ–ç‰‡çš„ Stage"
      code: |
        ```python
        def check_inputs(year, month):
            """æª¢æŸ¥æ‰€æœ‰è¼¸å…¥æ˜¯å¦å­˜åœ¨ï¼Œå›å‚³ [(level, message), ...]"""
            issues = []
            prefix = f"{year}{month:02d}"

            img = project_root / "images" / f"us_etf_top10_flows_{prefix}.png"
            if not img.exists():
                issues.append(("ERROR", f"åœ–ç‰‡ä¸å­˜åœ¨: {img.name}"))

            return issues
        ```

    multi_input_stage:
      description: "éœ€è¦å¤šç¨®è¼¸å…¥çš„ Stageï¼ˆåœ–ç‰‡ + Excel + ä¸Šæœˆå°æ¯”ï¼‰"
      code: |
        ```python
        def check_inputs(year, month):
            issues = []
            prefix = f"{year}{month:02d}"
            prev_month = month - 1 if month > 1 else 12
            prev_year = year if month > 1 else year - 1
            prev_prefix = f"{prev_year}{prev_month:02d}"

            # åœ–ç‰‡ï¼ˆå¿…è¦ï¼‰
            for p in [f"chart_{prefix}.png", f"chart_{prev_prefix}.png"]:
                if not (project_root / "images" / p).exists():
                    issues.append(("ERROR", f"åœ–ç‰‡ä¸å­˜åœ¨: {p}"))

            # Excelï¼ˆæœ‰å‚™ç”¨è³‡æ–™ä¾†æºï¼Œç‚º WARNINGï¼‰
            excel = project_root / "data" / "data.xlsx"
            if not excel.exists():
                issues.append(("WARNING", f"Excel ä¸å­˜åœ¨: {excel.name}"))

            return issues
        ```

    dependent_stage:
      description: "ä¾è³´å‰ç½® Stage è¼¸å‡ºçš„ Stageï¼ˆå¦‚ MoM å°æ¯”ï¼‰"
      code: |
        ```python
        def check_inputs(year, month):
            issues = []
            prefix = f"{year}{month:02d}"
            prev_month = month - 1 if month > 1 else 12
            prev_year = year if month > 1 else year - 1
            prev_prefix = f"{prev_year}{prev_month:02d}"

            # ç•¶æœˆ Stage 3 è¼¸å‡ºï¼ˆå¿…è¦ï¼‰
            curr = project_root / "temp" / f"stage3_output_{prefix}.md"
            if not curr.exists():
                issues.append(("ERROR", f"Stage 3 ç•¶æœˆè¼¸å‡ºä¸å­˜åœ¨: {curr.name}"))

            # ä¸Šæœˆ Stage 3 è¼¸å‡ºï¼ˆMoM å°æ¯”ç”¨ï¼Œéå¿…è¦ï¼‰
            prev = project_root / "temp" / f"stage3_output_{prev_prefix}.md"
            if not prev.exists():
                issues.append(("WARNING",
                    f"Stage 3 ä¸Šæœˆè¼¸å‡ºä¸å­˜åœ¨: {prev.name}ï¼ˆMoM å°æ¯”å°‡ç¼ºå°‘ä¸Šæœˆè³‡æ–™ï¼‰"))

            return issues
        ```

    summary_stage:
      description: "å½™æ•´å¤šå€‹å‰ç½® Stage è¼¸å‡ºçš„ Stageï¼ˆå¦‚æœ€çµ‚ç¸½çµï¼‰"
      code: |
        ```python
        def check_inputs(year, month):
            issues = []
            prefix = f"{year}{month:02d}"
            temp_dir = project_root / "temp"

            # å¿…è¦è¼¸å‡ºï¼ˆç¼ºå°‘æœƒåš´é‡å½±éŸ¿å“è³ªï¼‰
            required = {
                1: f"stage1_output_{prefix}.md",
                4: f"stage4_output_{prefix}.md",
            }
            for sn, fname in required.items():
                if not (temp_dir / fname).exists():
                    issues.append(("ERROR", f"Stage {sn} è¼¸å‡ºä¸å­˜åœ¨: {fname}"))

            # å¯é¸è¼¸å‡ºï¼ˆç¼ºå°‘æœƒå½±éŸ¿å®Œæ•´æ€§ä½†ä¸è‡´å¤±æ•—ï¼‰
            optional = {
                2: f"stage2_output_{prefix}.md",
                3: f"stage3_output_{prefix}.md",
                5: f"stage5_output_{prefix}.md",
                6: f"stage6_output_{prefix}.md",
            }
            for sn, fname in optional.items():
                if not (temp_dir / fname).exists():
                    issues.append(("WARNING", f"Stage {sn} è¼¸å‡ºä¸å­˜åœ¨: {fname}"))

            return issues
        ```

  workflow_integration:
    description: |
      Workflow è…³æœ¬åœ¨å•Ÿå‹•æ¯å€‹ Stage å‰å‘¼å« check_inputs()ï¼Œçµ±ä¸€å°å‡ºæª¢æŸ¥çµæœã€‚
    helper_function: |
      ```python
      def run_input_check(check_fn, year, month, logger=None):
          """åŸ·è¡Œè¼¸å…¥æª¢æŸ¥ä¸¦å°å‡ºçµæœï¼Œå›å‚³æ˜¯å¦æœ‰ ERROR"""
          issues = check_fn(year, month)
          if not issues:
              print("[CHECK] æ‰€æœ‰è¼¸å…¥å°±ç·’")
              return False
          for level, msg in issues:
              print(f"  [{level}] {msg}")
          has_error = any(level == "ERROR" for level, _ in issues)
          if logger and issues:
              logger.info(f"Input check: {len(issues)} issue(s), has_error={has_error}")
          return has_error
      ```
    usage: |
      ```python
      from scripts.stages.stage1_xxx import check_inputs as stage1_check
      from scripts.stages.stage2_yyy import check_inputs as stage2_check
      # ... ä»¥æ­¤é¡æ¨

      # åœ¨æ¯å€‹ Stage åŸ·è¡Œå‰
      print("[Stage 1] è¼¸å…¥æª¢æŸ¥...")
      run_input_check(stage1_check, year, month, logger)
      # ç¹¼çºŒåŸ·è¡Œï¼ˆstages å…§éƒ¨å·²æœ‰å„è‡ªçš„éŒ¯èª¤è™•ç†ï¼‰
      ```

  stage_integration:
    description: |
      æ¯å€‹ Stage çš„ main() åœ¨é–‹é ­å‘¼å« check_inputs() ä¸¦å°å‡ºè­¦å‘Šï¼Œ
      ä½†ä¸ä¸­æ–·åŸ·è¡Œï¼ˆè®“å¾ŒçºŒç¨‹å¼ç¢¼è‡ªè¡Œè™•ç†ç¼ºå¤±ï¼‰ã€‚
    code: |
      ```python
      def main(year=2025, month=12):
          print(f"[Stage N] XXX ({year}å¹´{month}æœˆ)")
          print("-" * 60)

          for level, msg in check_inputs(year, month):
              print(f"  [{level}] {msg}")

          # ... å¾ŒçºŒé‚è¼¯ï¼ˆstage å…§éƒ¨å·²æœ‰ if not exists çš„è™•ç†ï¼‰
      ```

  auto_run_dependencies:
    description: |
      å°æ–¼ä¾è³´å‰ç½® Stage è¼¸å‡ºçš„ Stageï¼ŒWorkflow å¯è‡ªå‹•è£œè·‘ç¼ºå¤±çš„ä¾è³´ã€‚
      å¸¸è¦‹å ´æ™¯ï¼šæŸå€‹ Stage éœ€è¦ä¸Šå€‹æœˆçš„å‰ç½® Stage è¼¸å‡ºåš MoM å°æ¯”ï¼Œ
      ä½†ä½¿ç”¨è€…åªè·‘äº†ç•¶æœˆæµç¨‹ï¼Œä¸Šå€‹æœˆçš„è¼¸å‡ºä¸å­˜åœ¨ã€‚
    code: |
      ```python
      # åœ¨ Stage N ä¹‹å‰ï¼Œæª¢æŸ¥ä¸¦è‡ªå‹•è£œè·‘ä¸Šæœˆä¾è³´
      from datetime import datetime, timedelta

      prev_date = datetime(year, month, 1) - timedelta(days=1)
      prev_year, prev_month = prev_date.year, prev_date.month
      prev_output = work_dir / "temp" / f"stage3_output_{prev_year}{prev_month:02d}.md"

      if not prev_output.exists():
          print(f"[AUTO] ä¸Šæœˆ Stage 3 è¼¸å‡ºä¸å­˜åœ¨ï¼Œè‡ªå‹•è£œè·‘...")
          stage3_main(prev_year, prev_month)
      ```

  benefits:
    - "âœ… æå‰è­¦å‘Šï¼šåœ¨ API å‘¼å«å‰å°±ç™¼ç¾ç¼ºå¤±è¼¸å…¥"
    - "âœ… å€åˆ†åš´é‡ç¨‹åº¦ï¼šERROR vs WARNING è®“ä½¿ç”¨è€…äº†è§£å½±éŸ¿ç¯„åœ"
    - "âœ… ä¸€è‡´çš„ä»‹é¢ï¼šæ‰€æœ‰ Stage ä½¿ç”¨ç›¸åŒçš„ check_inputs(year, month) ç°½å"
    - "âœ… é›™é‡æ•´åˆï¼šWorkflow çµ±ä¸€æª¢æŸ¥ + å€‹åˆ¥ Stage å„è‡ªæª¢æŸ¥"
    - "âœ… ä¸é˜»æ–·åŸ·è¡Œï¼šæª¢æŸ¥çµæœåƒ…ç‚ºè­¦å‘Šï¼Œstage å…§éƒ¨è‡ªè¡Œæ±ºå®šæ˜¯å¦ä¸­æ–·"
    - "âœ… å¯æ“´å±•ï¼šæ–°å¢è¼¸å…¥é¡å‹åªéœ€ä¿®æ”¹å°æ‡‰ stage çš„ check_inputs()"

  best_practices:
    - "æ¯å€‹ Stage éƒ½æ‡‰æœ‰ check_inputs()ï¼Œå³ä½¿åªæœ‰ä¸€å€‹è¼¸å…¥"
    - "ERROR ç”¨æ–¼å¿…è¦è¼¸å…¥ï¼ˆç¼ºå°‘æœƒå°è‡´ API å¤±æ•—æˆ–çµæœå“è³ªæ¥µå·®ï¼‰"
    - "WARNING ç”¨æ–¼å¯é¸è¼¸å…¥ï¼ˆç¼ºå°‘æœƒå½±éŸ¿å®Œæ•´æ€§ä½†ä¸è‡´å¤±æ•—ï¼‰"
    - "Workflow çš„ run_input_check() ä¸æ‡‰é˜»æ­¢ Stage åŸ·è¡Œ"
    - "check_inputs() æ‡‰å¿«é€ŸåŸ·è¡Œï¼ˆåªæª¢æŸ¥æª”æ¡ˆå­˜åœ¨æ€§ï¼Œä¸è®€å–å…§å®¹ï¼‰"
    - "ä¸Šæœˆå°æ¯”ç”¨çš„æ•¸æ“šé€šå¸¸ç‚º WARNINGï¼Œç•¶æœˆå¿…è¦æ•¸æ“šç‚º ERROR"
    - "å‰ç½® Stage è¼¸å‡ºä¸­ï¼Œæ ¸å¿ƒæ®µè½ç”¨ ERRORï¼Œè£œå……æ®µè½ç”¨ WARNING"

# ============================================================================
# UI æ•´åˆè¨­è¨ˆï¼ˆStreamlitï¼‰
# ============================================================================

ui_integration:
  stage_config:
    description: |
      UI ç”¨ä¸€å€‹ STAGE_META å­—å…¸æè¿°æ‰€æœ‰ stage çš„é…ç½®ï¼Œ
      ç”¨æ–¼è‡ªå‹•ç”Ÿæˆå„ stage çš„ç®¡ç†é é¢ã€‚
    schema:
      name: "str â€” stage é¡¯ç¤ºåç¨±"
      emoji: "str â€” åœ–ç¤º"
      api: "int â€” API å‘¼å«æ¬¡æ•¸"
      script: "str | None â€” è…³æœ¬è·¯å¾‘"
      output_prefix: "str | None â€” è¼¸å‡ºæª”åå‰ç¶´"
      images_in: "list[str] â€” è¼¸å…¥åœ–ç‰‡æª”åï¼ˆæ”¯æ´ {prefix} æ›¿æ›ï¼‰"
      data_in: "list[str] â€” è¼¸å…¥è³‡æ–™æª”åï¼ˆæ”¯æ´ {prefix} æ›¿æ›ï¼‰"
      prompt_key: "str | None â€” å°æ‡‰ PromptManager.prompt_files çš„ key"

  prompt_editor_ui:
    layout: |
      æ¯å€‹ stage é é¢æœ‰ä¸‰å€‹ tabï¼š
      1. ğŸ“¥ è¼¸å…¥ç®¡ç† â€” åœ–ç‰‡é è¦½ã€è³‡æ–™ç‹€æ…‹ã€Prompt ç·¨è¼¯å™¨
      2. â–¶ï¸ åŸ·è¡Œ â€” åŸ·è¡ŒæŒ‰éˆ• + ç•¶å‰è¼¸å‡ºé è¦½ + è…³æœ¬åŸå§‹ç¢¼
      3. ğŸ“œ ç‰ˆæœ¬è¨˜éŒ„ â€” è¼¸å‡ºç‰ˆæœ¬å¿«ç…§ç®¡ç†

    prompt_section_components:
      - name: "è‰ç¨¿è¨˜éŒ„ expanderï¼ˆå« Baselineï¼‰"
        description: |
          åˆ—å‡ºå·²å­˜çš„è‰ç¨¿ï¼ŒBaseline å›ºå®šåœ¨æœ€ä¸Šæ–¹ã€‚
          - Baselineï¼šç½®é ‚é¡¯ç¤ºï¼Œæœ‰ã€Œè¼‰å…¥ã€æŒ‰éˆ•ï¼Œç„¡åˆªé™¤æŒ‰éˆ•ï¼ˆä¸å¯åˆªé™¤ï¼‰
          - è‰ç¨¿ï¼šä¾æ™‚é–“æ’åºï¼Œæœ‰ã€Œè¼‰å…¥ã€å’Œã€ŒğŸ—‘ã€åˆªé™¤æŒ‰éˆ•
          - Baseline èˆ‡è‰ç¨¿ä¹‹é–“ç”¨åˆ†éš”ç·šå€åˆ†

      - name: "Baseline æ¯”è¼ƒ expander"
        description: |
          é¡¯ç¤ºç›®å‰è…³æœ¬ prompt èˆ‡ Baseline çš„å·®ç•°ï¼š
          - æœ‰ Baseline æ™‚ï¼šé¡¯ç¤ºã€Œâœ… èˆ‡ Baseline ä¸€è‡´ã€æˆ–ã€Œâš ï¸ èˆ‡ Baseline ä¸åŒã€
          - æœ‰å·®ç•°æ™‚ï¼šå·¦å³ä¸¦æ’é¡¯ç¤º Baseline vs ç›®å‰è…³æœ¬ï¼ˆdisabled text_areaï¼‰
          - æ“ä½œæŒ‰éˆ•ï¼š
            - ğŸ“Œ å°‡ç›®å‰è…³æœ¬è¨­ç‚ºæ–° Baselineï¼ˆè¦†è“‹ç¾æœ‰ï¼‰
            - âª å¾ Baseline é‚„åŸè…³æœ¬ï¼ˆåªåœ¨æœ‰å·®ç•°æ™‚é¡¯ç¤ºï¼‰
          - ç„¡ Baseline æ™‚ï¼šé¡¯ç¤ºã€ŒğŸ“Œ Baselineï¼ˆå°šæœªå»ºç«‹ï¼‰ã€+ å»ºç«‹æŒ‰éˆ•

      - name: "å„ Prompt ç·¨è¼¯å™¨"
        description: |
          æ¯å€‹ prompt è®Šæ•¸ä¸€å€‹ expanderï¼Œå…§å«ï¼š
          - å­—æ•¸/è¡Œæ•¸é¡¯ç¤º
          - æ˜¯å¦å·²ä¿®æ”¹çš„æç¤º
          - text_area ç·¨è¼¯å™¨ï¼ˆå¯ç·¨è¼¯ï¼‰
      - name: "Prompt é è¦½åŠŸèƒ½ï¼ˆå…©ç¨®å±¤æ¬¡ï¼‰"
        description: |
          â­ æä¾›å…©å±¤æ¬¡çš„é è¦½ï¼š

          ã€è¼•é‡éœæ…‹é è¦½ã€‘render_prompt_with_variables()
          - åƒ…æ›¿æ›éœæ…‹è®Šæ•¸ï¼ˆ{{YEAR}}, {{MONTH}} ç­‰ï¼‰
          - å‹•æ…‹è®Šæ•¸ï¼ˆéœ€è®€å– Excel/æª”æ¡ˆï¼‰æ¨™è¨˜ç‚º [åŸ·è¡Œæ™‚å‹•æ…‹ç”Ÿæˆ: {{xxx}}]
          - å³æ™‚å›é¥‹ï¼Œä¸éœ€è¦è®€å–ä»»ä½•æª”æ¡ˆ
          - é¡¯ç¤ºæ›¿æ›å¾Œçš„å­—æ•¸å’Œè¡Œæ•¸

          ã€å®Œæ•´é è¦½ã€‘å‘¼å« build_prompts()ï¼ˆâ­ æ¨è–¦ï¼‰
          - å‘¼å« stage è…³æœ¬çš„ build_prompts(year, month, prompt_texts=edited)
          - å®Œæ•´æ›¿æ›æ‰€æœ‰è®Šæ•¸ï¼ˆå« Excel è³‡æ–™ï¼‰
          - é è¦½å…§å®¹èˆ‡å¯¦éš›åŸ·è¡Œå®Œå…¨ä¸€è‡´
          - éœ€è¦è³‡æ–™æª”æ¡ˆå­˜åœ¨

        static_preview_implementation: |
          def render_prompt_with_variables(prompt_text, year, month):
              """è¼•é‡éœæ…‹é è¦½ï¼šåƒ…æ›¿æ›å·²çŸ¥çš„éœæ…‹è®Šæ•¸"""
              prev_year, prev_month = calculate_prev_month(year, month)
              rendered = (prompt_text
                  .replace("{{YEAR}}", str(year))
                  .replace("{{MONTH}}", str(month))
                  .replace("{{PREV_YEAR}}", str(prev_year))
                  .replace("{{PREV_MONTH}}", str(prev_month))
              )
              # å‰©é¤˜å‹•æ…‹è®Šæ•¸æ¨™è¨˜
              import re
              rendered = re.sub(r'\{\{(\w+)\}\}',
                                lambda m: f"[åŸ·è¡Œæ™‚å‹•æ…‹ç”Ÿæˆ: {{{{{m.group(1)}}}}}]",
                                rendered)
              return rendered

        complete_preview_implementation: |
          def get_build_prompts_fn(stage_num):
              """å‹•æ…‹å–å¾— stage è…³æœ¬çš„ build_prompts()"""
              import importlib
              module_map = {1: "scripts.stages.stage1_xxx", ...}
              mod = importlib.import_module(module_map[stage_num])
              return mod.build_prompts

          # å®Œæ•´é è¦½æŒ‰éˆ•
          if st.button("ğŸ”„ ç”Ÿæˆå®Œæ•´é è¦½ï¼ˆå«è³‡æ–™ï¼‰"):
              build_fn = get_build_prompts_fn(stage_num)
              edited = {pn: st.session_state.get(f"pe_{stage_num}_{pn}", v)
                        for pn, v in base_prompts.items()}
              results = build_fn(year, month, prompt_texts=edited)
              for r in results:
                  st.text_area(f"å®Œæ•´é è¦½ï¼š{r['name']}", r['text'],
                               height=300, disabled=True)

        note: |
          âš ï¸ ä¸è¦åœ¨ UI ä¸­é‡æ–°å¯¦ä½œ build_prompts() çš„è³‡æ–™è¼‰å…¥é‚è¼¯ã€‚
          ç›´æ¥ import ä¸¦å‘¼å« stage è…³æœ¬çš„ build_prompts()ï¼Œ
          ç¢ºä¿é è¦½èˆ‡åŸ·è¡Œä½¿ç”¨å®Œå…¨ç›¸åŒçš„ç¨‹å¼ç¢¼è·¯å¾‘ã€‚

      - name: "æ“ä½œæŒ‰éˆ•åˆ—ï¼ˆ3 æ¬„ï¼‰"
        buttons:
          - "ğŸ’¾ æš«å­˜è‰ç¨¿ â€” å­˜åˆ° prompts/drafts/ JSONï¼Œä¸å½±éŸ¿åŸ·è¡Œ"
          - "ğŸ“¤ æ›´æ–°åˆ°è…³æœ¬ â€” å‘¼å« update_script_prompts()ï¼Œå¯«å› .py"
          - "ğŸ”„ å¾è…³æœ¬é‡æ–°è¼‰å…¥ â€” æ¸…é™¤ session_stateï¼Œé‡æ–°è®€å–"

    session_state_keys:
      prompt_editor: "pe_{stage_num}_{prompt_var_name}"

  streamlit_code_patterns:
    prompt_editor: |
      def ui_prompts(stage_num, year=None, month=None):
          meta = STAGE_META[stage_num]
          if not meta["prompt_key"]:
              return

          pm = PromptManager()
          base_prompts = pm.get_prompts(meta["prompt_key"])
          if not base_prompts:
              st.warning("æ‰¾ä¸åˆ° Prompt")
              return

          # ===== è‰ç¨¿ç®¡ç†ï¼ˆå« Baseline ç½®é ‚ï¼‰=====
          baseline_prompts = pm.get_baseline(meta["prompt_key"])
          drafts = get_drafts(stage_num)
          has_entries = bool(baseline_prompts or drafts)

          if has_entries:
              draft_label = f"ğŸ“ è‰ç¨¿è¨˜éŒ„ï¼ˆ{len(drafts)} å€‹ï¼‰" if drafts else "ğŸ“ è‰ç¨¿è¨˜éŒ„"
              with st.expander(draft_label, expanded=False):
                  # Baseline å›ºå®šåœ¨æœ€ä¸Šæ–¹
                  if baseline_prompts:
                      c1, c2, c3 = st.columns([5, 1, 1])
                      with c1:
                          st.text("ğŸ“Œ Baselineï¼ˆåŸºæº–ç‰ˆæœ¬ï¼‰")
                      with c2:
                          if st.button("è¼‰å…¥", key=f"ld_{stage_num}_baseline",
                                       use_container_width=True):
                              for pn, content in baseline_prompts.items():
                                  st.session_state[f"pe_{stage_num}_{pn}"] = content
                              st.rerun()
                      with c3:
                          st.empty()  # Baseline ä¸å¯åˆªé™¤
                      if drafts:
                          st.divider()

                  # è‰ç¨¿åˆ—è¡¨ï¼ˆè¼‰å…¥ + åˆªé™¤æŒ‰éˆ•ï¼‰
                  for d in drafts[:10]:
                      c1, c2, c3 = st.columns([5, 1, 1])
                      with c1:
                          st.text(f"{d['id']}  ({d['time'].strftime('%m-%d %H:%M:%S')})")
                      with c2:
                          if st.button("è¼‰å…¥", key=f"ld_{stage_num}_{d['id']}",
                                       use_container_width=True):
                              loaded = json.loads(
                                  Path(d["path"]).read_text(encoding='utf-8'))
                              for pn, content in loaded.items():
                                  st.session_state[f"pe_{stage_num}_{pn}"] = content
                              st.rerun()
                      with c3:
                          if st.button("ğŸ—‘", key=f"del_{stage_num}_{d['id']}",
                                       use_container_width=True):
                              Path(d["path"]).unlink()
                              st.rerun()

          # ===== å„ Prompt ç·¨è¼¯å™¨ =====
          for pname, default in base_prompts.items():
              init = st.session_state.get(f"pe_{stage_num}_{pname}", default)
              with st.expander(f"âœï¸ {pname}"):
                  cc = st.columns(3)
                  cc[0].caption(f"å­—æ•¸ï¼š{len(init)}")
                  cc[1].caption(f"è¡Œæ•¸ï¼š{len(init.splitlines())}")
                  if init != default:
                      cc[2].caption("âš ï¸ å·²ä¿®æ”¹")

                  st.text_area("", init, height=250,
                               key=f"pe_{stage_num}_{pname}",
                               label_visibility="collapsed")

                  if year and month:
                      with st.expander(f"ğŸ‘ï¸ é è¦½ï¼ˆè®Šæ•¸æ›¿æ›å¾Œï¼‰", expanded=False):
                          rendered = render_prompt_with_variables(init, year, month)
                          st.text_area("", rendered, height=250,
                                       key=f"preview_{stage_num}_{pname}",
                                       label_visibility="collapsed",
                                       disabled=True)
                          st.caption(f"ğŸ“Š æ›¿æ›å¾Œå­—æ•¸ï¼š{len(rendered)} | è¡Œæ•¸ï¼š{len(rendered.splitlines())}")

          # ===== Baseline æ¯”è¼ƒ =====
          comparison = pm.compare_with_baseline(meta["prompt_key"])
          if comparison['has_baseline']:
              status_label = "èˆ‡ Baseline ä¸€è‡´" if comparison['is_identical'] else "èˆ‡ Baseline ä¸åŒ"
              status_icon = "âœ…" if comparison['is_identical'] else "âš ï¸"
              with st.expander(f"{status_icon} Baseline æ¯”è¼ƒï¼ˆ{status_label}ï¼‰", expanded=False):
                  if comparison['is_identical']:
                      st.success("ç›®å‰è…³æœ¬çš„ Prompt èˆ‡ Baseline å®Œå…¨ä¸€è‡´ã€‚")
                  else:
                      for pname, diff in comparison['diffs'].items():
                          if diff['changed']:
                              st.markdown(f"**`{pname}`** â€” æœ‰å·®ç•°")
                              bl_col, cur_col = st.columns(2)
                              with bl_col:
                                  st.caption("Baseline")
                                  if diff['baseline']:
                                      st.text_area("", diff['baseline'], height=200,
                                                   key=f"bl_{stage_num}_{pname}",
                                                   disabled=True,
                                                   label_visibility="collapsed")
                                  else:
                                      st.info("ï¼ˆBaseline ä¸­ä¸å­˜åœ¨æ­¤ keyï¼‰")
                              with cur_col:
                                  st.caption("ç›®å‰è…³æœ¬")
                                  if diff['current']:
                                      st.text_area("", diff['current'], height=200,
                                                   key=f"cur_{stage_num}_{pname}",
                                                   disabled=True,
                                                   label_visibility="collapsed")
                                  else:
                                      st.info("ï¼ˆè…³æœ¬ä¸­ä¸å­˜åœ¨æ­¤ keyï¼‰")
                              st.divider()
                          else:
                              st.caption(f"`{pname}` â€” ç„¡å·®ç•°")

                  bl_c1, bl_c2 = st.columns(2)
                  with bl_c1:
                      if st.button("ğŸ“Œ å°‡ç›®å‰è…³æœ¬è¨­ç‚ºæ–° Baseline",
                                   key=f"set_bl_{stage_num}",
                                   use_container_width=True):
                          if pm.save_baseline(meta["prompt_key"]):
                              st.success("âœ… Baseline å·²æ›´æ–°")
                              st.rerun()
                  with bl_c2:
                      if not comparison['is_identical']:
                          if st.button("âª å¾ Baseline é‚„åŸè…³æœ¬",
                                       key=f"restore_bl_{stage_num}",
                                       use_container_width=True):
                              if pm.restore_from_baseline(meta["prompt_key"]):
                                  st.success("âœ… å·²é‚„åŸç‚º Baseline")
                                  for pn in base_prompts:
                                      st.session_state.pop(f"pe_{stage_num}_{pn}", None)
                                  st.rerun()
          else:
              with st.expander("ğŸ“Œ Baselineï¼ˆå°šæœªå»ºç«‹ï¼‰", expanded=False):
                  if st.button("ğŸ“Œ å°‡ç›®å‰è…³æœ¬è¨­ç‚º Baseline",
                               key=f"init_bl_{stage_num}",
                               use_container_width=True):
                      if pm.save_baseline(meta["prompt_key"]):
                          st.success("âœ… Baseline å·²å»ºç«‹")
                          st.rerun()

          # ===== ä¸‰å€‹æŒ‰éˆ• =====
          c1, c2, c3 = st.columns(3)
          # æš«å­˜è‰ç¨¿ â†’ save_draft()
          # æ›´æ–°åˆ°è…³æœ¬ â†’ pm.update_script_prompts()
          # é‡æ–°è¼‰å…¥ â†’ æ¸… session_state + st.rerun()

# ============================================================================
# è¼¸å‡ºç‰ˆæœ¬ç®¡ç†
# ============================================================================

version_management:
  description: |
    æ¯æ¬¡æˆåŠŸåŸ·è¡Œ stage å¾Œï¼Œè‡ªå‹•å¿«ç…§è¼¸å‡ºåˆ°ç‰ˆæœ¬ç›®éŒ„ã€‚
    ä½¿ç”¨è€…å¯ä»¥åˆ‡æ›ä¸»è¦ç‰ˆæœ¬ã€åˆªé™¤ç‰ˆæœ¬ã€é è¦½å…§å®¹ã€‚
    æœ€çµ‚çµ„è£æ™‚å¯é¸æ“‡å„ stage çš„ç‰¹å®šç‰ˆæœ¬ã€‚

  storage:
    snapshots: "temp/versions/{YYYYMM}/stage{N}/v{YYYYMMDD_HHMMSS}[_{tag}].md"
    snapshot_patterns:
      individual_run: "v20260211_143022.md"          # å€‹åˆ¥åŸ·è¡Œ stage
      workflow_run: "v20260211_143022_workflow.md"   # å®Œæ•´ workflow åŸ·è¡Œ
    active_tracking: "temp/active_versions_{YYYYMM}.json"
    active_json_format: |
      {
        "1": "v20260209_143022",
        "2": "v20260209_143045_workflow",
        ...
      }

  operations:
    snapshot:
      signature: "snapshot(stage_num, prefix, tag=None)"
      description: "è¤‡è£½ temp/stage{N}_output_{prefix}.md â†’ versions ç›®éŒ„"
      tag_parameter: |
        å¯é¸çš„ tag åƒæ•¸ç”¨æ–¼å€åˆ†ç”¢å‡ºä¾†æºï¼š
        - tag=Noneï¼ˆé è¨­ï¼‰ï¼šå€‹åˆ¥åŸ·è¡Œ stage â†’ v{timestamp}.md
        - tag="workflow"ï¼šå®Œæ•´ workflow åŸ·è¡Œ â†’ v{timestamp}_workflow.md
        é€™æ¨£ä½¿ç”¨è€…å¯ä»¥ä¸€çœ¼å€åˆ†å“ªäº›ç‰ˆæœ¬æ˜¯å–®ç¨åŸ·è¡Œç”¢ç”Ÿï¼Œå“ªäº›æ˜¯å®Œæ•´æµç¨‹ç”¢ç”Ÿ
    set_active: "æ›´æ–° active_versions JSON"
    apply_version: "å¾ versions ç›®éŒ„è¤‡è£½å› temp/ï¼ˆä¾›ä¸‹æ¸¸ stage è®€å–ï¼‰"
    delete_version: "åˆªé™¤å¿«ç…§æª” + è‹¥ç‚º active å‰‡æ¸…é™¤ active è¨˜éŒ„"

  auto_snapshot_flow:
    individual_stage: |
      åŸ·è¡Œå–®ä¸€ stage â†’ æˆåŠŸ â†’ snapshot(stage_num, prefix) â†’ set_active_vid()
      ç”¢ç”Ÿæª”åï¼šv20260211_143022.md

    complete_workflow: |
      åŸ·è¡Œå®Œæ•´ workflow â†’ æˆåŠŸ â†’ å°æ‰€æœ‰ stage æ‰¹æ¬¡åŸ·è¡Œï¼š
        for sn in range(1, 8):
          snapshot(sn, prefix, tag="workflow")
          set_active_vid(sn, prefix, vid)
      ç”¢ç”Ÿæª”åï¼šv20260211_143022_workflow.mdï¼ˆæ‰€æœ‰ stage ä½¿ç”¨ç›¸åŒæ™‚é–“æˆ³ï¼‰

    benefit: |
      å…©ç¨®åŸ·è¡Œæ¨¡å¼ç”¢ç”Ÿä¸åŒçš„æª”åæ ¼å¼ï¼Œä½¿ç”¨è€…å¯è¼•æ˜“å€åˆ†ï¼š
      - ç„¡å¾Œç¶´ç‰ˆæœ¬ï¼šå–®ç¨æ¸¬è©¦/èª¿æ•´æŸå€‹ stage
      - _workflow ç‰ˆæœ¬ï¼šå®Œæ•´æµç¨‹ä¸€æ¬¡è·‘å®Œï¼Œç¢ºä¿å„ stage é–“çš„ä¸€è‡´æ€§

  assembly_stage:
    description: |
      æœ€çµ‚çµ„è£ stage çš„ç‰¹æ®Š UIï¼š
      - ç‚ºæ¯å€‹å‰ç½® stage æä¾› selectbox é¸æ“‡ç‰ˆæœ¬
      - ã€Œå¥—ç”¨ã€æŒ‰éˆ•ï¼šapply_version() å°‡é¸å®šç‰ˆæœ¬è¤‡è£½åˆ° temp/
      - ç„¶å¾ŒåŸ·è¡Œçµ„è£è…³æœ¬è®€å– temp/ ä¸­çš„æª”æ¡ˆ

# ============================================================================
# å·²çŸ¥é™·é˜±èˆ‡è§£æ±ºæ–¹æ¡ˆ
# ============================================================================

known_pitfalls:
  - issue: "æå–å’Œå¯«å› regex ä¸ä¸€è‡´"
    description: |
      extract_prompts_from_script å’Œ update_script_prompts çš„åµæ¸¬ regex å¿…é ˆä¸€è‡´ã€‚
      ä¾‹å¦‚ extract æ”¯æ´ PROMPTï¼ˆç„¡åº•ç·šï¼‰ï¼Œä½† update çš„åµæ¸¬åªæ‰¾ PROMPT_\w+ï¼Œ
      æœƒå°è‡´ã€Œçœ‹å¾—åˆ°ä½†å¯«ä¸å›ã€çš„å‡æˆåŠŸ bugã€‚
    solution: "å…©è™•çµ±ä¸€ç”¨ r'PROMPT(?:_\\w+)?' åŒæ™‚åŒ¹é… PROMPT å’Œ PROMPT_XXX"

  - issue: "å‹•æ…‹ f-string prompt ç„¡æ³•æå–"
    description: |
      å«æœ‰ {variable} çš„ f-string prompt ä¸æ˜¯ module-level å¸¸æ•¸ï¼Œ
      regex ç„¡æ³•éœæ…‹æå–ï¼Œä¸”ä¹Ÿç„¡æ³•å¯«å›ã€‚
    solution: |
      â­ æ¨è–¦åšæ³•ï¼šå°‡ f-string è½‰æ›ç‚ºæ¨¡æ¿å¸¸æ•¸ + {{variable}} ä½”ä½ç¬¦
      ï¼ˆè©³è¦‹ script_prompt_conventions.unsupported.dynamic_fstring.migration_guideï¼‰

      èˆŠæ–¹æ¡ˆï¼ˆä¸æ¨è–¦ï¼‰ï¼šåœ¨ STAGE_META è¨­ prompt_key=Noneï¼Œé¡¯ç¤ºèªªæ˜è¨Šæ¯ã€‚
      æ­¤æ–¹æ¡ˆç„¡æ³•åœ¨ UI ä¸­ç·¨è¼¯è©² stage çš„ promptï¼Œé«”é©—å·®ã€‚

  - issue: "JSON å¿«å–èˆ‡è…³æœ¬ä¸åŒæ­¥ï¼ˆèˆŠç‰ˆè¨­è¨ˆå•é¡Œï¼‰"
    description: |
      èˆŠç‰ˆ get_prompts() å„ªå…ˆè®€å– JSON å¿«å–ã€‚
      ç•¶ä½¿ç”¨è€…é€é UI ã€Œæ›´æ–°åˆ°è…³æœ¬ã€å¾Œï¼Œ.py è…³æœ¬å·²æ›´æ–°ï¼Œ
      ä½† JSON å¿«å–ä»æ˜¯èˆŠç‰ˆï¼Œå°è‡´ UI é‡æ–°æ•´ç†å¾Œé¡¯ç¤ºèˆŠ promptã€‚
    solution: |
      â­ æ ¹æœ¬è§£æ³•ï¼šget_prompts() æ°¸é å¾ .py è…³æœ¬æå–ï¼ˆä¸ä½¿ç”¨ JSON å¿«å–ï¼‰ã€‚
      JSON æª”æ¡ˆåƒ…ç”¨æ–¼è‰ç¨¿æš«å­˜ï¼ˆdrafts/ï¼‰ï¼Œä¸ä½œç‚ºè®€å–ä¾†æºã€‚
      update_script_prompts() ç„¡éœ€åŒæ­¥ JSON å¿«å–ã€‚

  - issue: "é è¦½èˆ‡åŸ·è¡Œçš„ prompt çµ„è£é‚è¼¯ä¸ä¸€è‡´"
    description: |
      UI ä¸­æœ‰ç¨ç«‹çš„ generate_dynamic_variables() å‡½æ•¸ä¾†çµ„è£é è¦½ promptï¼Œ
      stage è…³æœ¬ main() æœ‰è‡ªå·±çš„çµ„è£é‚è¼¯ã€‚
      å…©ä»½ä»£ç¢¼å¯èƒ½æ¼¸æ¼¸å‡ºç¾ä¸ä¸€è‡´ï¼Œå°è‡´é è¦½èˆ‡åŸ·è¡Œçµæœä¸åŒã€‚
    solution: |
      â­ æ ¹æœ¬è§£æ³•ï¼šæ¯å€‹ stage è…³æœ¬å¯¦ä½œ build_prompts(year, month, prompt_texts=None)ï¼Œ
      UI é è¦½å’Œ main() éƒ½å‘¼å«æ­¤å‡½æ•¸ã€‚
      åˆªé™¤ UI ä¸­çš„ generate_dynamic_variables() ç­‰é‡è¤‡é‚è¼¯ã€‚
      ï¼ˆè©³è¦‹ build_prompts_pattern ç« ç¯€ï¼‰

  - issue: "Windows ç·¨ç¢¼å•é¡Œ"
    description: "subprocess åŸ·è¡Œè…³æœ¬æ™‚è¼¸å‡ºå«æœ‰é ASCII å­—å…ƒ"
    solution: |
      subprocess.Popen åŠ ä¸Š encoding='utf-8', errors='replace'ã€‚
      è…³æœ¬é ­éƒ¨åŠ  sys.stdout.reconfigure(encoding='utf-8', errors='replace')ã€‚

  - issue: "Baseline èˆ‡è…³æœ¬ä¸åŒæ­¥ï¼ˆStage é‡æ–°æ’åºå¾Œï¼‰"
    description: |
      ç•¶ Stage é‡æ–°æ’åºï¼ˆå¦‚ Stage 2 å’Œ Stage 4 äº’æ›ï¼‰æ™‚ï¼Œ
      baseline JSON æª”åä»ç„¶ç”¨èˆŠçš„ stage ç·¨è™Ÿï¼Œ
      å°è‡´ baseline èˆ‡è…³æœ¬ä¸å°æ‡‰ã€‚
    solution: |
      é‡æ–°æ’åº Stage å¾Œï¼Œéœ€è¦é‡æ–°ç”Ÿæˆæ‰€æœ‰ baselineï¼š
      1. ç¢ºèªæ‰€æœ‰ stage è…³æœ¬çš„ prompt å…§å®¹æ­£ç¢º
      2. å°æ¯å€‹ stage åŸ·è¡Œ save_baseline()
      3. é©—è­‰ baselines/ ç›®éŒ„ä¸­çš„æª”æ¡ˆèˆ‡è…³æœ¬ä¸€è‡´
      âš ï¸ Baseline ä¸å¯åˆªé™¤ï¼Œåªèƒ½è¦†è“‹æ›´æ–°

  - issue: "Streamlit session_state èˆ‡ widget key è¡çª"
    description: |
      text_area çš„ key å’Œ session_state é è¨­å€¼éœ€è¦ç²¾å¿ƒè¨­è¨ˆï¼Œ
      å¦å‰‡æœƒå‡ºç¾ã€Œä¿®æ”¹å¾Œåˆ‡æ› tab å°±é‡ç½®ã€çš„å•é¡Œã€‚
    solution: |
      ç”¨ st.session_state.get(key, default) å–å¾—åˆå§‹å€¼ï¼Œ
      å†æŠŠ key åŒæ™‚ä½œç‚º text_area çš„ keyï¼Œè®“ Streamlit è‡ªå‹•ç®¡ç†ã€‚

  - issue: "ç¼ºå°‘è¼¸å…¥é©—è­‰å°è‡´ Stage åŸ·è¡Œä¸­é€”å¤±æ•—"
    description: |
      æ²’æœ‰ pre-flight checkï¼ŒStage åœ¨ API å‘¼å«å¾Œæ‰ç™¼ç¾è¼¸å…¥ä¸å­˜åœ¨ï¼Œ
      æµªè²» API é¡åº¦å’Œæ™‚é–“ã€‚å°¤å…¶æ˜¯ä¾è³´å‰ç½® Stage è¼¸å‡ºçš„ Stageï¼Œ
      ç•¶ä¸Šæœˆè³‡æ–™ä¸å­˜åœ¨æ™‚ç›´æ¥å¤±æ•—ï¼Œæ²’æœ‰ä»»ä½•æå‰è­¦å‘Šã€‚
    solution: |
      â­ æ¯å€‹ Stage è…³æœ¬æ–°å¢ check_inputs(year, month) å‡½æ•¸ï¼Œ
      åœ¨ main() é–‹é ­å’Œ Workflow ä¸­çµ±ä¸€å‘¼å«ã€‚
      å€åˆ† ERRORï¼ˆå¿…è¦ï¼‰å’Œ WARNINGï¼ˆå¯é¸ï¼‰ï¼Œè®“ä½¿ç”¨è€…æå‰äº†è§£ç¼ºå¤±ã€‚
      ï¼ˆè©³è¦‹ input_validation ç« ç¯€ï¼‰

  - issue: "Stage é–“ä¾è³´è®€å–çš„è³‡æ–™ä¾†æºä¸ä¸€è‡´"
    description: |
      ç•¶ Stage æœ‰ä¾è³´é—œä¿‚ï¼ˆå¦‚ Stage 4 è®€å– Stage 3 è¼¸å‡ºï¼‰æ™‚ï¼Œ
      ä¸åŒè§¸ç™¼è·¯å¾‘å¯èƒ½è®€åˆ°ä¸åŒè³‡æ–™ï¼š
      - UI é è¦½ä¸­çš„ build_prompts() è®€å– temp/ æª”æ¡ˆ
      - UIã€Œæ–‡å­—è¼¸å…¥ã€å€é¡¯ç¤ºæ´»å‹•ç‰ˆæœ¬ï¼ˆâ˜…ï¼‰çš„å…§å®¹
      - ä¸€éµ workflow å¯«å…¥ temp/ ä½†èˆŠçš„æ´»å‹•ç‰ˆæœ¬å¯èƒ½è¼ƒæ–°
      å°è‡´ UI é è¦½èˆ‡é¡¯ç¤ºä¸ä¸€è‡´ã€workflow è®€å–åˆ°èˆŠç‰ˆæœ¬ âŒ
    solution: |
      â­ æ ¹æœ¬è§£æ³•ï¼šå»ºç«‹ utils/stage_io.pyï¼Œæä¾› read_stage_output() å–®ä¸€å‡½æ•¸ã€‚
      æ‰€æœ‰ build_prompts() å…§éƒ¨çµ±ä¸€å‘¼å«æ­¤å‡½æ•¸ï¼Œ
      å‡½æ•¸æ¯”è¼ƒæ´»å‹•ç‰ˆæœ¬èˆ‡ temp/ çš„æ™‚é–“æˆ³ï¼Œè‡ªå‹•å–è¼ƒæ–°è€…ã€‚
      ï¼ˆè©³è¦‹ stage_output_reading ç« ç¯€ï¼‰

  - issue: "importlib å¿«å–å°è‡´ UI reload å¾Œä»ç”¨èˆŠçš„ build_prompts()"
    description: |
      Streamlit UI ä½¿ç”¨ importlib.import_module() å‹•æ…‹è¼‰å…¥ stage è…³æœ¬ã€‚
      import_module() æœƒå¿«å– module åœ¨ sys.modules ä¸­ï¼Œ
      å³ä½¿è…³æœ¬æª”æ¡ˆå·²ä¿®æ”¹ï¼Œå¾ŒçºŒ import ä»è¿”å›å¿«å–çš„èˆŠç‰ˆæœ¬ã€‚
      å°è‡´ UI é è¦½ä½¿ç”¨èˆŠçš„ build_prompts() é‚è¼¯ã€‚
    solution: |
      åœ¨ get_build_prompts_fn() ä¸­ï¼Œæª¢æŸ¥ module æ˜¯å¦å·²åœ¨ sys.modulesï¼Œ
      è‹¥å·²å­˜åœ¨å‰‡ä½¿ç”¨ importlib.reload() å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼š
        if module_name in sys.modules:
            mod = importlib.reload(sys.modules[module_name])
        else:
            mod = importlib.import_module(module_name)

# ============================================================================
# çµ¦ AI çš„å»ºæ§‹æŒ‡å¼•
# ============================================================================

ai_implementation_guide:
  step_1_analyze_project:
    description: |
      å…ˆåˆ†æç›®æ¨™å°ˆæ¡ˆçš„çµæ§‹ï¼š
      - æœ‰å“ªäº› stage/stepï¼Ÿ
      - æ¯å€‹ stage å‘¼å«å“ªäº› APIï¼Ÿ
      - prompt ç›®å‰å¯«åœ¨å“ªè£¡ï¼Ÿæ ¼å¼ç‚ºä½•ï¼Ÿ
      - å“ªäº› prompt æ˜¯éœæ…‹çš„ï¼Ÿå“ªäº›å«æœ‰å‹•æ…‹è³‡æ–™ï¼ˆéœ€è®€å– Excel ç­‰ï¼‰ï¼Ÿ
      - å“ªäº› prompt ä¾è³´å‰åº stage çš„ API çµæœï¼Ÿ

  step_2_standardize_prompts:
    description: |
      å°‡å„è…³æœ¬çš„ prompt çµ±ä¸€ç‚º module-level å¸¸æ•¸ + {{variable}} ä½”ä½ç¬¦ï¼š
      - å–®ä¸€ prompt çš„ stage â†’ PROMPT = """..."""
      - å¤š prompt çš„ stage â†’ PROMPT_SECTION_A = """..."""
      - å‹•æ…‹ f-string â†’ è½‰æ›ç‚ºæ¨¡æ¿å¸¸æ•¸ï¼ˆè¦‹ migration_guideï¼‰
        ä¾‹ï¼šf"...{data}..." â†’ PROMPT = """...{{data}}..."""
      - ä¾è³´å‰åº API çš„è®Šæ•¸ â†’ ä½¿ç”¨ {{variable}} ä½”ä½ç¬¦ï¼Œ
        build_prompts() ä¸­æ¨™è¨˜ç‚º [éœ€è¦å‰åº API çµæœ]ï¼Œmain() ä¸­æ›¿æ›

  step_3_create_prompt_manager:
    description: |
      å»ºç«‹ PromptManager é¡åˆ¥ï¼š
      - å®šç¾© prompt_files æ˜ å°„è¡¨ï¼ˆæ‰€æœ‰ stage éƒ½è¦æœ‰ mappingï¼ŒåŒ…æ‹¬ä»¥å‰è¨­ None çš„ï¼‰
      - å¯¦ä½œ extract / get / update æ–¹æ³•
      - â­ get_prompts() æ°¸é å¾è…³æœ¬æå–ï¼Œä¸å„ªå…ˆè®€å– JSON å¿«å–
      - å¯¦ä½œ backup / restore æ–¹æ³•
      - ç¢ºä¿ extract å’Œ update çš„ regex ä¸€è‡´
      - å¯¦ä½œ Baseline ç®¡ç†æ–¹æ³•ï¼ˆget_baseline, save_baseline, compare_with_baseline, restore_from_baselineï¼‰
      - å»ºç«‹ baselines/ ç›®éŒ„ï¼ŒBaseline ä¸å¯åˆªé™¤åƒ…èƒ½è¦†è“‹

  step_4_add_build_prompts:
    description: |
      â­ ç‚ºæ¯å€‹ stage è…³æœ¬æ–°å¢ build_prompts() å‡½æ•¸ï¼š
      - å°‡ main() ä¸­çš„è³‡æ–™è¼‰å…¥ + è®Šæ•¸æ›¿æ›é‚è¼¯æå–åˆ° build_prompts()
      - å‡½æ•¸ç°½åï¼šbuild_prompts(year, month, prompt_texts=None)
      - å›å‚³ï¼šlist[{'name': str, 'text': str}]
      - ä¿®æ”¹ main() å‘¼å« build_prompts()
      - UI å’Œ main() å…±ç”¨åŒä¸€å€‹å‡½æ•¸
      ï¼ˆè©³è¦‹ build_prompts_pattern ç« ç¯€ï¼‰

  step_5_add_input_validation:
    description: |
      â­ ç‚ºæ¯å€‹ stage è…³æœ¬æ–°å¢ check_inputs() å‡½æ•¸ï¼š
      - å‡½æ•¸ç°½åï¼šcheck_inputs(year, month) â†’ list[(level, message)]
      - æª¢æŸ¥æ‰€æœ‰å¿…è¦è¼¸å…¥ï¼ˆåœ–ç‰‡ã€Excelã€å‰ç½® Stage è¼¸å‡ºï¼‰æ˜¯å¦å­˜åœ¨
      - å€åˆ† ERRORï¼ˆå¿…è¦ï¼‰å’Œ WARNINGï¼ˆå¯é¸ï¼‰
      - åœ¨ main() é–‹é ­å‘¼å«ä¸¦å°å‡ºçµæœ
      - åœ¨ Workflow ä¸­ç”¨ run_input_check() çµ±ä¸€å‘¼å«
      - ä¾è³´å‰ç½® Stage çš„å ´æ™¯å¯è‡ªå‹•è£œè·‘ç¼ºå¤±ä¾è³´
      ï¼ˆè©³è¦‹ input_validation ç« ç¯€ï¼‰

  step_6_integrate_ui:
    description: |
      åœ¨ Streamlit UI ä¸­æ•´åˆï¼š
      - å®šç¾© STAGE_META é…ç½®ï¼ˆæ‰€æœ‰ stage éƒ½è¨­ prompt_keyï¼Œä¸å†è¨­ Noneï¼‰
      - å»ºç«‹ ui_prompts() å…ƒä»¶ï¼ˆå«å…©å±¤æ¬¡é è¦½åŠŸèƒ½ï¼‰
      - è¼•é‡é è¦½ï¼šrender_prompt_with_variables()ï¼ˆéœæ…‹è®Šæ•¸æ›¿æ›ï¼‰
      - å®Œæ•´é è¦½ï¼šget_build_prompts_fn() + build_prompts()ï¼ˆå®Œæ•´çµ„è£ï¼‰
      - â­ åˆªé™¤ generate_dynamic_variables() ç­‰é‡è¤‡é‚è¼¯
      - å»ºç«‹è‰ç¨¿ç®¡ç†åŠŸèƒ½ï¼ˆå«åˆªé™¤æŒ‰éˆ•ï¼‰
      - å»ºç«‹ Baseline æ¯”è¼ƒåŠŸèƒ½ï¼ˆå·®ç•°é¡¯ç¤ºã€è¨­ç‚º Baselineã€å¾ Baseline é‚„åŸï¼‰
      - è‰ç¨¿è¨˜éŒ„ä¸­ç½®é ‚é¡¯ç¤º Baselineï¼ˆå¯è¼‰å…¥ï¼Œä¸å¯åˆªé™¤ï¼‰
      - å»ºç«‹ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½
      - æ¯å€‹ stage é é¢æ•´åˆè¼¸å…¥ç®¡ç† + åŸ·è¡Œ + ç‰ˆæœ¬è¨˜éŒ„
      - å‰µå»ºä¸‰ç¨®å®‰å…¨å•Ÿå‹•è…³æœ¬ï¼ˆå®‰å…¨/å…§ç¶²/é–‹æ”¾æ¨¡å¼ï¼‰
      - é…ç½® .streamlit/config.toml å®‰å…¨é¸é …

  step_7_test:
    description: |
      æ¸¬è©¦è¦é»ï¼š
      - å¾è…³æœ¬æå– prompt â†’ ç·¨è¼¯ â†’ å„²å­˜è‰ç¨¿ â†’ è¼‰å…¥è‰ç¨¿ â†’ åˆªé™¤è‰ç¨¿
      - æ›´æ–°åˆ°è…³æœ¬ â†’ ç¢ºèª .py æª”æ¡ˆçœŸçš„è¢«ä¿®æ”¹
      - é‡æ•´ UI â†’ ç¢ºèªé¡¯ç¤ºçš„æ˜¯æ–°ç‰ˆ promptï¼ˆä¸æ˜¯ JSON å¿«å–çš„èˆŠç‰ˆï¼‰
      - å®Œæ•´é è¦½ â†’ ç¢ºèªå…§å®¹èˆ‡å¯¦éš›åŸ·è¡Œçš„ prompt ä¸€è‡´
      - åŸ·è¡Œ stage â†’ ç¢ºèªç”¨çš„æ˜¯æ–° prompt
      - ç‰ˆæœ¬å¿«ç…§ â†’ åˆ‡æ›ç‰ˆæœ¬ â†’ ç¢ºèªçµ„è£ä½¿ç”¨æ­£ç¢ºç‰ˆæœ¬
      - Baseline æ¸¬è©¦ï¼š
        - è¨­ç‚º Baseline â†’ ç¢ºèª baselines/ ç›®éŒ„æœ‰å°æ‡‰ JSON
        - ä¿®æ”¹ prompt â†’ Baseline æ¯”è¼ƒé¡¯ç¤ºã€Œâš ï¸ èˆ‡ Baseline ä¸åŒã€
        - å¾ Baseline é‚„åŸ â†’ ç¢ºèªè…³æœ¬å›å¾©åˆ° baseline ç‰ˆæœ¬
        - è‰ç¨¿è¨˜éŒ„ä¸­ Baseline ç½®é ‚ â†’ åªæœ‰è¼‰å…¥æŒ‰éˆ•ã€ç„¡åˆªé™¤æŒ‰éˆ•
      - è¼¸å…¥é©—è­‰æ¸¬è©¦ï¼š
        - ç¼ºå°‘åœ–ç‰‡ â†’ check_inputs() å›å‚³ ERROR
        - ç¼ºå°‘ Excel â†’ check_inputs() å›å‚³ WARNING
        - ç¼ºå°‘å‰ç½® Stage è¼¸å‡º â†’ check_inputs() å›å‚³ ERROR
        - Workflow ä¸­ run_input_check() æ­£ç¢ºå°å‡ºæ‰€æœ‰æª¢æŸ¥çµæœ

# ============================================================================
# å¿«é€Ÿé–‹å§‹ç¯„ä¾‹
# ============================================================================

quick_start_example:
  description: |
    ä»¥ä¸‹æ˜¯ä¸€å€‹æœ€å°åŒ–çš„ç¯„ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ­¤è¦æ ¼ã€‚
    å‡è¨­ä½ æœ‰ä¸€å€‹ 3 éšæ®µçš„å ±å‘Šç”Ÿæˆæµç¨‹ã€‚

  prompt_to_ai: |
    æˆ‘æœ‰ä¸€å€‹å ±å‘Šç”Ÿæˆå°ˆæ¡ˆï¼ŒåŒ…å« 3 å€‹éšæ®µï¼š

    Stage 1: æ•¸æ“šæ‘˜è¦ï¼ˆ1 å€‹ API å‘¼å«ï¼‰
      - è…³æœ¬: scripts/stage1_summary.py
      - Prompt è®Šæ•¸: PROMPT

    Stage 2: è©³ç´°åˆ†æï¼ˆ2 å€‹ API å‘¼å«ï¼‰
      - è…³æœ¬: scripts/stage2_analysis.py
      - Prompt è®Šæ•¸: PROMPT_SECTION_A, PROMPT_SECTION_B

    Stage 3: ç¸½çµï¼ˆ1 å€‹ API å‘¼å«ï¼‰
      - è…³æœ¬: scripts/stage3_conclusion.py
      - Prompt è®Šæ•¸: PROMPTï¼ˆå‹•æ…‹ï¼ŒåŒ…å«å‰é¢ stage çš„è¼¸å‡ºï¼‰

    è«‹æ ¹æ“šä»¥ä¸‹è¦æ ¼ç‚ºæˆ‘å»ºç«‹ Prompt ç®¡ç†ç³»çµ±ï¼š
    [è²¼ä¸Šæ­¤ YAML å…¨æ–‡]

    è«‹ç”Ÿæˆï¼š
    1. utils/prompt_manager.pyï¼ˆPromptManager é¡åˆ¥ï¼‰
    2. Streamlit UI çš„ Prompt ç·¨è¼¯å™¨çµ„ä»¶ï¼ˆå«é è¦½åŠŸèƒ½ï¼‰
    3. ç‰ˆæœ¬ç®¡ç†ç›¸é—œå‡½æ•¸
    4. ä¸‰ç¨®å®‰å…¨å•Ÿå‹•è…³æœ¬ï¼ˆstart_ui.bat, start_ui_network.bat, start_ui_public.batï¼‰
    5. .streamlit/config.toml é…ç½®æ–‡ä»¶

  expected_file_structure: |
    project/
    â”œâ”€â”€ scripts/
    â”‚   â”œâ”€â”€ stage1_summary.py        # PROMPT = """..."""
    â”‚   â”œâ”€â”€ stage2_analysis.py       # PROMPT_SECTION_A, PROMPT_SECTION_B
    â”‚   â””â”€â”€ stage3_conclusion.py     # å‹•æ…‹ prompt
    â”œâ”€â”€ utils/
    â”‚   â””â”€â”€ prompt_manager.py        # AI ç”Ÿæˆ
    â”œâ”€â”€ prompts/
    â”‚   â”œâ”€â”€ stage1_prompts.json      # å¿«å–
    â”‚   â”œâ”€â”€ stage2_prompts.json
    â”‚   â”œâ”€â”€ baselines/               # Baseline åŸºæº–ç‰ˆæœ¬ï¼ˆä¸å¯åˆªé™¤ï¼‰
    â”‚   â”œâ”€â”€ backups/                 # è‡ªå‹•å‚™ä»½
    â”‚   â””â”€â”€ drafts/                  # è‰ç¨¿ï¼ˆå¯åˆªé™¤ï¼‰
    â”œâ”€â”€ temp/
    â”‚   â”œâ”€â”€ versions/                # ç‰ˆæœ¬å¿«ç…§
    â”‚   â””â”€â”€ active_versions_*.json   # ä¸»è¦ç‰ˆæœ¬è¿½è¹¤
    â”œâ”€â”€ .streamlit/
    â”‚   â”œâ”€â”€ config.toml              # Streamlit å®‰å…¨é…ç½®
    â”‚   â””â”€â”€ secrets.toml             # å¯†ç¢¼ä¿è­·ï¼ˆå¯é¸ï¼‰
    â”œâ”€â”€ start_ui.bat                 # ğŸŸ¢ å®‰å…¨æ¨¡å¼å•Ÿå‹•ï¼ˆæ¨è–¦ï¼‰
    â”œâ”€â”€ start_ui_network.bat         # ğŸŸ¡ å…§ç¶²æ¨¡å¼å•Ÿå‹•
    â”œâ”€â”€ start_ui_public.bat          # ğŸ”´ é–‹æ”¾æ¨¡å¼å•Ÿå‹•ï¼ˆæœ‰è­¦å‘Šï¼‰
    â””â”€â”€ ui_app.py                    # Streamlit UI

# ============================================================================
# å¸¸è¦‹å•é¡Œ FAQ
# ============================================================================

faq:
  q1:
    question: "é€™å€‹ç³»çµ±å’Œç›´æ¥ç·¨è¼¯ .py æ–‡ä»¶æœ‰ä»€éº¼å·®åˆ¥ï¼Ÿ"
    answer: |
      ç›´æ¥ç·¨è¼¯ .pyï¼š
      - éœ€è¦é‡å•Ÿæ‡‰ç”¨æ‰èƒ½çœ‹åˆ°æ•ˆæœ
      - æ²’æœ‰ç‰ˆæœ¬æ­·å²ï¼ˆé™¤éç”¨ gitï¼‰
      - ç„¡æ³•å¿«é€Ÿ A/B æ¸¬è©¦

      ä½¿ç”¨æ­¤ç³»çµ±ï¼š
      - UI å³æ™‚é è¦½å’Œç·¨è¼¯
      - è‡ªå‹•ç‰ˆæœ¬å¿«ç…§
      - è‰ç¨¿æš«å­˜ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰
      - å¯ä»¥æ¯”è¼ƒä¸åŒç‰ˆæœ¬çš„è¼¸å‡ºçµæœ

  q2:
    question: "ç‚ºä»€éº¼ä¸æŠŠ Prompt å­˜åœ¨è³‡æ–™åº«ï¼Ÿ"
    answer: |
      è¨­è¨ˆåŸå‰‡æ˜¯ã€ŒPrompt å³ç¨‹å¼ç¢¼ã€ï¼š
      - Prompt æ˜¯æ¥­å‹™é‚è¼¯çš„ä¸€éƒ¨åˆ†ï¼Œæ‡‰è©²åœ¨ç‰ˆæœ¬æ§åˆ¶ï¼ˆGitï¼‰ä¸­
      - è³‡æ–™åº«æœƒè®“éƒ¨ç½²è®Šè¤‡é›œ
      - ç´”æª”æ¡ˆç³»çµ±æ›´å®¹æ˜“å‚™ä»½å’Œé·ç§»
      - JSON å¿«å–åªæ˜¯ç‚ºäº†åŠ é€Ÿè®€å–ï¼Œä¸æ˜¯ single source of truth

  q3:
    question: "å¯ä»¥ç”¨æ–¼é Streamlit çš„å°ˆæ¡ˆå—ï¼Ÿ"
    answer: |
      å¯ä»¥ï¼PromptManager é¡åˆ¥ä¸ä¾è³´ Streamlitã€‚
      ä½ å¯ä»¥ï¼š
      - ç”¨ CLI å·¥å…·èª¿ç”¨ PromptManager
      - æ•´åˆåˆ°å…¶ä»– Web æ¡†æ¶ï¼ˆFlaskã€FastAPIï¼‰
      - å¯«è‡ªå·±çš„ç·¨è¼¯å™¨ UI

  q4:
    question: "å¦‚ä½•è™•ç†å¤šèªè¨€ Promptï¼Ÿ"
    answer: |
      å»ºè­°æ“´å±•ç‚ºï¼š
      PROMPT_EN = """..."""
      PROMPT_ZH = """..."""

      ç„¶å¾Œåœ¨ PromptManager åŠ ä¸Šèªè¨€åƒæ•¸ã€‚

  q5:
    question: "ç‰ˆæœ¬å¿«ç…§æœƒä¸æœƒä½”ç”¨å¾ˆå¤šç©ºé–“ï¼Ÿ"
    answer: |
      Markdown æ–‡æœ¬æª”æ¡ˆå¾ˆå°ï¼ˆé€šå¸¸ < 100KBï¼‰ã€‚
      å³ä½¿ 100 å€‹ç‰ˆæœ¬ä¹Ÿåªæœ‰ 10MBã€‚
      å»ºè­°å®šæœŸæ¸…ç†èˆŠç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘ 20 å€‹ï¼‰ã€‚

# ============================================================================
# Streamlit å®‰å…¨å•Ÿå‹•é…ç½®
# ============================================================================

streamlit_security:
  description: |
    Streamlit é è¨­æœƒç›£è½æ‰€æœ‰ç¶²è·¯ä»‹é¢ï¼ˆ0.0.0.0ï¼‰ï¼Œé€™æ„å‘³è‘—ï¼š
    - æœƒç”¢ç”Ÿ Localã€Networkã€External ä¸‰å€‹ URL
    - External URL æœƒæš´éœ²åœ¨å…¬ç¶²ï¼Œä»»ä½•äººéƒ½å¯è¨ªå•
    - å¦‚æœæ²’æœ‰å¯†ç¢¼ä¿è­·ï¼Œç³»çµ±çš„æ‰€æœ‰åŠŸèƒ½éƒ½æœƒè¢«æš´éœ²

    æä¾›ä¸‰ç¨®å•Ÿå‹•æ¨¡å¼ï¼Œé©æ‡‰ä¸åŒçš„ä½¿ç”¨å ´æ™¯å’Œå®‰å…¨éœ€æ±‚ã€‚

  security_levels:
    safe_mode:
      name: "ğŸŸ¢ å®‰å…¨æ¨¡å¼ï¼ˆæ¨è–¦ï¼‰"
      description: "åƒ…æœ¬æ©Ÿè¨ªå•ï¼Œæœ€å®‰å…¨"
      script_name: "start_ui.bat"
      config: |
        # ç›£è½åœ°å€ï¼šlocalhost
        python -W ignore -m streamlit run ui_app.py --server.address localhost --server.headless true 2>nul
      features:
        - "åªæœ‰æœ¬æ©Ÿèƒ½è¨ªå•"
        - "ç„¡ External URL æš´éœ²"
        - "è³‡æ–™ä¸æœƒå¤–æ´©"
        - "é˜²æ­¢ä»–äººèª¤æ“ä½œ"
      use_cases:
        - "æ—¥å¸¸é–‹ç™¼å’Œä½¿ç”¨"
        - "åŒ…å«æ•æ„Ÿè³‡æ–™"
        - "å€‹äººå·¥ä½œç’°å¢ƒ"

    network_mode:
      name: "ğŸŸ¡ å€åŸŸç¶²è·¯æ¨¡å¼"
      description: "å…§ç¶²è¨ªå•ï¼Œä¸­ç­‰å®‰å…¨"
      script_name: "start_ui_network.bat"
      config: |
        # ç›£è½åœ°å€ï¼š0.0.0.0ï¼ˆæ‰€æœ‰ä»‹é¢ï¼‰
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul
      features:
        - "åŒç¶²è·¯çš„è¨­å‚™å¯è¨ªå•"
        - "æœ‰ Network URLï¼ˆå…§ç¶² IPï¼‰"
        - "ç„¡ External URLï¼ˆéœ€è·¯ç”±å™¨è¨­å®šï¼‰"
        - "åŒç¶²è·¯çš„äººå¯åŸ·è¡Œæ‰€æœ‰æ“ä½œ"
      use_cases:
        - "æ‰‹æ©Ÿ/å¹³æ¿æ¸¬è©¦ UI"
        - "å…§éƒ¨åœ˜éšŠå”ä½œ"
        - "å€åŸŸç¶²è·¯æ¼”ç¤º"
      warnings:
        - "ç¢ºèªç•¶å‰ç¶²è·¯æ˜¯å¦å¯ä¿¡"
        - "ä¸è¦åœ¨å…¬å…± Wi-Fi ä½¿ç”¨"
        - "ä½¿ç”¨å®Œç•¢ç«‹å³é—œé–‰"

    public_mode:
      name: "ğŸ”´ å®Œå…¨é–‹æ”¾æ¨¡å¼ï¼ˆé«˜é¢¨éšªï¼‰"
      description: "å…¨ä¸–ç•Œå¯è¨ªå•ï¼Œåƒ…æ¸¬è©¦ç”¨"
      script_name: "start_ui_public.bat"
      config: |
        # ç›£è½åœ°å€ï¼š0.0.0.0 + é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        @echo off
        echo ğŸš¨ è­¦å‘Šï¼šå®Œå…¨é–‹æ”¾æ¨¡å¼ ğŸš¨
        echo ä»»ä½•çŸ¥é“ä½  IP çš„äººéƒ½èƒ½è¨ªå•ç³»çµ±
        pause
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul
      features:
        - "ç”¢ç”Ÿ External URLï¼ˆå…¬ç¶² IPï¼‰"
        - "å…¨ä¸–ç•Œä»»ä½•äººéƒ½å¯è¨ªå•"
        - "å¯åŸ·è¡Œè…³æœ¬ã€æŸ¥çœ‹è³‡æ–™ã€æ¶ˆè€— API"
      use_cases:
        - "çŸ­æœŸæ¸¬è©¦ï¼ˆå¹¾åˆ†é˜å…§ï¼‰"
        - "å—æ§æ¼”ç¤ºç’°å¢ƒ"
      warnings:
        - "æ¥µé«˜å®‰å…¨é¢¨éšª"
        - "ä¸è¦é•·æ™‚é–“é‹è¡Œ"
        - "ä¸è¦åŒ…å«æ•æ„Ÿè³‡æ–™"
        - "å»ºè­°è¨­ç½®å¯†ç¢¼ä¿è­·"

  streamlit_config_file:
    path: ".streamlit/config.toml"
    description: "Streamlit é…ç½®æ–‡ä»¶ï¼Œè¨­å®šå®‰å…¨é¸é …"
    example: |
      [logger]
      level = "error"
      messageFormat = "%(asctime)s %(message)s"

      [client]
      showErrorDetails = false

      [runner]
      magicEnabled = true

      [server]
      # å®‰å…¨è¨­å®šï¼šåªå…è¨±æœ¬æ©Ÿè¨ªå•ï¼ˆç¦ç”¨å¤–éƒ¨è¨ªå•ï¼‰
      address = "localhost"
      port = 8501
      headless = true

      # é˜²æ­¢è·¨ç«™è«‹æ±‚å½é€ 
      enableCORS = false
      enableXsrfProtection = true

  startup_scripts:
    description: "ç‚ºä¸åŒå®‰å…¨æ¨¡å¼å‰µå»ºå°æ‡‰çš„å•Ÿå‹•è…³æœ¬"
    windows_batch_files:
      safe_mode: |
        @echo off
        REM å•Ÿå‹• Streamlit UI - å®‰å…¨æ¨¡å¼
        echo ===================================
        echo ç³»çµ±å•Ÿå‹•ä¸­...
        echo å®‰å…¨æ¨¡å¼ï¼šåƒ…æœ¬æ©Ÿè¨ªå•
        echo ===================================
        python -W ignore -m streamlit run ui_app.py --server.address localhost --server.headless true 2>nul

      network_mode: |
        @echo off
        REM å•Ÿå‹• Streamlit UI - å€åŸŸç¶²è·¯æ¨¡å¼
        echo ===================================
        echo âš ï¸ è­¦å‘Šï¼šå€åŸŸç¶²è·¯æ¨¡å¼
        echo åŒç¶²è·¯çš„äººéƒ½èƒ½è¨ªå•ï¼
        echo ===================================
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul

      public_mode: |
        @echo off
        REM å•Ÿå‹• Streamlit UI - å®Œå…¨é–‹æ”¾æ¨¡å¼
        echo ========================================
        echo  ğŸš¨ è­¦å‘Šï¼šå®Œå…¨é–‹æ”¾æ¨¡å¼ ğŸš¨
        echo ========================================
        echo.
        echo æ­¤æ¨¡å¼å°‡é–‹æ”¾ä»¥ä¸‹è¨ªå•æ–¹å¼ï¼š
        echo   âœ“ æœ¬æ©Ÿè¨ªå• (localhost)
        echo   âœ“ å€åŸŸç¶²è·¯è¨ªå• (Network URL)
        echo   âœ“ å¤–éƒ¨ç¶²è·¯è¨ªå• (External URL)
        echo.
        echo âš ï¸  ä»»ä½•çŸ¥é“ä½  IP çš„äººéƒ½èƒ½è¨ªå•ç³»çµ±
        echo âš ï¸  å¯ä»¥åŸ·è¡Œè…³æœ¬ã€æŸ¥çœ‹è³‡æ–™ã€æ¶ˆè€— API
        echo âš ï¸  å»ºè­°åƒ…åœ¨æ¸¬è©¦æˆ–æ¼”ç¤ºæ™‚ä½¿ç”¨
        echo.
        echo ========================================
        pause
        echo.
        echo æ­£åœ¨å•Ÿå‹•...
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul

    linux_shell_scripts:
      safe_mode: |
        #!/bin/bash
        # å•Ÿå‹• Streamlit UI - å®‰å…¨æ¨¡å¼
        echo "==================================="
        echo "ç³»çµ±å•Ÿå‹•ä¸­..."
        echo "å®‰å…¨æ¨¡å¼ï¼šåƒ…æœ¬æ©Ÿè¨ªå•"
        echo "==================================="
        python -W ignore -m streamlit run ui_app.py --server.address localhost --server.headless true 2>/dev/null

      network_mode: |
        #!/bin/bash
        # å•Ÿå‹• Streamlit UI - å€åŸŸç¶²è·¯æ¨¡å¼
        echo "==================================="
        echo "âš ï¸  è­¦å‘Šï¼šå€åŸŸç¶²è·¯æ¨¡å¼"
        echo "åŒç¶²è·¯çš„äººéƒ½èƒ½è¨ªå•ï¼"
        echo "==================================="
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>/dev/null

  verification:
    description: "å¦‚ä½•é©—è­‰ç•¶å‰çš„å®‰å…¨æ¨¡å¼"
    terminal_check:
      description: "æª¢æŸ¥çµ‚ç«¯è¼¸å‡ºçš„ URL"
      safe_mode_output: |
        âœ… Local URL: http://localhost:8501
        (åªæœ‰ 1 å€‹ URLï¼Œå®‰å…¨)

      network_mode_output: |
        âœ… Local URL:   http://localhost:8501
        âš ï¸ Network URL: http://192.168.1.100:8501
        (2 å€‹ URLï¼Œå…§ç¶²å¯è¨ªå•)

      public_mode_output: |
        âœ… Local URL:    http://localhost:8501
        âš ï¸ Network URL:  http://192.168.1.100:8501
        ğŸš¨ External URL: http://27.247.35.9:8501  â† å±éšªï¼å…¨ä¸–ç•Œå¯è¨ªå•
        (3 å€‹ URLï¼Œå®Œå…¨é–‹æ”¾)

    netstat_check:
      description: "ä½¿ç”¨ netstat å‘½ä»¤æª¢æŸ¥ç›£è½ç‹€æ…‹"
      command: "netstat -ano | findstr :8501"
      safe_mode_output: |
        TCP    127.0.0.1:8501    0.0.0.0:0    LISTENING
        (åªç›£è½ localhostï¼Œå®‰å…¨)

      public_mode_output: |
        TCP    0.0.0.0:8501      0.0.0.0:0    LISTENING
        (ç›£è½æ‰€æœ‰ IPï¼Œé–‹æ”¾)

  best_practices:
    - "é è¨­ä½¿ç”¨å®‰å…¨æ¨¡å¼ï¼ˆstart_ui.batï¼‰"
    - "åªåœ¨éœ€è¦æ™‚æ‰ä½¿ç”¨ç¶²è·¯/é–‹æ”¾æ¨¡å¼"
    - "ä½¿ç”¨å®Œç•¢ç«‹å³é—œé–‰ï¼ˆCtrl+Cï¼‰"
    - "é–‹æ”¾æ¨¡å¼ä¸è¦è¶…é 10 åˆ†é˜"
    - "å¦‚éœ€é ç«¯è¨ªå•ï¼Œä½¿ç”¨ Streamlit Cloud + å¯†ç¢¼ä¿è­·æˆ– VPN"
    - "å®šæœŸæª¢æŸ¥ .env æ˜¯å¦åœ¨ .gitignore ä¸­"
    - "åœ¨ README ä¸­èªªæ˜å®‰å…¨å•Ÿå‹•æ–¹å¼"

  remote_access_alternatives:
    description: "å¦‚æœéœ€è¦é ç«¯è¨ªå•ï¼Œä¸è¦ä½¿ç”¨é–‹æ”¾æ¨¡å¼ï¼Œæ”¹ç”¨ä»¥ä¸‹æ–¹æ¡ˆ"
    options:
      - name: "Streamlit Cloud + å¯†ç¢¼ä¿è­·"
        description: "éƒ¨ç½²åˆ° share.streamlit.ioï¼Œè¨­ç½®å¯†ç¢¼"
        pros: ["å…è²»", "HTTPS åŠ å¯†", "24/7 é‹è¡Œ", "å…§å»ºèªè­‰"]
        cons: ["è³‡æ–™åœ¨é›²ç«¯", "å…è²»ç‰ˆæœ‰è³‡æºé™åˆ¶"]

      - name: "VPN è¨ªå•"
        description: "ä½¿ç”¨ Tailscale æˆ– ZeroTier"
        pros: ["é»å°é»åŠ å¯†", "åªæœ‰æˆæ¬Šè¨­å‚™å¯è¨ªå•", "å…è²»ï¼ˆå€‹äººä½¿ç”¨ï¼‰"]
        cons: ["éœ€è¦å®‰è£è»Ÿé«”", "ç¨å¾®è¤‡é›œ"]

      - name: "SSH éš§é“"
        description: "ssh -L 8501:localhost:8501 user@server"
        pros: ["SSH åŠ å¯†", "ä¸éœ€é¡å¤–è»Ÿé«”", "é©åˆè‡¨æ™‚è¨ªå•"]
        cons: ["éœ€è¦ SSH å­˜å–æ¬Š", "é€£ç·šæ–·é–‹å°±ç„¡æ³•è¨ªå•"]

# ============================================================================
# æ•´åˆæŒ‡å—
# ============================================================================

integration_guide:
  prerequisites:
    python_version: ">=3.10"
    required_packages:
      - streamlit
      - pathlib (æ¨™æº–åº«)
      - json (æ¨™æº–åº«)
      - shutil (æ¨™æº–åº«)
      - re (æ¨™æº–åº«)
      - datetime (æ¨™æº–åº«)

  quick_start:
    description: "å¿«é€Ÿæ•´åˆ Prompt ç®¡ç†ç³»çµ±åˆ°ç¾æœ‰å°ˆæ¡ˆ"
    steps:
      - "å»ºç«‹ utils/prompt_manager.py æ¨¡çµ„"
      - "å»ºç«‹ utils/data_formatter.py å…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„"
      - "å»ºç«‹ prompts/ ç›®éŒ„çµæ§‹"
      - "æƒæ Stage è…³æœ¬æå– PROMPT å¸¸æ•¸"
      - "æ•´åˆåˆ° Streamlit UIï¼ˆæˆ–å»ºç«‹æ–° UIï¼‰"
      - "ï¼ˆå¯é¸ï¼‰æ•´åˆç‰ˆæœ¬ç®¡ç†åŠŸèƒ½"

  integration_methods:
    - name: "å®Œæ•´æ•´åˆ"
      description: "é©åˆå¤šéšæ®µ AI Workflow å°ˆæ¡ˆ"
      includes: ["PromptManager", "VersionManager", "Streamlit UI", "å…±ç”¨è³‡æ–™æ ¼å¼åŒ–"]

    - name: "åŸºç¤æ•´åˆ"
      description: "åªéœ€è¦ Prompt ç·¨è¼¯åŠŸèƒ½"
      includes: ["PromptManager", "Streamlit UI"]

    - name: "æœ€å°æ•´åˆ"
      description: "åªéœ€è¦ Prompt æå–å’Œç®¡ç†"
      includes: ["PromptManager"]

  detailed_instructions:
    description: "è©³ç´°æ•´åˆæ­¥é©Ÿè«‹åƒè€ƒ AI_INTEGRATION_PROMPT.md"
    files:
      - "AI_INTEGRATION_PROMPT.md - å¯ç›´æ¥è¤‡è£½çµ¦ AI çš„å®Œæ•´æ•´åˆæŒ‡ä»¤"
      - "README.md - çµ¦äººé¡é–±è®€çš„ä½¿ç”¨æ–‡æª”"
      - "README_PROMPT_SPEC.md - å®Œæ•´è¦æ ¼èªªæ˜"

# ============================================================================
# æˆæ¬Šèˆ‡ä½¿ç”¨
# ============================================================================

license:
  description: |
    æœ¬è¦æ ¼æ–‡æª”å¯è‡ªç”±ä½¿ç”¨æ–¼ä»»ä½•å°ˆæ¡ˆï¼ˆå•†æ¥­æˆ–éå•†æ¥­ï¼‰ã€‚

    å»ºè­°åœ¨ä½¿ç”¨æ™‚ï¼š
    1. æ ¹æ“šä½ çš„å°ˆæ¡ˆéœ€æ±‚èª¿æ•´ç´°ç¯€
    2. ä¿ç•™æ ¸å¿ƒè¨­è¨ˆåŸå‰‡
    3. å¦‚æœå°è¦æ ¼æœ‰æ”¹é€²å»ºè­°ï¼Œæ­¡è¿å›é¥‹

  attribution: |
    åŸºæ–¼ã€Œå°ç¾ ETF æ·¨æµé‡åˆ†ææœˆå ±ã€å°ˆæ¡ˆçš„å¯¦è¸ç¶“é©—ç·¨å¯«ã€‚
