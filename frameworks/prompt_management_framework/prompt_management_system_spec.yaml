# ============================================================================
# Prompt Management System Specification
# ç”¨æ–¼ AI Workflow çš„ Prompt ç‰ˆæœ¬ç®¡ç†ç³»çµ±è¨­è¨ˆè¦æ ¼
# ============================================================================
# ğŸ“– ä½¿ç”¨æ–¹å¼ï¼š
#   å°‡æ­¤ YAML çš„å…§å®¹ä½œç‚º prompt æä¾›çµ¦ AIï¼ˆClaudeã€GPTã€Gemini ç­‰ï¼‰ï¼Œ
#   AI å³å¯æ ¹æ“šæ­¤è¦æ ¼ç‚ºä½ çš„å°ˆæ¡ˆå»ºæ§‹ä¸€å¥—å®Œæ•´çš„ Prompt ç®¡ç†ç³»çµ±ã€‚
#
# ğŸ¯ é©ç”¨å ´æ™¯ï¼š
#   - å¤šéšæ®µ AI Workflowï¼ˆå¦‚å ±å‘Šç”Ÿæˆã€å…§å®¹åˆ†æã€æ•¸æ“šè™•ç†ï¼‰
#   - éœ€è¦é »ç¹èª¿æ•´ Prompt çš„å°ˆæ¡ˆ
#   - éœ€è¦ç‰ˆæœ¬ç®¡ç†å’Œ A/B æ¸¬è©¦çš„å ´æ™¯
#
# ğŸ“¦ åƒè€ƒå¯¦ä½œï¼š
#   æœ¬è¦æ ¼åŸºæ–¼ã€Œå°ç¾ ETF æ·¨æµé‡åˆ†ææœˆå ±ã€å°ˆæ¡ˆçš„å¯¦éš›ç¶“é©—ç·¨å¯«ï¼Œ
#   å·²åœ¨ç”Ÿç”¢ç’°å¢ƒé©—è­‰å¯è¡Œæ€§ã€‚
#
# ğŸ”– ç‰ˆæœ¬ï¼šv1.0 (2026-02-09)
# ============================================================================

system_overview:
  name: "AI Workflow Prompt Management System"
  purpose: |
    åœ¨å¤šéšæ®µ AI workflow ä¸­ï¼Œæ¯å€‹éšæ®µ (stage) éƒ½æœƒå‘¼å« LLM API ä¸¦ä½¿ç”¨ promptã€‚
    æœ¬ç³»çµ±æä¾›ï¼š
    1. å¾ Python è…³æœ¬ä¸­è‡ªå‹•æå– prompt å¸¸æ•¸
    2. åœ¨ Streamlit UI ä¸­å³æ™‚ç·¨è¼¯ prompt
    3. è‰ç¨¿æš«å­˜ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰èˆ‡æ­£å¼å¯«å›è…³æœ¬ï¼ˆå½±éŸ¿åŸ·è¡Œï¼‰
    4. æ¯æ¬¡ä¿®æ”¹è…³æœ¬å‰è‡ªå‹•å‚™ä»½
    5. è¼¸å‡ºç‰ˆæœ¬ç®¡ç†ï¼ˆæ¯æ¬¡åŸ·è¡Œå¾Œå¿«ç…§ï¼Œå¯åˆ‡æ›ä¸»è¦ç‰ˆæœ¬ï¼‰
  tech_stack:
    language: Python 3.10+
    ui_framework: Streamlit
    storage: ç´”æª”æ¡ˆç³»çµ±ï¼ˆJSON + Markdownï¼‰ï¼Œç„¡éœ€è³‡æ–™åº«
    dependencies:
      - streamlit   # UI æ¡†æ¶
      - pathlib     # è·¯å¾‘æ“ä½œï¼ˆæ¨™æº–åº«ï¼‰
      - json        # JSON åºåˆ—åŒ–ï¼ˆæ¨™æº–åº«ï¼‰
      - shutil      # æª”æ¡ˆè¤‡è£½/å‚™ä»½ï¼ˆæ¨™æº–åº«ï¼‰
      - re          # æ­£å‰‡è¡¨é”å¼æå– promptï¼ˆæ¨™æº–åº«ï¼‰
      - datetime    # æ™‚é–“æˆ³è¨˜ï¼ˆæ¨™æº–åº«ï¼‰

# ============================================================================
# æ ¸å¿ƒæ¶æ§‹
# ============================================================================

architecture:
  design_principle: |
    ã€ŒPrompt å³ç¨‹å¼ç¢¼ã€â€” prompt ç›´æ¥å¯«åœ¨ .py è…³æœ¬ä¸­ä½œç‚º module-level å¸¸æ•¸ï¼Œ
    æ˜¯ single source of truthã€‚JSON å¿«å–å’Œè‰ç¨¿åªæ˜¯è¼”åŠ©å±¤ã€‚

    è³‡æ–™æµï¼š
    .py è…³æœ¬ (PROMPT = """...""")
        â†“ extract (regex)
    JSON å¿«å– (prompts/stageN_prompts.json)
        â†“ load
    UI session_state (å³æ™‚ç·¨è¼¯)
        â†“ save_draft â†’ JSON è‰ç¨¿ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰
        â†“ update_script â†’ å¯«å› .pyï¼ˆå½±éŸ¿åŸ·è¡Œï¼‰

  components:
    - name: PromptManager
      role: å¾Œç«¯æ ¸å¿ƒé¡åˆ¥
      responsibilities:
        - å¾ .py è…³æœ¬æå– promptï¼ˆregexï¼‰
        - è®€å–/å¯«å…¥ JSON å¿«å–
        - å°‡ä¿®æ”¹å¯«å› .py è…³æœ¬
        - è‡ªå‹•å‚™ä»½ï¼ˆä¿®æ”¹å‰ï¼‰
        - åˆ—å‡º/é‚„åŸå‚™ä»½

    - name: UI Prompt Editor (Streamlit)
      role: å‰ç«¯äº’å‹•ä»‹é¢
      responsibilities:
        - é¡¯ç¤ºå„ stage çš„ promptï¼ˆtext_area ç·¨è¼¯å™¨ï¼‰
        - é¡¯ç¤ºå­—æ•¸ã€è¡Œæ•¸ã€æ˜¯å¦å·²ä¿®æ”¹
        - æš«å­˜è‰ç¨¿ï¼ˆJSONï¼‰
        - è¼‰å…¥è‰ç¨¿
        - æ›´æ–°åˆ°è…³æœ¬
        - å¾è…³æœ¬é‡æ–°è¼‰å…¥

    - name: Version Manager
      role: è¼¸å‡ºç‰ˆæœ¬æ§åˆ¶
      responsibilities:
        - æ¯æ¬¡æˆåŠŸåŸ·è¡Œå¾Œè‡ªå‹•å¿«ç…§è¼¸å‡º
        - ç®¡ç† active versionï¼ˆè¿½è¹¤å“ªå€‹ç‰ˆæœ¬æ˜¯ç•¶å‰ä½¿ç”¨çš„ï¼‰
        - åˆ‡æ›/åˆªé™¤ç‰ˆæœ¬
        - æœ€çµ‚çµ„è£æ™‚å¯é¸æ“‡å„ stage çš„ç‰¹å®šç‰ˆæœ¬

# ============================================================================
# ç›®éŒ„çµæ§‹
# ============================================================================

directory_structure:
  description: |
    ä»¥ä¸‹ç‚º prompt ç®¡ç†ç›¸é—œçš„ç›®éŒ„çµæ§‹ã€‚
    {project_root} æ˜¯ä½ çš„å°ˆæ¡ˆæ ¹ç›®éŒ„ã€‚
  layout:
    prompts/: "JSON å¿«å–ï¼Œæ¯å€‹ stage ä¸€å€‹æª”æ¡ˆ"
    prompts/backups/: "è‡ªå‹•å‚™ä»½ï¼ˆ.json å’Œ .pyï¼‰ï¼Œä¿®æ”¹å‰è‡ªå‹•å»ºç«‹"
    prompts/drafts/: "UI æš«å­˜è‰ç¨¿ï¼Œä¸å½±éŸ¿å¯¦éš›åŸ·è¡Œ"
    temp/versions/{YYYYMM}/stage{N}/: "è¼¸å‡ºç‰ˆæœ¬å¿«ç…§"
    temp/active_versions_{YYYYMM}.json: "è¨˜éŒ„å„ stage çš„ä¸»è¦ç‰ˆæœ¬ ID"
  file_naming:
    json_cache: "stage{N}_prompts.json"
    draft: "stage{N}_{YYYYMMDD_HHMMSS}.json"
    backup_json: "stage{N}_prompts_{YYYYMMDD_HHMMSS}.json"
    backup_script: "{script_stem}_{YYYYMMDD_HHMMSS}.py"
    version_snapshot: "v{YYYYMMDD_HHMMSS}.md"

# ============================================================================
# å…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¶æ§‹ï¼ˆPreview Consistency Patternï¼‰
# ============================================================================

shared_formatters:
  design_principle: |
    â­ **æ ¸å¿ƒç†å¿µ**ï¼šé è¦½èˆ‡å¯¦éš›åŸ·è¡Œä½¿ç”¨ç›¸åŒçš„ç¨‹å¼ç¢¼ï¼Œç¢ºä¿ 100% ä¸€è‡´æ€§

    å•é¡ŒèƒŒæ™¯ï¼š
    - å¯¦éš›åŸ·è¡Œï¼šStage è…³æœ¬æœ‰è‡ªå·±çš„è³‡æ–™æ ¼å¼åŒ–é‚è¼¯
    - UI é è¦½ï¼šUI ä¸­é‡æ–°å¯¦ä½œç›¸åŒçš„é‚è¼¯ä¾†ç”Ÿæˆé è¦½
    - çµæœï¼šå…©ä»½ä»£ç¢¼ï¼Œå®¹æ˜“ä¸ä¸€è‡´ âŒ

    è§£æ±ºæ–¹æ¡ˆï¼š
    - å‰µå»ºå…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„ï¼ˆutils/data_formatter.pyï¼‰
    - Stage è…³æœ¬å’Œ UI é è¦½éƒ½ä½¿ç”¨ç›¸åŒçš„å‡½æ•¸
    - å–®ä¸€ä¾†æºåŸå‰‡ï¼ˆSingle Source of Truthï¼‰âœ…

  architecture:
    pattern: |
      å¯¦éš›åŸ·è¡Œ Stage è…³æœ¬ â”€â”€â”
                           â”œâ”€â”€> å…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„ (utils/data_formatter.py)
      UI é è¦½åŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  implementation:
    step_1_create_shared_module:
      file: "utils/data_formatter.py"
      description: |
        å‰µå»ºå…±ç”¨è³‡æ–™æ ¼å¼åŒ–æ¨¡çµ„ï¼ŒåŒ…å«æ‰€æœ‰è³‡æ–™è®€å–å’Œæ ¼å¼åŒ–é‚è¼¯ã€‚
        æ¯å€‹å‡½æ•¸å°æ‡‰ä¸€ç¨®è³‡æ–™æ ¼å¼åŒ–éœ€æ±‚ã€‚

      design_principles:
        - "å‡½æ•¸å‘½åæ¸…æ™°ï¼ˆload_*, format_*, calculate_*ï¼‰"
        - "å®Œæ•´çš„ docstringï¼ˆåŒ…å« Args, Returns, Used byï¼‰"
        - "ä¸€è‡´çš„éŒ¯èª¤è™•ç†"
        - "å–®ä¸€è·è²¬åŸå‰‡"

      example: |
        ```python
        # utils/data_formatter.py

        def load_us_etf_data(excel_file, year, month):
            """
            å¾ Excel è®€å–æŒ‡å®šæœˆä»½çš„æ•¸æ“šï¼Œè½‰ç‚º markdown è¡¨æ ¼

            Args:
                excel_file: Path æˆ– strï¼ŒExcel æª”æ¡ˆè·¯å¾‘
                year: int, å¹´ä»½
                month: int, æœˆä»½

            Returns:
                str: æ ¼å¼åŒ–çš„ markdown è¡¨æ ¼ï¼Œæˆ–éŒ¯èª¤è¨Šæ¯

            Used by:
                - scripts/stages/stage1_xxx.py
                - ui_app.py (generate_dynamic_variables, Stage 1)
            """
            try:
                df = pd.read_excel(excel_file, sheet_name=f"{year}å¹´{month}æœˆæ•¸æ“š")
                # æ ¼å¼åŒ–é‚è¼¯...
                return formatted_table
            except Exception as e:
                return f"\n[è­¦å‘Š] ç„¡æ³•è®€å–æ•¸æ“š: {str(e)}\n"
        ```

    step_2_refactor_stage_scripts:
      description: |
        é‡æ§‹ Stage è…³æœ¬ï¼Œç§»é™¤æœ¬åœ°çš„æ ¼å¼åŒ–é‚è¼¯ï¼Œæ”¹ç”¨å…±ç”¨å‡½æ•¸ã€‚

      before: |
        ```python
        # scripts/stages/stage1_xxx.py

        def load_data(file, year, month):  # âŒ é‡è¤‡çš„é‚è¼¯
            df = pd.read_excel(file)
            # ... å¤§é‡æ ¼å¼åŒ–é‚è¼¯ ...
            return table

        def main(year, month):
            data = load_data(file, year, month)
        ```

      after: |
        ```python
        # scripts/stages/stage1_xxx.py

        from utils.data_formatter import load_us_etf_data  # âœ… ä½¿ç”¨å…±ç”¨å‡½æ•¸

        def main(year, month):
            # ç›´æ¥ä½¿ç”¨å…±ç”¨å‡½æ•¸
            data = load_us_etf_data(file, year, month)
        ```

    step_3_ui_preview_integration:
      description: |
        UI é è¦½é‚è¼¯ä½¿ç”¨ç›¸åŒçš„å…±ç”¨å‡½æ•¸ï¼Œç¢ºä¿èˆ‡å¯¦éš›åŸ·è¡Œä¸€è‡´ã€‚

      before: |
        ```python
        # ui_app.py

        def generate_dynamic_variables(stage_num, year, month):
            if stage_num == 1:
                # âŒ è‡ªè¡Œå¯¦ä½œï¼Œå¯èƒ½èˆ‡å¯¦éš›åŸ·è¡Œä¸åŒ
                df = pd.read_excel(file)
                table = df.to_markdown()  # æ ¼å¼å¯èƒ½ä¸åŒ
        ```

      after: |
        ```python
        # ui_app.py

        from utils.data_formatter import load_us_etf_data  # âœ… ä½¿ç”¨ç›¸åŒçš„å…±ç”¨å‡½æ•¸

        def generate_dynamic_variables(stage_num, year, month):
            if stage_num == 1:
                # âœ… ä½¿ç”¨å…±ç”¨å‡½æ•¸ï¼Œç¢ºä¿èˆ‡å¯¦éš›åŸ·è¡Œç›¸åŒ
                data = load_us_etf_data(file, year, month)
                dynamic_vars["{{data}}"] = data
        ```

  benefits:
    - "âœ… ä¿è­‰ä¸€è‡´æ€§ï¼šé è¦½èˆ‡å¯¦éš›åŸ·è¡Œä½¿ç”¨å®Œå…¨ç›¸åŒçš„ä»£ç¢¼"
    - "âœ… é¿å…é‡è¤‡ï¼šå–®ä¸€ä¾†æºåŸå‰‡ï¼ˆSingle Source of Truthï¼‰"
    - "âœ… æ˜“æ–¼ç¶­è­·ï¼šä¿®æ”¹é‚è¼¯åªéœ€è¦æ”¹ä¸€è™•"
    - "âœ… é™ä½éŒ¯èª¤ï¼šæ¸›å°‘å› è¤‡è£½è²¼ä¸Šå°è‡´çš„ä¸ä¸€è‡´"
    - "âœ… æ˜“æ–¼æ¸¬è©¦ï¼šåªéœ€æ¸¬è©¦å…±ç”¨å‡½æ•¸ä¸€æ¬¡"

  best_practices:
    function_naming:
      - "ä½¿ç”¨æ¸…æ™°çš„å‹•è© + åè©ï¼šload_*, format_*, calculate_*"
      - "åç¨±åæ˜ åŠŸèƒ½ï¼šload_us_etf_data è€Œé get_data"

    docstring_requirements: |
      å¿…é ˆåŒ…å«ï¼š
      - ç°¡çŸ­æè¿°
      - Args: æ‰€æœ‰åƒæ•¸åŠèªªæ˜
      - Returns: è¿”å›å€¼èªªæ˜
      - Used by: ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆå¹«åŠ©è¿½è¹¤å½±éŸ¿ç¯„åœï¼‰

    error_handling:
      pattern: |
        try:
            # ä¸»é‚è¼¯
            return formatted_data
        except Exception as e:
            # çµ±ä¸€çš„éŒ¯èª¤è¨Šæ¯æ ¼å¼
            return f"\n[è­¦å‘Š] ç„¡æ³•è®€å– {source}: {str(e)}\n"

    testing:
      - "ç‚ºå…±ç”¨å‡½æ•¸æ’°å¯«å–®å…ƒæ¸¬è©¦"
      - "æ¸¬è©¦é è¦½èˆ‡å¯¦éš›åŸ·è¡Œçš„è¼¸å‡ºä¸€è‡´æ€§"
      - "ä½¿ç”¨ pytest æˆ– unittest æ¡†æ¶"

    version_control:
      - "ä¿®æ”¹å…±ç”¨å‡½æ•¸æ™‚ç¢ºä¿å‘ä¸‹å…¼å®¹"
      - "æˆ–åŒæ™‚æ›´æ–°æ‰€æœ‰ä½¿ç”¨è€…"
      - "è¨˜éŒ„ä¿®æ”¹åŸå› ï¼ˆcommit messageï¼‰"

  common_pitfalls:
    - name: "éƒ¨åˆ†ä½¿ç”¨å…±ç”¨å‡½æ•¸"
      problem: "æŸäº› Stage ä½¿ç”¨å…±ç”¨å‡½æ•¸ï¼ŒæŸäº›è‡ªå·±å¯¦ä½œ"
      solution: "æ‰€æœ‰æ ¼å¼åŒ–é‚è¼¯éƒ½ä½¿ç”¨å…±ç”¨å‡½æ•¸"

    - name: "ä¿®æ”¹å…±ç”¨å‡½æ•¸å¾Œæœªæ›´æ–°æ‰€æœ‰ä½¿ç”¨è€…"
      problem: "ä¿®æ”¹å‡½æ•¸å¾Œå¿˜è¨˜æ¸¬è©¦æ‰€æœ‰ Stage"
      solution: "å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦ï¼Œä¿®æ”¹å¾Œè‡ªå‹•é©—è­‰æ‰€æœ‰ä½¿ç”¨è€…"

    - name: "åœ¨å…±ç”¨å‡½æ•¸ä¸­æ··å…¥ç‰¹å®š Stage é‚è¼¯"
      problem: "å‡½æ•¸ä¸­ä½¿ç”¨ if stage_num == 1 ç­‰æ¢ä»¶åˆ†æ”¯"
      solution: "æ¯å€‹å‡½æ•¸å°ˆæ³¨å–®ä¸€è·è²¬ï¼ŒStage ç‰¹å®šé‚è¼¯åœ¨ Stage è…³æœ¬ä¸­è™•ç†"

  verification:
    method_1_direct_comparison:
      description: "ç›´æ¥æ¯”å° Stage åŸ·è¡Œè¼¸å‡ºèˆ‡ UI é è¦½å…§å®¹"
      steps:
        - "åŸ·è¡Œ Stage è…³æœ¬ï¼Œç”Ÿæˆè¼¸å‡ºæª”æ¡ˆ"
        - "åœ¨ UI ä¸­æŸ¥çœ‹é è¦½å…§å®¹"
        - "äººå·¥æ¯”å°å…©è€…æ˜¯å¦ä¸€è‡´"

    method_2_unit_testing:
      description: "ä½¿ç”¨å–®å…ƒæ¸¬è©¦é©—è­‰ä¸€è‡´æ€§"
      example: |
        ```python
        def test_preview_matches_actual():
            # ä½¿ç”¨ç›¸åŒåƒæ•¸å‘¼å«å…±ç”¨å‡½æ•¸
            actual = load_us_etf_data(test_file, 2025, 12)

            # æ¨¡æ“¬ UI é è¦½é‚è¼¯
            preview = generate_dynamic_variables(1, 2025, 12, "202512")

            # é©—è­‰ä¸€è‡´æ€§
            assert preview["{{data}}"] in actual
        ```

    method_3_check_imports:
      description: "æª¢æŸ¥æ˜¯å¦æ‰€æœ‰åœ°æ–¹éƒ½ä½¿ç”¨å…±ç”¨å‡½æ•¸"
      commands:
        - "grep -r 'def load_.*_data' scripts/stages/  # æ‡‰è©²åªåœ¨ utils/data_formatter.py ä¸­æ‰¾åˆ°"
        - "grep -r 'from utils.data_formatter import' scripts/stages/"
        - "grep 'from utils.data_formatter import' ui_app.py"

# ============================================================================
# PromptManager é¡åˆ¥è¨­è¨ˆ
# ============================================================================

prompt_manager_class:
  description: |
    æ ¸å¿ƒå¾Œç«¯é¡åˆ¥ï¼Œè² è²¬ prompt çš„è®€å–ã€æå–ã€å„²å­˜ã€å¯«å›ã€‚
    ä¸ä¾è³´ Streamlitï¼Œå¯ç¨ç«‹ä½¿ç”¨ã€‚

  constructor:
    parameters: []
    initialization:
      - "æ¨å° project_rootï¼ˆé€šå¸¸ Path(__file__).parent.parentï¼‰"
      - "å»ºç«‹ prompts_dir å’Œ backup_dir"
      - "å®šç¾© prompt_files æ˜ å°„è¡¨ï¼šstage åç¨± â†’ {json è·¯å¾‘, è…³æœ¬è·¯å¾‘}"

  prompt_files_mapping:
    description: |
      å­—å…¸ï¼Œkey ç‚º stage çš„äººé¡å¯è®€åç¨±ï¼Œvalue åŒ…å«ï¼š
      - file: JSON å¿«å–è·¯å¾‘
      - script: å°æ‡‰çš„ Python è…³æœ¬è·¯å¾‘
    example: |
      self.prompt_files = {
          "Stage 1ï¼šXXX": {
              "file": self.prompts_dir / "stage1_prompts.json",
              "script": self.project_root / "scripts" / "stages" / "stage1_xxx.py"
          },
          # ...ä¾æ­¤é¡æ¨
      }

  methods:
    extract_prompts_from_script:
      purpose: "å¾ Python è…³æœ¬ä¸­ç”¨ regex æå– prompt å¸¸æ•¸"
      input: "script_path (Path)"
      output: "dict[str, str]  # {è®Šæ•¸å: prompt å…§å®¹}"
      regex_patterns:
        pattern_module_level_vars: |
          # åŒ¹é… PROMPT = """...""" æˆ– PROMPT_XXX = """..."""
          r'(PROMPT(?:_\w+)?)\s*=\s*"""(.*?)"""'
          # ä½¿ç”¨ re.DOTALL ä½¿ . åŒ¹é…æ›è¡Œ
        pattern_dict_format: |
          # åŒ¹é… PROMPTS = {"key": """...""", ...}
          # å…ˆæ‰¾å¤–å±¤ dictï¼Œå†æå–å„ key-value
          å¤–å±¤: r'PROMPTS\s*=\s*\{(.*?)\n\}'
          å…§å±¤: r'"(\w+)":\s*"""(.*?)"""'
      important_notes:
        - "regex å¿…é ˆç”¨ re.DOTALL flagï¼Œå› ç‚º prompt è·¨å¤šè¡Œ"
        - "PROMPT(?:_\\w+)? åŒæ™‚åŒ¹é… PROMPT å’Œ PROMPT_XXX"
        - "ç„¡æ³•æå–å‹•æ…‹ f-string promptï¼ˆå¦‚å«æœ‰å‰ç½® stage è¼¸å‡ºçš„ promptï¼‰"
        - "å°å‹•æ…‹ prompt çš„ stageï¼Œæ‡‰åœ¨ UI è¨­ prompt_key=None ä¸¦é¡¯ç¤ºèªªæ˜"

    get_prompts:
      purpose: "å–å¾—æŒ‡å®š stage çš„æ‰€æœ‰ prompt"
      logic: |
        1. å¦‚æœ JSON å¿«å–å­˜åœ¨ â†’ å¾ JSON è®€å–ï¼ˆå„ªå…ˆï¼‰
        2. å¦å‰‡ â†’ å¾è…³æœ¬ regex æå–
        3. æå–æˆåŠŸå¾Œè‡ªå‹•å„²å­˜ JSON å¿«å–ï¼ˆä¸‹æ¬¡åŠ é€Ÿï¼‰
      input: "report_type (str) â€” prompt_files çš„ key"
      output: "dict[str, str]"

    save_prompts:
      purpose: "å„²å­˜ prompt åˆ° JSON å¿«å–æª”"
      logic: |
        1. å¦‚æœå¿«å–æª”å·²å­˜åœ¨ä¸” create_backup=True â†’ è¤‡è£½ç‚ºå‚™ä»½
        2. å¯«å…¥æ–°çš„ JSON
      input: "report_type, prompts (dict), create_backup=True"

    update_script_prompts:
      purpose: "å°‡ä¿®æ”¹å¾Œçš„ prompt å¯«å› .py è…³æœ¬ï¼ˆå½±éŸ¿å¯¦éš›åŸ·è¡Œï¼‰"
      logic: |
        1. è®€å–è…³æœ¬å…§å®¹
        2. å»ºç«‹è…³æœ¬å‚™ä»½ï¼ˆ.py å‚™ä»½åˆ° backups/ï¼‰
        3. åµæ¸¬è…³æœ¬æ ¼å¼ï¼š
           a. module-level è®Šæ•¸ (PROMPT = """...""")
           b. å­—å…¸æ ¼å¼ (PROMPTS = {"key": """..."""})
        4. ç”¨ regex æ›¿æ›å°æ‡‰çš„ prompt å…§å®¹
        5. å¯«å›è…³æœ¬
      important_notes:
        - "åµæ¸¬ regex å’Œæå– regex å¿…é ˆä¸€è‡´ï¼ˆéƒ½è¦æ”¯æ´ PROMPT å’Œ PROMPT_XXXï¼‰"
        - "æ›¿æ›å‰ä¸€å®šè¦å‚™ä»½ï¼Œå› ç‚ºé€™æ˜¯ä¸å¯é€†æ“ä½œ"
        - "æ›¿æ›æ ¼å¼ï¼š{var_name} = \"\"\"\\n{new_content}\\n\"\"\""

    list_backups:
      purpose: "åˆ—å‡ºæŒ‡å®š stage çš„æ‰€æœ‰å‚™ä»½"
      output: "list[{file, time}]ï¼ŒæŒ‰æ™‚é–“å€’åº"

    restore_from_backup:
      purpose: "å¾å‚™ä»½é‚„åŸ JSON å¿«å–"

# ============================================================================
# è…³æœ¬ç«¯ Prompt å¯«æ³•è¦ç¯„
# ============================================================================

script_prompt_conventions:
  description: |
    ç‚ºäº†è®“ PromptManager èƒ½æ­£ç¢ºæå–å’Œæ›¿æ›ï¼Œè…³æœ¬ä¸­çš„ prompt å¿…é ˆéµå®ˆä»¥ä¸‹è¦ç¯„ã€‚

  supported_formats:
    format_1_single_var:
      description: "å–®ä¸€ prompt çš„ stage"
      example: |
        PROMPT = """
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¸‚å ´åˆ†æå¸«...
        è«‹æ ¹æ“šä»¥ä¸‹åœ–ç‰‡åˆ†æ...
        """
      variable_naming: "PROMPT"

    format_2_multiple_vars:
      description: "å¤šå€‹ prompt çš„ stageï¼ˆå¦‚ä¸€å€‹ stage æœ‰ 2 æ¬¡ API å‘¼å«ï¼‰"
      example: |
        PROMPT_INFLOW = """
        è«‹åˆ†æä»¥ä¸‹æ·¨æµå…¥ ETF çš„è¡¨ç¾...
        """

        PROMPT_OUTFLOW = """
        è«‹åˆ†æä»¥ä¸‹æ·¨æµå‡º ETF çš„è¡¨ç¾...
        """
      variable_naming: "PROMPT_{SECTION_NAME}ï¼Œå…¨å¤§å¯«åº•ç·šåˆ†éš”"

    format_3_dict:
      description: "å­—å…¸æ ¼å¼ï¼ˆè¼ƒå°‘ç”¨ï¼‰"
      example: |
        PROMPTS = {
            "section_1": """
            ç¬¬ä¸€æ®µåˆ†æçš„ prompt...
            """,
            "section_2": """
            ç¬¬äºŒæ®µåˆ†æçš„ prompt...
            """
        }

  unsupported:
    dynamic_fstring:
      description: |
        å«æœ‰å‹•æ…‹è³‡æ–™çš„ f-string promptï¼ˆå¦‚åµŒå…¥å‰é¢ stage çš„è¼¸å‡ºï¼‰
        ç„¡æ³•è¢« regex éœæ…‹æå–ã€‚
      example: |
        prompt = f"""
        æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼š
        {stage1_output}      # â† å‹•æ…‹è³‡æ–™ï¼Œç„¡æ³•æå–
        è«‹ç¸½çµ...
        """
      workaround: |
        åœ¨ UI çš„ STAGE_META ä¸­è¨­ prompt_key=Noneï¼Œ
        ä¸¦é¡¯ç¤ºæç¤ºè¨Šæ¯å¼•å°ä½¿ç”¨è€…ç›´æ¥ç·¨è¼¯è…³æœ¬æˆ–æŸ¥çœ‹åŸå§‹ç¢¼ã€‚

# ============================================================================
# UI æ•´åˆè¨­è¨ˆï¼ˆStreamlitï¼‰
# ============================================================================

ui_integration:
  stage_config:
    description: |
      UI ç”¨ä¸€å€‹ STAGE_META å­—å…¸æè¿°æ‰€æœ‰ stage çš„é…ç½®ï¼Œ
      ç”¨æ–¼è‡ªå‹•ç”Ÿæˆå„ stage çš„ç®¡ç†é é¢ã€‚
    schema:
      name: "str â€” stage é¡¯ç¤ºåç¨±"
      emoji: "str â€” åœ–ç¤º"
      api: "int â€” API å‘¼å«æ¬¡æ•¸"
      script: "str | None â€” è…³æœ¬è·¯å¾‘"
      output_prefix: "str | None â€” è¼¸å‡ºæª”åå‰ç¶´"
      images_in: "list[str] â€” è¼¸å…¥åœ–ç‰‡æª”åï¼ˆæ”¯æ´ {prefix} æ›¿æ›ï¼‰"
      data_in: "list[str] â€” è¼¸å…¥è³‡æ–™æª”åï¼ˆæ”¯æ´ {prefix} æ›¿æ›ï¼‰"
      prompt_key: "str | None â€” å°æ‡‰ PromptManager.prompt_files çš„ key"

  prompt_editor_ui:
    layout: |
      æ¯å€‹ stage é é¢æœ‰ä¸‰å€‹ tabï¼š
      1. ğŸ“¥ è¼¸å…¥ç®¡ç† â€” åœ–ç‰‡é è¦½ã€è³‡æ–™ç‹€æ…‹ã€Prompt ç·¨è¼¯å™¨
      2. â–¶ï¸ åŸ·è¡Œ â€” åŸ·è¡ŒæŒ‰éˆ• + ç•¶å‰è¼¸å‡ºé è¦½ + è…³æœ¬åŸå§‹ç¢¼
      3. ğŸ“œ ç‰ˆæœ¬è¨˜éŒ„ â€” è¼¸å‡ºç‰ˆæœ¬å¿«ç…§ç®¡ç†

    prompt_section_components:
      - name: "è‰ç¨¿è¨˜éŒ„ expander"
        description: "åˆ—å‡ºå·²å­˜çš„è‰ç¨¿ï¼Œå¯é»è¼‰å…¥"
      - name: "å„ Prompt ç·¨è¼¯å™¨"
        description: |
          æ¯å€‹ prompt è®Šæ•¸ä¸€å€‹ expanderï¼Œå…§å«ï¼š
          - å­—æ•¸/è¡Œæ•¸é¡¯ç¤º
          - æ˜¯å¦å·²ä¿®æ”¹çš„æç¤º
          - text_area ç·¨è¼¯å™¨ï¼ˆå¯ç·¨è¼¯ï¼‰
          - ğŸ‘ï¸ é è¦½ expanderï¼ˆè®Šæ•¸æ›¿æ›å¾Œï¼Œå”¯è®€ï¼‰
      - name: "Prompt é è¦½åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰"
        description: |
          åœ¨æ¯å€‹ Prompt ç·¨è¼¯å™¨ä¸‹æ–¹æä¾›é è¦½åŠŸèƒ½ï¼š
          - è‡ªå‹•æ›¿æ›éœæ…‹è®Šæ•¸ï¼ˆå¦‚ {{YEAR}}, {{MONTH}}ï¼‰
          - å‹•æ…‹è®Šæ•¸æ¨™è¨˜ç‚º [åŸ·è¡Œæ™‚å‹•æ…‹ç”Ÿæˆ: {{xxx}}]
          - å”¯è®€ text_areaï¼ˆdisabled=Trueï¼‰
          - é¡¯ç¤ºæ›¿æ›å¾Œçš„å­—æ•¸å’Œè¡Œæ•¸
        implementation: |
          def render_prompt_with_variables(prompt_text, year, month):
              """æ›¿æ› prompt ä¸­çš„è®Šæ•¸ç‚ºå¯¦éš›å€¼"""
              prev = get_prev_prefix(year, month)
              prev_year = int(prev[:4])
              prev_month = int(prev[4:])

              rendered = prompt_text
              rendered = rendered.replace("{{YEAR}}", str(year))
              rendered = rendered.replace("{{MONTH}}", str(month))
              rendered = rendered.replace("{{PREV_YEAR}}", str(prev_year))
              rendered = rendered.replace("{{PREV_MONTH}}", str(prev_month))

              # å‹•æ…‹è®Šæ•¸æ¨™è¨˜
              dynamic_vars = ["{{data_comparison}}", "{{stage1_output}}", ...]
              for var in dynamic_vars:
                  if var in rendered:
                      rendered = rendered.replace(var, f"[åŸ·è¡Œæ™‚å‹•æ…‹ç”Ÿæˆ: {var}]")

              return rendered
        benefits:
          - "å³æ™‚çœ‹åˆ°è®Šæ•¸æ›¿æ›å¾Œçš„å¯¦éš› prompt"
          - "æ–¹ä¾¿æª¢æŸ¥è®Šæ•¸æ˜¯å¦æ­£ç¢º"
          - "æ¸…æ¥šçŸ¥é“å“ªäº›æ˜¯å‹•æ…‹è®Šæ•¸"
          - "å”¯è®€ä¿è­·ï¼Œé¿å…èª¤ç·¨è¼¯é è¦½å…§å®¹"
      - name: "æ“ä½œæŒ‰éˆ•åˆ—ï¼ˆ3 æ¬„ï¼‰"
        buttons:
          - "ğŸ’¾ æš«å­˜è‰ç¨¿ â€” å­˜åˆ° prompts/drafts/ JSONï¼Œä¸å½±éŸ¿åŸ·è¡Œ"
          - "ğŸ“¤ æ›´æ–°åˆ°è…³æœ¬ â€” å‘¼å« update_script_prompts()ï¼Œå¯«å› .py"
          - "ğŸ”„ å¾è…³æœ¬é‡æ–°è¼‰å…¥ â€” æ¸…é™¤ session_stateï¼Œé‡æ–°è®€å–"

    session_state_keys:
      prompt_editor: "pe_{stage_num}_{prompt_var_name}"

  streamlit_code_patterns:
    prompt_editor: |
      def ui_prompts(stage_num, year=None, month=None):
          meta = STAGE_META[stage_num]
          if not meta["prompt_key"]:
              return

          pm = PromptManager()
          base_prompts = pm.get_prompts(meta["prompt_key"])
          if not base_prompts:
              st.warning("æ‰¾ä¸åˆ° Prompt")
              return

          # è‰ç¨¿ç®¡ç†
          drafts = get_drafts(stage_num)
          if drafts:
              with st.expander(f"è‰ç¨¿è¨˜éŒ„ï¼ˆ{len(drafts)} å€‹ï¼‰"):
                  for d in drafts[:10]:
                      if st.button("è¼‰å…¥", key=f"ld_{stage_num}_{d['id']}"):
                          loaded = json.loads(Path(d["path"]).read_text(encoding='utf-8'))
                          for pn, content in loaded.items():
                              st.session_state[f"pe_{stage_num}_{pn}"] = content
                          st.rerun()

          # ç·¨è¼¯å„ Prompt
          for pname, default in base_prompts.items():
              init = st.session_state.get(f"pe_{stage_num}_{pname}", default)
              with st.expander(f"âœï¸ {pname}"):
                  # é¡¯ç¤ºå­—æ•¸ã€è¡Œæ•¸ã€ä¿®æ”¹ç‹€æ…‹
                  cc = st.columns(3)
                  cc[0].caption(f"å­—æ•¸ï¼š{len(init)}")
                  cc[1].caption(f"è¡Œæ•¸ï¼š{len(init.splitlines())}")
                  if init != default:
                      cc[2].caption("âš ï¸ å·²ä¿®æ”¹")

                  # ç·¨è¼¯å™¨
                  st.text_area("", init, height=250,
                               key=f"pe_{stage_num}_{pname}",
                               label_visibility="collapsed")

                  # é è¦½ï¼ˆè®Šæ•¸æ›¿æ›å¾Œï¼‰
                  if year and month:
                      with st.expander(f"ğŸ‘ï¸ é è¦½ï¼ˆè®Šæ•¸æ›¿æ›å¾Œï¼‰", expanded=False):
                          rendered = render_prompt_with_variables(init, year, month)
                          st.text_area("", rendered, height=250,
                                       key=f"preview_{stage_num}_{pname}",
                                       label_visibility="collapsed",
                                       disabled=True,
                                       help="æ­¤ç‚ºè®Šæ•¸æ›¿æ›å¾Œçš„é è¦½ï¼Œå”¯è®€æ¨¡å¼")
                          st.caption(f"ğŸ“Š æ›¿æ›å¾Œå­—æ•¸ï¼š{len(rendered)} | è¡Œæ•¸ï¼š{len(rendered.splitlines())}")

          # ä¸‰å€‹æŒ‰éˆ•
          c1, c2, c3 = st.columns(3)
          # æš«å­˜è‰ç¨¿ â†’ save_draft()
          # æ›´æ–°åˆ°è…³æœ¬ â†’ pm.update_script_prompts()
          # é‡æ–°è¼‰å…¥ â†’ æ¸… session_state + st.rerun()

# ============================================================================
# è¼¸å‡ºç‰ˆæœ¬ç®¡ç†
# ============================================================================

version_management:
  description: |
    æ¯æ¬¡æˆåŠŸåŸ·è¡Œ stage å¾Œï¼Œè‡ªå‹•å¿«ç…§è¼¸å‡ºåˆ°ç‰ˆæœ¬ç›®éŒ„ã€‚
    ä½¿ç”¨è€…å¯ä»¥åˆ‡æ›ä¸»è¦ç‰ˆæœ¬ã€åˆªé™¤ç‰ˆæœ¬ã€é è¦½å…§å®¹ã€‚
    æœ€çµ‚çµ„è£æ™‚å¯é¸æ“‡å„ stage çš„ç‰¹å®šç‰ˆæœ¬ã€‚

  storage:
    snapshots: "temp/versions/{YYYYMM}/stage{N}/v{YYYYMMDD_HHMMSS}.md"
    active_tracking: "temp/active_versions_{YYYYMM}.json"
    active_json_format: |
      {
        "1": "v20260209_143022",
        "2": "v20260209_143045",
        ...
      }

  operations:
    snapshot: "è¤‡è£½ temp/stage{N}_output_{prefix}.md â†’ versions ç›®éŒ„"
    set_active: "æ›´æ–° active_versions JSON"
    apply_version: "å¾ versions ç›®éŒ„è¤‡è£½å› temp/ï¼ˆä¾›ä¸‹æ¸¸ stage è®€å–ï¼‰"
    delete_version: "åˆªé™¤å¿«ç…§æª” + è‹¥ç‚º active å‰‡æ¸…é™¤ active è¨˜éŒ„"

  auto_snapshot_flow: |
    åŸ·è¡Œ stage â†’ æˆåŠŸ â†’ snapshot() â†’ set_active_vid()
    é€™ç¢ºä¿æ¯æ¬¡æˆåŠŸåŸ·è¡Œéƒ½æœ‰ç‰ˆæœ¬è¨˜éŒ„ï¼Œä¸”è‡ªå‹•è¨­ç‚ºä¸»è¦ç‰ˆæœ¬ã€‚

  assembly_stage:
    description: |
      æœ€çµ‚çµ„è£ stage çš„ç‰¹æ®Š UIï¼š
      - ç‚ºæ¯å€‹å‰ç½® stage æä¾› selectbox é¸æ“‡ç‰ˆæœ¬
      - ã€Œå¥—ç”¨ã€æŒ‰éˆ•ï¼šapply_version() å°‡é¸å®šç‰ˆæœ¬è¤‡è£½åˆ° temp/
      - ç„¶å¾ŒåŸ·è¡Œçµ„è£è…³æœ¬è®€å– temp/ ä¸­çš„æª”æ¡ˆ

# ============================================================================
# å·²çŸ¥é™·é˜±èˆ‡è§£æ±ºæ–¹æ¡ˆ
# ============================================================================

known_pitfalls:
  - issue: "æå–å’Œå¯«å› regex ä¸ä¸€è‡´"
    description: |
      extract_prompts_from_script å’Œ update_script_prompts çš„åµæ¸¬ regex å¿…é ˆä¸€è‡´ã€‚
      ä¾‹å¦‚ extract æ”¯æ´ PROMPTï¼ˆç„¡åº•ç·šï¼‰ï¼Œä½† update çš„åµæ¸¬åªæ‰¾ PROMPT_\w+ï¼Œ
      æœƒå°è‡´ã€Œçœ‹å¾—åˆ°ä½†å¯«ä¸å›ã€çš„å‡æˆåŠŸ bugã€‚
    solution: "å…©è™•çµ±ä¸€ç”¨ r'PROMPT(?:_\\w+)?' åŒæ™‚åŒ¹é… PROMPT å’Œ PROMPT_XXX"

  - issue: "å‹•æ…‹ f-string prompt ç„¡æ³•æå–"
    description: |
      å«æœ‰ {variable} çš„ f-string prompt ä¸æ˜¯ module-level å¸¸æ•¸ï¼Œ
      regex ç„¡æ³•éœæ…‹æå–ï¼Œä¸”ä¹Ÿç„¡æ³•å¯«å›ã€‚
    solution: |
      åœ¨ STAGE_META è¨­ prompt_key=Noneï¼Œ
      UI é¡¯ç¤ºèªªæ˜è¨Šæ¯å¼•å°ä½¿ç”¨è€…æŸ¥çœ‹/ç·¨è¼¯åŸå§‹ç¢¼ã€‚

  - issue: "JSON å¿«å–å¯èƒ½éæœŸ"
    description: |
      å¦‚æœä½¿ç”¨è€…ç›´æ¥ä¿®æ”¹ .py è…³æœ¬ï¼ˆä¸é€é UIï¼‰ï¼Œ
      JSON å¿«å–æœƒèˆ‡è…³æœ¬ä¸åŒæ­¥ã€‚
    solution: |
      æä¾›ã€Œå¾è…³æœ¬é‡æ–°è¼‰å…¥ã€æŒ‰éˆ•ï¼Œæ¸…é™¤ session_state å’Œ JSON å¿«å–ã€‚
      ä¹Ÿå¯ä»¥æ¯”è¼ƒ .py å’Œ .json çš„ mtime è‡ªå‹•åµæ¸¬ã€‚

  - issue: "Windows ç·¨ç¢¼å•é¡Œ"
    description: "subprocess åŸ·è¡Œè…³æœ¬æ™‚è¼¸å‡ºå«æœ‰é ASCII å­—å…ƒ"
    solution: |
      subprocess.Popen åŠ ä¸Š encoding='utf-8', errors='replace'ã€‚
      è…³æœ¬é ­éƒ¨åŠ  sys.stdout.reconfigure(encoding='utf-8', errors='replace')ã€‚

  - issue: "Streamlit session_state èˆ‡ widget key è¡çª"
    description: |
      text_area çš„ key å’Œ session_state é è¨­å€¼éœ€è¦ç²¾å¿ƒè¨­è¨ˆï¼Œ
      å¦å‰‡æœƒå‡ºç¾ã€Œä¿®æ”¹å¾Œåˆ‡æ› tab å°±é‡ç½®ã€çš„å•é¡Œã€‚
    solution: |
      ç”¨ st.session_state.get(key, default) å–å¾—åˆå§‹å€¼ï¼Œ
      å†æŠŠ key åŒæ™‚ä½œç‚º text_area çš„ keyï¼Œè®“ Streamlit è‡ªå‹•ç®¡ç†ã€‚

# ============================================================================
# çµ¦ AI çš„å»ºæ§‹æŒ‡å¼•
# ============================================================================

ai_implementation_guide:
  step_1_analyze_project:
    description: |
      å…ˆåˆ†æç›®æ¨™å°ˆæ¡ˆçš„çµæ§‹ï¼š
      - æœ‰å“ªäº› stage/stepï¼Ÿ
      - æ¯å€‹ stage å‘¼å«å“ªäº› APIï¼Ÿ
      - prompt ç›®å‰å¯«åœ¨å“ªè£¡ï¼Ÿæ ¼å¼ç‚ºä½•ï¼Ÿ
      - å“ªäº› prompt æ˜¯éœæ…‹çš„ï¼Ÿå“ªäº›æ˜¯å‹•æ…‹çš„ï¼Ÿ

  step_2_standardize_prompts:
    description: |
      å°‡å„è…³æœ¬çš„ prompt çµ±ä¸€ç‚º module-level å¸¸æ•¸ï¼š
      - å–®ä¸€ prompt çš„ stage â†’ PROMPT = """..."""
      - å¤š prompt çš„ stage â†’ PROMPT_SECTION_A = """..."""
      - å‹•æ…‹ prompt â†’ ä¿æŒåŸæ¨£ï¼Œä½†åœ¨ UI æ¨™è¨˜ç‚ºä¸å¯ç·¨è¼¯

  step_3_create_prompt_manager:
    description: |
      å»ºç«‹ PromptManager é¡åˆ¥ï¼š
      - å®šç¾© prompt_files æ˜ å°„è¡¨
      - å¯¦ä½œ extract / get / save / update æ–¹æ³•
      - å¯¦ä½œ backup / restore æ–¹æ³•
      - ç¢ºä¿ extract å’Œ update çš„ regex ä¸€è‡´

  step_4_integrate_ui:
    description: |
      åœ¨ Streamlit UI ä¸­æ•´åˆï¼š
      - å®šç¾© STAGE_META é…ç½®
      - å»ºç«‹ ui_prompts() å…ƒä»¶ï¼ˆå«é è¦½åŠŸèƒ½ï¼‰
      - å»ºç«‹ render_prompt_with_variables() å‡½æ•¸ï¼ˆè®Šæ•¸æ›¿æ›ï¼‰
      - å»ºç«‹è‰ç¨¿ç®¡ç†åŠŸèƒ½
      - å»ºç«‹ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½
      - æ¯å€‹ stage é é¢æ•´åˆè¼¸å…¥ç®¡ç† + åŸ·è¡Œ + ç‰ˆæœ¬è¨˜éŒ„
      - å‰µå»ºä¸‰ç¨®å®‰å…¨å•Ÿå‹•è…³æœ¬ï¼ˆå®‰å…¨/å…§ç¶²/é–‹æ”¾æ¨¡å¼ï¼‰
      - é…ç½® .streamlit/config.toml å®‰å…¨é¸é …

  step_5_test:
    description: |
      æ¸¬è©¦è¦é»ï¼š
      - å¾è…³æœ¬æå– prompt â†’ ç·¨è¼¯ â†’ å„²å­˜è‰ç¨¿ â†’ è¼‰å…¥è‰ç¨¿
      - æ›´æ–°åˆ°è…³æœ¬ â†’ ç¢ºèª .py æª”æ¡ˆçœŸçš„è¢«ä¿®æ”¹
      - åŸ·è¡Œ stage â†’ ç¢ºèªç”¨çš„æ˜¯æ–° prompt
      - ç‰ˆæœ¬å¿«ç…§ â†’ åˆ‡æ›ç‰ˆæœ¬ â†’ ç¢ºèªçµ„è£ä½¿ç”¨æ­£ç¢ºç‰ˆæœ¬

# ============================================================================
# å¿«é€Ÿé–‹å§‹ç¯„ä¾‹
# ============================================================================

quick_start_example:
  description: |
    ä»¥ä¸‹æ˜¯ä¸€å€‹æœ€å°åŒ–çš„ç¯„ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ­¤è¦æ ¼ã€‚
    å‡è¨­ä½ æœ‰ä¸€å€‹ 3 éšæ®µçš„å ±å‘Šç”Ÿæˆæµç¨‹ã€‚

  prompt_to_ai: |
    æˆ‘æœ‰ä¸€å€‹å ±å‘Šç”Ÿæˆå°ˆæ¡ˆï¼ŒåŒ…å« 3 å€‹éšæ®µï¼š

    Stage 1: æ•¸æ“šæ‘˜è¦ï¼ˆ1 å€‹ API å‘¼å«ï¼‰
      - è…³æœ¬: scripts/stage1_summary.py
      - Prompt è®Šæ•¸: PROMPT

    Stage 2: è©³ç´°åˆ†æï¼ˆ2 å€‹ API å‘¼å«ï¼‰
      - è…³æœ¬: scripts/stage2_analysis.py
      - Prompt è®Šæ•¸: PROMPT_SECTION_A, PROMPT_SECTION_B

    Stage 3: ç¸½çµï¼ˆ1 å€‹ API å‘¼å«ï¼‰
      - è…³æœ¬: scripts/stage3_conclusion.py
      - Prompt è®Šæ•¸: PROMPTï¼ˆå‹•æ…‹ï¼ŒåŒ…å«å‰é¢ stage çš„è¼¸å‡ºï¼‰

    è«‹æ ¹æ“šä»¥ä¸‹è¦æ ¼ç‚ºæˆ‘å»ºç«‹ Prompt ç®¡ç†ç³»çµ±ï¼š
    [è²¼ä¸Šæ­¤ YAML å…¨æ–‡]

    è«‹ç”Ÿæˆï¼š
    1. utils/prompt_manager.pyï¼ˆPromptManager é¡åˆ¥ï¼‰
    2. Streamlit UI çš„ Prompt ç·¨è¼¯å™¨çµ„ä»¶ï¼ˆå«é è¦½åŠŸèƒ½ï¼‰
    3. ç‰ˆæœ¬ç®¡ç†ç›¸é—œå‡½æ•¸
    4. ä¸‰ç¨®å®‰å…¨å•Ÿå‹•è…³æœ¬ï¼ˆstart_ui.bat, start_ui_network.bat, start_ui_public.batï¼‰
    5. .streamlit/config.toml é…ç½®æ–‡ä»¶

  expected_file_structure: |
    project/
    â”œâ”€â”€ scripts/
    â”‚   â”œâ”€â”€ stage1_summary.py        # PROMPT = """..."""
    â”‚   â”œâ”€â”€ stage2_analysis.py       # PROMPT_SECTION_A, PROMPT_SECTION_B
    â”‚   â””â”€â”€ stage3_conclusion.py     # å‹•æ…‹ prompt
    â”œâ”€â”€ utils/
    â”‚   â””â”€â”€ prompt_manager.py        # AI ç”Ÿæˆ
    â”œâ”€â”€ prompts/
    â”‚   â”œâ”€â”€ stage1_prompts.json      # å¿«å–
    â”‚   â”œâ”€â”€ stage2_prompts.json
    â”‚   â”œâ”€â”€ backups/                 # è‡ªå‹•å‚™ä»½
    â”‚   â””â”€â”€ drafts/                  # è‰ç¨¿
    â”œâ”€â”€ temp/
    â”‚   â”œâ”€â”€ versions/                # ç‰ˆæœ¬å¿«ç…§
    â”‚   â””â”€â”€ active_versions_*.json   # ä¸»è¦ç‰ˆæœ¬è¿½è¹¤
    â”œâ”€â”€ .streamlit/
    â”‚   â”œâ”€â”€ config.toml              # Streamlit å®‰å…¨é…ç½®
    â”‚   â””â”€â”€ secrets.toml             # å¯†ç¢¼ä¿è­·ï¼ˆå¯é¸ï¼‰
    â”œâ”€â”€ start_ui.bat                 # ğŸŸ¢ å®‰å…¨æ¨¡å¼å•Ÿå‹•ï¼ˆæ¨è–¦ï¼‰
    â”œâ”€â”€ start_ui_network.bat         # ğŸŸ¡ å…§ç¶²æ¨¡å¼å•Ÿå‹•
    â”œâ”€â”€ start_ui_public.bat          # ğŸ”´ é–‹æ”¾æ¨¡å¼å•Ÿå‹•ï¼ˆæœ‰è­¦å‘Šï¼‰
    â””â”€â”€ ui_app.py                    # Streamlit UI

# ============================================================================
# å¸¸è¦‹å•é¡Œ FAQ
# ============================================================================

faq:
  q1:
    question: "é€™å€‹ç³»çµ±å’Œç›´æ¥ç·¨è¼¯ .py æ–‡ä»¶æœ‰ä»€éº¼å·®åˆ¥ï¼Ÿ"
    answer: |
      ç›´æ¥ç·¨è¼¯ .pyï¼š
      - éœ€è¦é‡å•Ÿæ‡‰ç”¨æ‰èƒ½çœ‹åˆ°æ•ˆæœ
      - æ²’æœ‰ç‰ˆæœ¬æ­·å²ï¼ˆé™¤éç”¨ gitï¼‰
      - ç„¡æ³•å¿«é€Ÿ A/B æ¸¬è©¦

      ä½¿ç”¨æ­¤ç³»çµ±ï¼š
      - UI å³æ™‚é è¦½å’Œç·¨è¼¯
      - è‡ªå‹•ç‰ˆæœ¬å¿«ç…§
      - è‰ç¨¿æš«å­˜ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰
      - å¯ä»¥æ¯”è¼ƒä¸åŒç‰ˆæœ¬çš„è¼¸å‡ºçµæœ

  q2:
    question: "ç‚ºä»€éº¼ä¸æŠŠ Prompt å­˜åœ¨è³‡æ–™åº«ï¼Ÿ"
    answer: |
      è¨­è¨ˆåŸå‰‡æ˜¯ã€ŒPrompt å³ç¨‹å¼ç¢¼ã€ï¼š
      - Prompt æ˜¯æ¥­å‹™é‚è¼¯çš„ä¸€éƒ¨åˆ†ï¼Œæ‡‰è©²åœ¨ç‰ˆæœ¬æ§åˆ¶ï¼ˆGitï¼‰ä¸­
      - è³‡æ–™åº«æœƒè®“éƒ¨ç½²è®Šè¤‡é›œ
      - ç´”æª”æ¡ˆç³»çµ±æ›´å®¹æ˜“å‚™ä»½å’Œé·ç§»
      - JSON å¿«å–åªæ˜¯ç‚ºäº†åŠ é€Ÿè®€å–ï¼Œä¸æ˜¯ single source of truth

  q3:
    question: "å¯ä»¥ç”¨æ–¼é Streamlit çš„å°ˆæ¡ˆå—ï¼Ÿ"
    answer: |
      å¯ä»¥ï¼PromptManager é¡åˆ¥ä¸ä¾è³´ Streamlitã€‚
      ä½ å¯ä»¥ï¼š
      - ç”¨ CLI å·¥å…·èª¿ç”¨ PromptManager
      - æ•´åˆåˆ°å…¶ä»– Web æ¡†æ¶ï¼ˆFlaskã€FastAPIï¼‰
      - å¯«è‡ªå·±çš„ç·¨è¼¯å™¨ UI

  q4:
    question: "å¦‚ä½•è™•ç†å¤šèªè¨€ Promptï¼Ÿ"
    answer: |
      å»ºè­°æ“´å±•ç‚ºï¼š
      PROMPT_EN = """..."""
      PROMPT_ZH = """..."""

      ç„¶å¾Œåœ¨ PromptManager åŠ ä¸Šèªè¨€åƒæ•¸ã€‚

  q5:
    question: "ç‰ˆæœ¬å¿«ç…§æœƒä¸æœƒä½”ç”¨å¾ˆå¤šç©ºé–“ï¼Ÿ"
    answer: |
      Markdown æ–‡æœ¬æª”æ¡ˆå¾ˆå°ï¼ˆé€šå¸¸ < 100KBï¼‰ã€‚
      å³ä½¿ 100 å€‹ç‰ˆæœ¬ä¹Ÿåªæœ‰ 10MBã€‚
      å»ºè­°å®šæœŸæ¸…ç†èˆŠç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘ 20 å€‹ï¼‰ã€‚

# ============================================================================
# Streamlit å®‰å…¨å•Ÿå‹•é…ç½®
# ============================================================================

streamlit_security:
  description: |
    Streamlit é è¨­æœƒç›£è½æ‰€æœ‰ç¶²è·¯ä»‹é¢ï¼ˆ0.0.0.0ï¼‰ï¼Œé€™æ„å‘³è‘—ï¼š
    - æœƒç”¢ç”Ÿ Localã€Networkã€External ä¸‰å€‹ URL
    - External URL æœƒæš´éœ²åœ¨å…¬ç¶²ï¼Œä»»ä½•äººéƒ½å¯è¨ªå•
    - å¦‚æœæ²’æœ‰å¯†ç¢¼ä¿è­·ï¼Œç³»çµ±çš„æ‰€æœ‰åŠŸèƒ½éƒ½æœƒè¢«æš´éœ²

    æä¾›ä¸‰ç¨®å•Ÿå‹•æ¨¡å¼ï¼Œé©æ‡‰ä¸åŒçš„ä½¿ç”¨å ´æ™¯å’Œå®‰å…¨éœ€æ±‚ã€‚

  security_levels:
    safe_mode:
      name: "ğŸŸ¢ å®‰å…¨æ¨¡å¼ï¼ˆæ¨è–¦ï¼‰"
      description: "åƒ…æœ¬æ©Ÿè¨ªå•ï¼Œæœ€å®‰å…¨"
      script_name: "start_ui.bat"
      config: |
        # ç›£è½åœ°å€ï¼šlocalhost
        python -W ignore -m streamlit run ui_app.py --server.address localhost --server.headless true 2>nul
      features:
        - "åªæœ‰æœ¬æ©Ÿèƒ½è¨ªå•"
        - "ç„¡ External URL æš´éœ²"
        - "è³‡æ–™ä¸æœƒå¤–æ´©"
        - "é˜²æ­¢ä»–äººèª¤æ“ä½œ"
      use_cases:
        - "æ—¥å¸¸é–‹ç™¼å’Œä½¿ç”¨"
        - "åŒ…å«æ•æ„Ÿè³‡æ–™"
        - "å€‹äººå·¥ä½œç’°å¢ƒ"

    network_mode:
      name: "ğŸŸ¡ å€åŸŸç¶²è·¯æ¨¡å¼"
      description: "å…§ç¶²è¨ªå•ï¼Œä¸­ç­‰å®‰å…¨"
      script_name: "start_ui_network.bat"
      config: |
        # ç›£è½åœ°å€ï¼š0.0.0.0ï¼ˆæ‰€æœ‰ä»‹é¢ï¼‰
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul
      features:
        - "åŒç¶²è·¯çš„è¨­å‚™å¯è¨ªå•"
        - "æœ‰ Network URLï¼ˆå…§ç¶² IPï¼‰"
        - "ç„¡ External URLï¼ˆéœ€è·¯ç”±å™¨è¨­å®šï¼‰"
        - "åŒç¶²è·¯çš„äººå¯åŸ·è¡Œæ‰€æœ‰æ“ä½œ"
      use_cases:
        - "æ‰‹æ©Ÿ/å¹³æ¿æ¸¬è©¦ UI"
        - "å…§éƒ¨åœ˜éšŠå”ä½œ"
        - "å€åŸŸç¶²è·¯æ¼”ç¤º"
      warnings:
        - "ç¢ºèªç•¶å‰ç¶²è·¯æ˜¯å¦å¯ä¿¡"
        - "ä¸è¦åœ¨å…¬å…± Wi-Fi ä½¿ç”¨"
        - "ä½¿ç”¨å®Œç•¢ç«‹å³é—œé–‰"

    public_mode:
      name: "ğŸ”´ å®Œå…¨é–‹æ”¾æ¨¡å¼ï¼ˆé«˜é¢¨éšªï¼‰"
      description: "å…¨ä¸–ç•Œå¯è¨ªå•ï¼Œåƒ…æ¸¬è©¦ç”¨"
      script_name: "start_ui_public.bat"
      config: |
        # ç›£è½åœ°å€ï¼š0.0.0.0 + é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        @echo off
        echo ğŸš¨ è­¦å‘Šï¼šå®Œå…¨é–‹æ”¾æ¨¡å¼ ğŸš¨
        echo ä»»ä½•çŸ¥é“ä½  IP çš„äººéƒ½èƒ½è¨ªå•ç³»çµ±
        pause
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul
      features:
        - "ç”¢ç”Ÿ External URLï¼ˆå…¬ç¶² IPï¼‰"
        - "å…¨ä¸–ç•Œä»»ä½•äººéƒ½å¯è¨ªå•"
        - "å¯åŸ·è¡Œè…³æœ¬ã€æŸ¥çœ‹è³‡æ–™ã€æ¶ˆè€— API"
      use_cases:
        - "çŸ­æœŸæ¸¬è©¦ï¼ˆå¹¾åˆ†é˜å…§ï¼‰"
        - "å—æ§æ¼”ç¤ºç’°å¢ƒ"
      warnings:
        - "æ¥µé«˜å®‰å…¨é¢¨éšª"
        - "ä¸è¦é•·æ™‚é–“é‹è¡Œ"
        - "ä¸è¦åŒ…å«æ•æ„Ÿè³‡æ–™"
        - "å»ºè­°è¨­ç½®å¯†ç¢¼ä¿è­·"

  streamlit_config_file:
    path: ".streamlit/config.toml"
    description: "Streamlit é…ç½®æ–‡ä»¶ï¼Œè¨­å®šå®‰å…¨é¸é …"
    example: |
      [logger]
      level = "error"
      messageFormat = "%(asctime)s %(message)s"

      [client]
      showErrorDetails = false

      [runner]
      magicEnabled = true

      [server]
      # å®‰å…¨è¨­å®šï¼šåªå…è¨±æœ¬æ©Ÿè¨ªå•ï¼ˆç¦ç”¨å¤–éƒ¨è¨ªå•ï¼‰
      address = "localhost"
      port = 8501
      headless = true

      # é˜²æ­¢è·¨ç«™è«‹æ±‚å½é€ 
      enableCORS = false
      enableXsrfProtection = true

  startup_scripts:
    description: "ç‚ºä¸åŒå®‰å…¨æ¨¡å¼å‰µå»ºå°æ‡‰çš„å•Ÿå‹•è…³æœ¬"
    windows_batch_files:
      safe_mode: |
        @echo off
        REM å•Ÿå‹• Streamlit UI - å®‰å…¨æ¨¡å¼
        echo ===================================
        echo ç³»çµ±å•Ÿå‹•ä¸­...
        echo å®‰å…¨æ¨¡å¼ï¼šåƒ…æœ¬æ©Ÿè¨ªå•
        echo ===================================
        python -W ignore -m streamlit run ui_app.py --server.address localhost --server.headless true 2>nul

      network_mode: |
        @echo off
        REM å•Ÿå‹• Streamlit UI - å€åŸŸç¶²è·¯æ¨¡å¼
        echo ===================================
        echo âš ï¸ è­¦å‘Šï¼šå€åŸŸç¶²è·¯æ¨¡å¼
        echo åŒç¶²è·¯çš„äººéƒ½èƒ½è¨ªå•ï¼
        echo ===================================
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul

      public_mode: |
        @echo off
        REM å•Ÿå‹• Streamlit UI - å®Œå…¨é–‹æ”¾æ¨¡å¼
        echo ========================================
        echo  ğŸš¨ è­¦å‘Šï¼šå®Œå…¨é–‹æ”¾æ¨¡å¼ ğŸš¨
        echo ========================================
        echo.
        echo æ­¤æ¨¡å¼å°‡é–‹æ”¾ä»¥ä¸‹è¨ªå•æ–¹å¼ï¼š
        echo   âœ“ æœ¬æ©Ÿè¨ªå• (localhost)
        echo   âœ“ å€åŸŸç¶²è·¯è¨ªå• (Network URL)
        echo   âœ“ å¤–éƒ¨ç¶²è·¯è¨ªå• (External URL)
        echo.
        echo âš ï¸  ä»»ä½•çŸ¥é“ä½  IP çš„äººéƒ½èƒ½è¨ªå•ç³»çµ±
        echo âš ï¸  å¯ä»¥åŸ·è¡Œè…³æœ¬ã€æŸ¥çœ‹è³‡æ–™ã€æ¶ˆè€— API
        echo âš ï¸  å»ºè­°åƒ…åœ¨æ¸¬è©¦æˆ–æ¼”ç¤ºæ™‚ä½¿ç”¨
        echo.
        echo ========================================
        pause
        echo.
        echo æ­£åœ¨å•Ÿå‹•...
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>nul

    linux_shell_scripts:
      safe_mode: |
        #!/bin/bash
        # å•Ÿå‹• Streamlit UI - å®‰å…¨æ¨¡å¼
        echo "==================================="
        echo "ç³»çµ±å•Ÿå‹•ä¸­..."
        echo "å®‰å…¨æ¨¡å¼ï¼šåƒ…æœ¬æ©Ÿè¨ªå•"
        echo "==================================="
        python -W ignore -m streamlit run ui_app.py --server.address localhost --server.headless true 2>/dev/null

      network_mode: |
        #!/bin/bash
        # å•Ÿå‹• Streamlit UI - å€åŸŸç¶²è·¯æ¨¡å¼
        echo "==================================="
        echo "âš ï¸  è­¦å‘Šï¼šå€åŸŸç¶²è·¯æ¨¡å¼"
        echo "åŒç¶²è·¯çš„äººéƒ½èƒ½è¨ªå•ï¼"
        echo "==================================="
        python -W ignore -m streamlit run ui_app.py --server.address 0.0.0.0 --server.headless true 2>/dev/null

  verification:
    description: "å¦‚ä½•é©—è­‰ç•¶å‰çš„å®‰å…¨æ¨¡å¼"
    terminal_check:
      description: "æª¢æŸ¥çµ‚ç«¯è¼¸å‡ºçš„ URL"
      safe_mode_output: |
        âœ… Local URL: http://localhost:8501
        (åªæœ‰ 1 å€‹ URLï¼Œå®‰å…¨)

      network_mode_output: |
        âœ… Local URL:   http://localhost:8501
        âš ï¸ Network URL: http://192.168.1.100:8501
        (2 å€‹ URLï¼Œå…§ç¶²å¯è¨ªå•)

      public_mode_output: |
        âœ… Local URL:    http://localhost:8501
        âš ï¸ Network URL:  http://192.168.1.100:8501
        ğŸš¨ External URL: http://27.247.35.9:8501  â† å±éšªï¼å…¨ä¸–ç•Œå¯è¨ªå•
        (3 å€‹ URLï¼Œå®Œå…¨é–‹æ”¾)

    netstat_check:
      description: "ä½¿ç”¨ netstat å‘½ä»¤æª¢æŸ¥ç›£è½ç‹€æ…‹"
      command: "netstat -ano | findstr :8501"
      safe_mode_output: |
        TCP    127.0.0.1:8501    0.0.0.0:0    LISTENING
        (åªç›£è½ localhostï¼Œå®‰å…¨)

      public_mode_output: |
        TCP    0.0.0.0:8501      0.0.0.0:0    LISTENING
        (ç›£è½æ‰€æœ‰ IPï¼Œé–‹æ”¾)

  best_practices:
    - "é è¨­ä½¿ç”¨å®‰å…¨æ¨¡å¼ï¼ˆstart_ui.batï¼‰"
    - "åªåœ¨éœ€è¦æ™‚æ‰ä½¿ç”¨ç¶²è·¯/é–‹æ”¾æ¨¡å¼"
    - "ä½¿ç”¨å®Œç•¢ç«‹å³é—œé–‰ï¼ˆCtrl+Cï¼‰"
    - "é–‹æ”¾æ¨¡å¼ä¸è¦è¶…é 10 åˆ†é˜"
    - "å¦‚éœ€é ç«¯è¨ªå•ï¼Œä½¿ç”¨ Streamlit Cloud + å¯†ç¢¼ä¿è­·æˆ– VPN"
    - "å®šæœŸæª¢æŸ¥ .env æ˜¯å¦åœ¨ .gitignore ä¸­"
    - "åœ¨ README ä¸­èªªæ˜å®‰å…¨å•Ÿå‹•æ–¹å¼"

  remote_access_alternatives:
    description: "å¦‚æœéœ€è¦é ç«¯è¨ªå•ï¼Œä¸è¦ä½¿ç”¨é–‹æ”¾æ¨¡å¼ï¼Œæ”¹ç”¨ä»¥ä¸‹æ–¹æ¡ˆ"
    options:
      - name: "Streamlit Cloud + å¯†ç¢¼ä¿è­·"
        description: "éƒ¨ç½²åˆ° share.streamlit.ioï¼Œè¨­ç½®å¯†ç¢¼"
        pros: ["å…è²»", "HTTPS åŠ å¯†", "24/7 é‹è¡Œ", "å…§å»ºèªè­‰"]
        cons: ["è³‡æ–™åœ¨é›²ç«¯", "å…è²»ç‰ˆæœ‰è³‡æºé™åˆ¶"]

      - name: "VPN è¨ªå•"
        description: "ä½¿ç”¨ Tailscale æˆ– ZeroTier"
        pros: ["é»å°é»åŠ å¯†", "åªæœ‰æˆæ¬Šè¨­å‚™å¯è¨ªå•", "å…è²»ï¼ˆå€‹äººä½¿ç”¨ï¼‰"]
        cons: ["éœ€è¦å®‰è£è»Ÿé«”", "ç¨å¾®è¤‡é›œ"]

      - name: "SSH éš§é“"
        description: "ssh -L 8501:localhost:8501 user@server"
        pros: ["SSH åŠ å¯†", "ä¸éœ€é¡å¤–è»Ÿé«”", "é©åˆè‡¨æ™‚è¨ªå•"]
        cons: ["éœ€è¦ SSH å­˜å–æ¬Š", "é€£ç·šæ–·é–‹å°±ç„¡æ³•è¨ªå•"]

# ============================================================================
# æˆæ¬Šèˆ‡ä½¿ç”¨
# ============================================================================

license:
  description: |
    æœ¬è¦æ ¼æ–‡æª”å¯è‡ªç”±ä½¿ç”¨æ–¼ä»»ä½•å°ˆæ¡ˆï¼ˆå•†æ¥­æˆ–éå•†æ¥­ï¼‰ã€‚

    å»ºè­°åœ¨ä½¿ç”¨æ™‚ï¼š
    1. æ ¹æ“šä½ çš„å°ˆæ¡ˆéœ€æ±‚èª¿æ•´ç´°ç¯€
    2. ä¿ç•™æ ¸å¿ƒè¨­è¨ˆåŸå‰‡
    3. å¦‚æœå°è¦æ ¼æœ‰æ”¹é€²å»ºè­°ï¼Œæ­¡è¿å›é¥‹

  attribution: |
    åŸºæ–¼ã€Œå°ç¾ ETF æ·¨æµé‡åˆ†ææœˆå ±ã€å°ˆæ¡ˆçš„å¯¦è¸ç¶“é©—ç·¨å¯«ã€‚
