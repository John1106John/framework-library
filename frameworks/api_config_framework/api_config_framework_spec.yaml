# API 設定與金鑰管理框架 - 系統規格書
# Version: 1.0.0
# Last Updated: 2026-02-10

metadata:
  name: "API Configuration & Key Rotation Framework"
  version: "1.0.0"
  description: "集中式 API 設定與自動循環金鑰輪替框架，可快速整合到任何 Python 專案"
  author: "John1106John"
  created_at: "2026-02-10"
  updated_at: "2026-02-10"
  license: "MIT"
  compatibility:
    - "Google Gemini API"
    - "OpenAI API (可擴展)"
    - "Anthropic Claude API (可擴展)"

system_overview:
  name: "API Configuration & Key Rotation Framework"
  purpose: |
    提供一個可重用的框架，用於管理 AI API 的集中式設定與自動金鑰輪替。
    解決多專案中重複實作 API 管理邏輯的問題。

  key_features:
    - "集中式設定檔（config.yaml）- 一鍵切換模型與參數"
    - "自動循環金鑰輪替 - 配額用盡後自動循環重試"
    - "配額檢測與自動切換 - 識別 429/quota 錯誤"
    - "詳細日誌追蹤 - 記錄每次 API 呼叫與金鑰切換"
    - "環境變數支援 - 安全的金鑰管理"
    - "快取機制 - lru_cache 減少檔案讀取"

  benefits:
    zero_code_change: "改 config.yaml 即可切換模型，無需修改程式碼"
    multi_key_support: "支援多把金鑰自動輪替，提高穩定性"
    cycle_retry: "循環重試機制，最大化金鑰利用率"
    easy_integration: "3 個檔案即可整合到任何專案"

  tech_stack:
    language: Python 3.8+
    storage: "純檔案系統（YAML + 環境變數），無需資料庫"
    dependencies:
      - pyyaml         # YAML 設定檔解析
      - python-dotenv  # 環境變數載入
      - google-generativeai  # Google Gemini API（或其他 API SDK）

architecture:
  design_principle: |
    「設定與程式碼分離」— 所有可變參數（模型名稱、延遲時間等）集中在 config.yaml，
    API 金鑰存放在 .env 環境變數中，程式碼本身不包含任何硬編碼配置。

    金鑰輪替流程：
    key1 → 配額錯誤 → 切換到 key2 → 配額錯誤 → 切換到 key3 → ... → 回到 key1
    ↑                                                                    ↓
    └────────────── 循環檢測（記錄起始索引，避免無限循環） ──────────────┘

    設計原則：
    1. Single Source of Truth：config.yaml 是所有設定的唯一來源
    2. 環境變數安全：金鑰不寫入 config.yaml，使用 .env 管理
    3. 快取優化：lru_cache 減少重複讀取設定檔
    4. 自動備援：配額耗盡自動切換金鑰，最大化可用性
    5. 詳細日誌：記錄所有 API 呼叫和金鑰切換，便於追蹤和除錯
  components:
    config_yaml:
      file: "config.yaml"
      purpose: "集中式設定檔"
      contains:
        - "model_name: AI 模型名稱"
        - "retry_delay: 配額重試延遲秒數"
        - "api_call_interval: API 呼叫間隔秒數"
        - "其他專案特定參數"

    config_loader:
      file: "utils/config.py"
      purpose: "設定檔讀取工具"
      features:
        - "lru_cache 快取機制"
        - "提供 get_* 函數讀取各參數"
        - "支援 reload_config() 清除快取"
      functions:
        - "get_config() -> dict - 取得完整設定"
        - "get_model_name() -> str - 取得模型名稱"
        - "get_retry_delay() -> float - 取得重試延遲"
        - "get_api_call_interval() -> int - 取得呼叫間隔"
        - "reload_config() -> None - 清除快取重新載入"

    api_manager:
      file: "utils/api/api_manager.py"
      purpose: "API 金鑰管理器"
      features:
        key_loading:
          - "從環境變數載入金鑰（支援單一或多個）"
          - "優先順序：API_KEYS > GOOGLE_API_KEY"

        auto_rotation:
          - "配額錯誤自動切換金鑰"
          - "循環輪替：key1 → key2 → ... → key1"
          - "循環檢測：記錄起始索引，避免無限循環"

        logging:
          - "詳細記錄 API 呼叫與金鑰切換"
          - "按日期儲存日誌（logs/api_YYYYMMDD.log）"
          - "遮蔽金鑰中間部分保護隱私"

      methods:
        - "__init__(model_name=None) - 初始化，從 config.yaml 讀取預設模型"
        - "generate_content(prompt, images, max_retries, retry_delay) - 生成內容，自動處理配額"
        - "reset_key_index() - 手動重置金鑰索引到第一把"
        - "get_current_key_info() - 取得當前金鑰狀態"

    env_file:
      file: ".env"
      purpose: "環境變數設定（金鑰）"
      format:
        single_key: "GOOGLE_API_KEY=your_key_here"
        multi_keys: "API_KEYS=key1,key2,key3"
      security:
        - "必須加入 .gitignore"
        - "提供 .env.example 作為模板"

directory_structure:
  description: |
    以下為 API 設定與金鑰管理框架的標準目錄結構。
    {project_root} 是你的專案根目錄。
  layout:
    config.yaml: "集中式設定檔（專案根目錄）"
    .env: "環境變數設定檔（API 金鑰）"
    .env.example: "環境變數範例檔（提交到 Git）"
    utils/: "工具模組目錄"
    utils/__init__.py: "Python 套件標記檔案"
    utils/config.py: "設定檔讀取工具"
    utils/api/: "API 相關模組目錄"
    utils/api/__init__.py: "Python 套件標記檔案"
    utils/api/api_manager.py: "API 金鑰管理器"
    utils/api/logs/: "API 日誌目錄（自動建立）"
    utils/api/logs/api_YYYYMMDD.log: "按日期的 API 呼叫日誌"
  file_naming:
    config: "config.yaml（固定名稱）"
    env: ".env（固定名稱，必須在 .gitignore 中）"
    log: "api_YYYYMMDD.log（按日期命名）"

integration_guide:
  prerequisites:
    python_version: ">=3.8"
    required_packages:
      - "pyyaml"
      - "python-dotenv"
      - "google-generativeai (或其他 API SDK)"

  step_by_step:
    step_1:
      title: "複製核心檔案到專案"
      files:
        - "config.yaml → 專案根目錄"
        - "utils/config.py → utils/ 目錄"
        - "utils/api/api_manager.py → utils/api/ 目錄"

    step_2:
      title: "設定環境變數"
      actions:
        - "複製 .env.example 為 .env"
        - "填入你的 API 金鑰（單一或多個）"
        - "確認 .env 在 .gitignore 中"

    step_3:
      title: "修改 config.yaml"
      actions:
        - "設定 model_name 為你要用的模型"
        - "調整 retry_delay 和 api_call_interval"
        - "新增專案特定參數（可選）"

    step_4:
      title: "在程式碼中使用"
      example: |
        # 方法 1：直接使用 API Manager
        from utils.api.api_manager import APIManager

        manager = APIManager()  # 自動從 config.yaml 讀取模型
        result = manager.generate_content("你的 prompt")

        # 方法 2：腳本中讀取設定
        from utils.config import get_model_name, get_api_call_interval
        import time

        MODEL_NAME = get_model_name()
        time.sleep(get_api_call_interval())

    step_5:
      title: "整合到現有程式碼"
      actions:
        - "將硬編碼的模型名稱改為 get_model_name()"
        - "將 time.sleep(2) 改為 time.sleep(get_api_call_interval())"
        - "將 API 呼叫邏輯改用 APIManager"

configuration_reference:
  config_yaml_schema:
    model_name:
      type: "string"
      description: "AI 模型名稱（如 gemini-2.5-flash）"
      required: true
      example: "gemini-2.5-flash"

    retry_delay:
      type: "float"
      description: "配額限制時的重試等待秒數"
      required: false
      default: 2.0
      range: [0.1, 10.0]

    api_call_interval:
      type: "integer"
      description: "同腳本內連續 API 呼叫的間隔秒數"
      required: false
      default: 2
      range: [0, 10]

    custom_params:
      type: "any"
      description: "專案特定參數（可自行擴展）"
      required: false
      example:
        max_tokens: 1000
        temperature: 0.7

  env_variables:
    GOOGLE_API_KEY:
      description: "單一 API 金鑰"
      format: "字串"
      priority: 2
      example: "AIzaSy..."

    API_KEYS:
      description: "多個 API 金鑰（逗號分隔）"
      format: "字串（逗號分隔）"
      priority: 1
      example: "key1,key2,key3"
      note: "如果同時設定，會優先使用 API_KEYS"

key_rotation_mechanism:
  workflow:
    - step: "初始化時載入所有金鑰"
      action: "從環境變數讀取，儲存為 list"

    - step: "API 呼叫前記錄起始索引"
      action: "self._start_key_index = self.current_key_index"

    - step: "呼叫 API"
      success: "返回結果"
      error: "檢查錯誤類型"

    - step: "配額錯誤處理"
      action: "next_index = (current_index + 1) % len(keys)"
      check: "if next_index == start_index: 全部用完"
      else: "切換到 next_index 並重試"

    - step: "非配額錯誤"
      action: "直接拋出異常"

  cycle_detection:
    purpose: "避免無限循環"
    mechanism: |
      每次 generate_content() 呼叫時記錄起始金鑰索引。
      切換金鑰時檢查是否回到起始索引，如果是則停止重試。
    example: |
      # 假設有 3 把金鑰，從 key #2 開始
      start: key #2
      try #1: key #2 → 配額滿
      try #2: key #3 → 配額滿
      try #3: key #1 → 配額滿
      try #4: key #2 → 回到起點，停止（避免無限循環）

logging_system:
  log_location: "logs/"
  log_filename: "api_YYYYMMDD.log"
  log_format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  logged_events:
    - "API Manager 初始化（模型名稱、金鑰數量）"
    - "金鑰配置（遮蔽中間部分）"
    - "API 呼叫開始（重試上限、圖片數量）"
    - "API 呼叫成功（耗時、使用的金鑰）"
    - "配額錯誤與金鑰切換"
    - "所有金鑰用完"

  privacy_protection:
    key_masking: "只顯示前 8 位和後 4 位"
    example: "AIzaSyAB...XYZ1"

best_practices:
  security:
    - "永遠不要將 .env 提交到版本控制"
    - "提供 .env.example 作為模板"
    - "使用環境變數管理敏感資訊"
    - "定期輪換 API 金鑰"

  configuration:
    - "將常用模型設為預設值"
    - "根據 API 提供商調整 retry_delay"
    - "使用多把金鑰提高穩定性"
    - "監控日誌檔案大小"

  integration:
    - "先在小範圍測試再全面導入"
    - "保留舊的 API 呼叫邏輯作為備份"
    - "使用 git 追蹤變更"
    - "為團隊成員提供整合文檔"

extensibility:
  add_new_api_provider:
    steps:
      - "在 api_manager.py 建立新的 Manager 類別"
      - "實作相同的介面（generate_content, reset_key_index）"
      - "在 config.yaml 新增 provider 參數"
      - "更新 config.py 新增對應的 getter 函數"

  add_new_config_param:
    steps:
      - "在 config.yaml 新增參數"
      - "在 config.py 新增 get_* 函數"
      - "在使用處呼叫新函數"

  custom_logging:
    steps:
      - "修改 setup_logging() 函數"
      - "調整 log_format 或 log_level"
      - "新增自訂的 logger handler"

troubleshooting:
  common_issues:
    config_not_found:
      symptom: "FileNotFoundError: config.yaml"
      solution: "確認 config.yaml 在專案根目錄"

    env_not_loaded:
      symptom: "未找到任何 API 金鑰"
      solution: "確認 .env 檔案存在且格式正確"

    import_error:
      symptom: "ModuleNotFoundError: utils.config"
      solution: "確認 utils/ 目錄有 __init__.py"

    all_keys_exhausted:
      symptom: "所有 API 金鑰都已嘗試過一輪"
      solution: "等待配額重置或新增更多金鑰"

examples:
  minimal_integration:
    description: "最小化整合範例"
    files: ["config.yaml", "utils/config.py", "utils/api/api_manager.py"]
    code: |
      from utils.api.api_manager import APIManager

      manager = APIManager()
      result = manager.generate_content("Hello, world!")
      print(result)

  advanced_integration:
    description: "進階整合範例（多腳本專案）"
    structure: |
      project/
      ├── config.yaml
      ├── .env
      ├── utils/
      │   ├── config.py
      │   └── api/
      │       └── api_manager.py
      ├── scripts/
      │   ├── script1.py
      │   └── script2.py
      └── main.py

    script_example: |
      # scripts/script1.py
      from utils.config import get_model_name, get_api_call_interval
      from utils.api.api_manager import APIManager
      import time

      MODEL = get_model_name()
      manager = APIManager(MODEL)

      # 第一次 API 呼叫
      result1 = manager.generate_content("Prompt 1")

      # 等待間隔
      time.sleep(get_api_call_interval())

      # 第二次 API 呼叫
      result2 = manager.generate_content("Prompt 2")

migration_from_hardcoded:
  before: |
    # 舊的硬編碼方式
    MODEL_NAME = "gemini-2.5-flash"
    API_KEY = "AIzaSy..."

    import google.generativeai as genai
    genai.configure(api_key=API_KEY)
    model = genai.GenerativeModel(MODEL_NAME)
    response = model.generate_content(prompt)

  after: |
    # 新的框架方式
    from utils.api.api_manager import APIManager

    manager = APIManager()  # 自動從 config.yaml 讀取
    response = manager.generate_content(prompt)

  benefits_comparison:
    before:
      - "❌ 模型名稱硬編碼在程式碼中"
      - "❌ API Key 不安全（可能被提交到 git）"
      - "❌ 單一金鑰，配額用完就停止"
      - "❌ 無自動重試機制"
      - "❌ 無日誌追蹤"

    after:
      - "✅ 模型名稱在 config.yaml，改一處全域生效"
      - "✅ API Key 在 .env，安全不外洩"
      - "✅ 多金鑰自動循環輪替"
      - "✅ 自動檢測配額並重試"
      - "✅ 詳細日誌追蹤所有 API 呼叫"

changelog:
  v1.0.0:
    date: "2026-02-10"
    changes:
      - "初始版本發布"
      - "支援 Google Gemini API"
      - "實作自動循環金鑰輪替"
      - "集中式 config.yaml 設定"
      - "lru_cache 快取機制"
      - "詳細日誌追蹤"

roadmap:
  v1.1.0:
    - "支援 OpenAI API"
    - "支援 Anthropic Claude API"
    - "UI 儀表板（監控金鑰使用狀況）"

  v1.2.0:
    - "動態金鑰權重分配"
    - "成本追蹤與預算控制"
    - "多帳號輪替策略"

notes:
  - "本框架專注於 API 管理，不包含 Prompt 管理功能"
  - "Prompt 管理請參考 prompt_management_system_spec.yaml"
  - "兩個框架可獨立使用，也可搭配使用"
  - "框架設計遵循單一職責原則（SRP）"
